<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Beacon - Your AI Team for Rare Disease Treatment</title>

  <!-- React 18 + ReactDOM via CDN -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- Babel Standalone for JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
    body { font-family: 'Inter', sans-serif; }

    .step-inactive { opacity: 0.3; filter: grayscale(1); pointer-events: none; }
    .agent-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
    @keyframes fadeUp { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
    .fade-up { animation: fadeUp 0.5s ease-out forwards; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .fade-in { animation: fadeIn 0.6s ease-in forwards; }

    .timeline-line::before { content: ''; position: absolute; left: 19px; top: 0; bottom: 0; width: 2px; background: #e2e8f0; }
    [data-expand-target] { max-height: 0; overflow: hidden; transition: max-height 0.4s ease, opacity 0.3s ease; opacity: 0; }
    [data-expand-target].open { max-height: 3000px; opacity: 1; }
    .chevron-icon { transition: transform 0.3s ease; }
    .chevron-icon.rotated { transform: rotate(180deg); }

    /* Modal styles (reused from original) */
    .modal-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.6); display: flex; align-items: center; justify-content: center;
      z-index: 1000; opacity: 0; animation: fadeIn 0.3s ease-out forwards;
    }
    .modal {
      background: white; border-radius: 20px; padding: 2.5rem; max-width: 700px; width: 90%;
      max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      transform: scale(0.9); animation: modalAppear 0.3s ease-out forwards;
    }
    @keyframes modalAppear { to { transform: scale(1); } }
  </style>
</head>
<body class="bg-slate-100 min-h-screen text-slate-900">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useCallback, useRef } = React;

    // ==========================================
    // DATA CONSTANTS
    // ==========================================

    const RARE_DISEASES = [
      { name: "Batten Disease (CLN3)", aliases: ["CLN3", "Juvenile Neuronal Ceroid Lipofuscinosis", "JNCL", "Batten Disease"] },
      { name: "Batten Disease (CLN1)", aliases: ["CLN1", "Infantile Neuronal Ceroid Lipofuscinosis"] },
      { name: "Batten Disease (CLN2)", aliases: ["CLN2", "Late Infantile Neuronal Ceroid Lipofuscinosis", "TPP1 Deficiency"] },
      { name: "Spinal Muscular Atrophy (SMA)", aliases: ["SMA", "Werdnig-Hoffmann Disease"] },
      { name: "Duchenne Muscular Dystrophy", aliases: ["DMD", "Duchenne"] },
      { name: "Cystic Fibrosis", aliases: ["CF", "Mucoviscidosis"] },
      { name: "Huntington's Disease", aliases: ["HD", "Huntington Chorea"] },
      { name: "Rett Syndrome", aliases: ["MECP2", "Rett"] },
      { name: "Dravet Syndrome", aliases: ["SCN1A", "Severe Myoclonic Epilepsy of Infancy"] },
      { name: "Fragile X Syndrome", aliases: ["FXS", "Martin-Bell Syndrome"] },
      { name: "Tay-Sachs Disease", aliases: ["Hexosaminidase A Deficiency"] },
      { name: "Gaucher Disease", aliases: ["Glucocerebrosidase Deficiency"] },
      { name: "Pompe Disease", aliases: ["Glycogen Storage Disease Type II"] },
      { name: "Fabry Disease", aliases: ["Alpha-Galactosidase A Deficiency"] },
      { name: "Phenylketonuria (PKU)", aliases: ["PKU"] },
      { name: "Niemann-Pick Disease", aliases: ["NPD"] },
      { name: "Angelman Syndrome", aliases: ["AS"] },
      { name: "Prader-Willi Syndrome", aliases: ["PWS"] },
      { name: "Sanfilippo Syndrome", aliases: ["MPS III"] },
      { name: "Krabbe Disease", aliases: ["Globoid Cell Leukodystrophy"] },
      { name: "CDKL5 Deficiency Disorder", aliases: ["CDKL5", "CDD"] },
      { name: "Giant Axonal Neuropathy", aliases: ["GAN"] },
      { name: "AADC Deficiency", aliases: ["Aromatic L-Amino Acid Decarboxylase Deficiency"] },
      { name: "Epidermolysis Bullosa", aliases: ["EB", "Butterfly Disease"] },
      { name: "Sickle Cell Disease", aliases: ["SCD"] },
    ];

    const JOURNEY_STAGES = [
      { id: 'pre-diagnosis', emoji: '\u{1F50D}', title: "Still searching for answers", desc: "Symptoms but no clear diagnosis yet" },
      { id: 'just-diagnosed', emoji: '\u{1F4CB}', title: "Just received a diagnosis", desc: "Need to make sense of it and build a plan" },
      { id: 'established', emoji: '\u{1F6E4}\u{FE0F}', title: "We've known for a while", desc: "Go deeper on treatment pathways and trials" },
    ];

    const DEMO_SCRIPT = [
      { t: 0, agents: [
        { name: 'Scout', status: 'Initializing literature search...', done: false },
        { name: 'Connector', status: 'Initializing investigator database...', done: false },
        { name: 'Navigator', status: 'Initializing regulatory scan...', done: false },
        { name: 'Mobilizer', status: 'Initializing funding search...', done: false },
        { name: 'Strategist', status: 'Initializing coordination...', done: false },
      ]},
      { t: 2000, agents: [
        { name: 'Scout', status: 'Searching bioRxiv for CLN3 preprints...', done: false },
        { name: 'Connector', status: 'Querying NPI Registry for CLN3 specialists...', done: false },
        { name: 'Navigator', status: 'Checking FDA orphan drug database...', done: false },
        { name: 'Mobilizer', status: 'Scanning NIH and CZI grant opportunities...', done: false },
        { name: 'Strategist', status: 'Building preliminary framework...', done: false },
      ]},
      { t: 5000, agents: [
        { name: 'Scout', status: 'Found 12 preprints on CLN3 gene therapy', done: false },
        { name: 'Connector', status: 'Identified 8 principal investigators', done: false },
        { name: 'Navigator', status: 'CLN3 qualifies for Orphan Drug Designation', done: true },
        { name: 'Mobilizer', status: 'Found $4.2M in active NIH grants', done: true },
        { name: 'Strategist', status: 'Synthesizing agent findings...', done: false },
      ]},
      { t: 9000, agents: [
        { name: 'Scout', status: 'AAV9-CLN3 gene therapy trial identified', done: true },
        { name: 'Connector', status: 'Drafting outreach to Dr. Cooper...', done: false },
        { name: 'Navigator', status: 'Pathway mapped — 3 expedited routes', done: true },
        { name: 'Mobilizer', status: 'CZI deadline March 15 flagged', done: true },
        { name: 'Strategist', status: 'Building final roadmap...', done: false },
      ]},
      { t: 13000, agents: [
        { name: 'Scout', status: 'Drug repurposing screen: Tamoxifen identified', done: true },
        { name: 'Connector', status: '5 outreach emails drafted', done: true },
        { name: 'Navigator', status: 'Pathway mapped — 3 expedited routes', done: true },
        { name: 'Mobilizer', status: 'Grant strategy ready', done: true },
        { name: 'Strategist', status: 'Roadmap complete', done: true },
      ]},
    ];

    const AGENT_COLORS = {
      Scout: 'violet', Connector: 'pink', Navigator: 'blue', Mobilizer: 'emerald', Strategist: 'amber'
    };
    const AGENT_EMOJIS = {
      Scout: '\u{1F52C}', Connector: '\u{1F91D}', Navigator: '\u{1F9ED}', Mobilizer: '\u{1F4B0}', Strategist: '\u{1F3AF}'
    };

    const REPURPOSING_DEMO_DATA = {
      steps: [
        { name: 'Supporting Repurposing', desc: 'Disease characterized', done: true },
        { name: 'Identifying the Drug', desc: '47 screened, 2 candidates', done: true },
        { name: 'Validating the Drug', desc: 'Drafting protocol...', active: true },
        { name: 'Clinical Access', desc: '', done: false },
        { name: 'Reaching an Endpoint', desc: '', done: false },
      ],
      candidates: [
        { name: 'Tamoxifen', stage: 'Lead', mechanism: 'TRPML1 agonist', fdaApproved: true, pediatricData: true },
        { name: '4-Phenylbutyrate (4-PBA)', stage: 'Early', mechanism: 'Chemical chaperone', fdaApproved: true, pediatricData: false },
      ],
      council: [
        { agent: 'Scout', text: 'ChEMBL screen returned 47 compounds. Tamoxifen shows TRPML1 agonist activity at clinically achievable doses. Found 2 off-label case reports in adult NCL patients.' },
        { agent: 'Navigator', text: 'FDA-approved since 1977. Pediatric dosing from precocious puberty studies. Off-label use needs physician agreement only \u2014 no IND required.' },
        { agent: 'Strategist', text: 'Dual track: tamoxifen near-term (months) + AAV9 gene therapy long-term. These are complementary, not competing.' },
        { agent: 'Scout', text: '4-PBA is a secondary candidate \u2014 chemical chaperone that may stabilize misfolded CLN3 protein. Less evidence but worth monitoring.' },
        { agent: 'Connector', text: 'Dr. Bhatt at UCL has published on lysosomal channel modulators in NCL models. Recommending outreach.' },
        { agent: 'Navigator', text: 'For tamoxifen: off-label prescribing is the fastest path. Compassionate use (FDA Form 3926) as backup if physician is hesitant.' },
        { agent: 'Mobilizer', text: 'EveryCure offers free consultation for rare disease drug repurposing using their ROADMAP framework. Recommending outreach.' },
        { agent: 'Strategist', text: 'Action items: (1) Specialist briefing on tamoxifen for your neurologist, (2) EveryCure outreach, (3) Continue gene therapy trial pre-screening.' },
      ],
    };

    const TIMELINE_MILESTONES = [
      { icon: 'file-check', color: 'emerald', title: 'Initial Analysis Complete', desc: '127 papers, 8 trials, 34 compounds analyzed', major: false, stats: [{ label: 'Target', value: 'CLN3 / Battenin' }, { label: 'Trials', value: '3 recruiting' }] },
      { icon: 'microscope', color: 'indigo', title: 'Drug Repurposing Candidate Found', desc: 'Tamoxifen identified via ChEMBL screen', major: true },
      { icon: 'flask-conical', color: 'blue', title: 'Clinical Trial Match: 89%', desc: 'Phase I/II AAV9-CLN3 at Weill Cornell \u2014 8/9 criteria met', major: false },
      { icon: 'mail', color: 'pink', title: 'Outreach Email Drafted', desc: 'Email to Dr. Cooper about AAV9-CLN3 trial', major: false, pending: true },
    ];

    const JOURNEY_ACHIEVEMENTS = [
      { text: 'Found active gene therapy trial at Weill Cornell' },
      { text: 'Identified tamoxifen as repurposing candidate' },
      { text: 'FDA orphan drug pathway confirmed viable' },
    ];

    function isDemo() {
      return new URLSearchParams(window.location.search).has('demo');
    }

    // Helper to fetch and unwrap JSON
    const fetchReport = async (url) => {
      try {
        const res = await fetch(url);
        if (!res.ok) return null;
        const text = await res.text();
        let data;
        try { data = JSON.parse(text); } catch {
          const match = text.match(/```(?:json)?\s*([\s\S]*?)```/);
          if (match) data = JSON.parse(match[1]); else return null;
        }
        if (data && data.type === 'result' && typeof data.result === 'string') {
          try { return JSON.parse(data.result); } catch { return null; }
        }
        return data;
      } catch { return null; }
    };

    // ==========================================
    // MAIN APP
    // ==========================================

    function App() {
      const [view, setView] = useState('onboarding'); // 'onboarding' | 'dashboard'
      const [onboardingStep, setOnboardingStep] = useState(1);
      const [mission, setMission] = useState({
        disease: '', journeyStage: 'just-diagnosed', patient: 'child', location: 'us',
      });
      const [modalOpen, setModalOpen] = useState(false);
      const [selectedApproval, setSelectedApproval] = useState(null);

      const demo = isDemo();

      useEffect(() => {
        if (demo && !mission.disease) {
          setMission({ disease: 'Batten Disease (CLN3)', journeyStage: 'just-diagnosed', patient: 'child', location: 'us' });
        }
      }, [demo]);

      return (
        <>
          {view === 'onboarding' ? (
            <OnboardingView
              step={onboardingStep}
              setStep={setOnboardingStep}
              mission={mission}
              setMission={setMission}
              onEnterDashboard={() => setView('dashboard')}
              demo={demo}
            />
          ) : (
            <DashboardView
              mission={mission}
              demo={demo}
              setModalOpen={setModalOpen}
              setSelectedApproval={setSelectedApproval}
            />
          )}
          {modalOpen && selectedApproval && (
            <ApprovalModal approval={selectedApproval} onClose={() => setModalOpen(false)} />
          )}
        </>
      );
    }

    // ==========================================
    // ONBOARDING VIEW (3 steps, single page)
    // ==========================================

    function OnboardingView({ step, setStep, mission, setMission, onEnterDashboard, demo }) {
      const [searchQuery, setSearchQuery] = useState(demo ? 'Batten Disease (CLN3)' : '');
      const [showDropdown, setShowDropdown] = useState(false);
      const [filteredDiseases, setFilteredDiseases] = useState([]);
      const [agentStates, setAgentStates] = useState(DEMO_SCRIPT[0].agents);
      const [showInsight, setShowInsight] = useState(false);

      // Agent awakening simulation (step 3)
      useEffect(() => {
        if (step !== 3) return;
        const timers = DEMO_SCRIPT.map(frame =>
          setTimeout(() => {
            setAgentStates(frame.agents);
          }, frame.t)
        );
        // Show insight after all agents done
        const insightTimer = setTimeout(() => setShowInsight(true), 14000);
        return () => { timers.forEach(clearTimeout); clearTimeout(insightTimer); };
      }, [step]);

      const handleSearchChange = (e) => {
        const query = e.target.value;
        setSearchQuery(query);
        setMission({ ...mission, disease: query });
        if (query.trim().length > 0) {
          const q = query.toLowerCase();
          const matches = RARE_DISEASES.filter(d =>
            d.name.toLowerCase().includes(q) || d.aliases.some(a => a.toLowerCase().includes(q))
          ).slice(0, 8);
          setFilteredDiseases(matches);
          setShowDropdown(true);
        } else {
          setFilteredDiseases([]);
          setShowDropdown(false);
        }
      };

      const selectDisease = (d) => {
        setSearchQuery(d.name);
        setMission({ ...mission, disease: d.name });
        setShowDropdown(false);
      };

      const goStep = (n) => setStep(n);

      const stepNav = [
        { num: 1, label: 'Welcome', sub: 'Privacy Covenant' },
        { num: 2, label: 'Connect', sub: 'Your Situation' },
        { num: 3, label: 'Awakening', sub: 'Agent Synthesis' },
      ];

      return (
        <div className="min-h-screen flex items-center justify-center p-6">
          <div className="max-w-4xl w-full grid grid-cols-12 gap-8">

            {/* Left: Step sidebar */}
            <div className="col-span-4 pt-10 space-y-6">
              <div className="flex items-center gap-3 mb-10">
                <div className="w-10 h-10 bg-gradient-to-br from-amber-500 to-amber-600 rounded-xl flex items-center justify-center text-white font-black text-lg shadow-lg shadow-amber-200">B</div>
                <span className="text-xl font-extrabold bg-gradient-to-r from-amber-600 to-amber-500 bg-clip-text text-transparent">Beacon</span>
              </div>

              {stepNav.map(s => (
                <div key={s.num} className={`flex items-center gap-4 ${step < s.num ? 'step-inactive' : ''}`}>
                  <div className={`w-10 h-10 rounded-full flex items-center justify-center font-bold text-white ${step >= s.num ? 'bg-indigo-600 shadow-md shadow-indigo-200' : 'bg-slate-300'}`}>{s.num}</div>
                  <div>
                    <p className={`text-[10px] font-bold uppercase tracking-wider ${step >= s.num ? 'text-indigo-600' : 'text-slate-400'}`}>{s.label}</p>
                    <p className="text-sm font-semibold text-slate-800">{s.sub}</p>
                  </div>
                </div>
              ))}
            </div>

            {/* Right: Content cards */}
            <div className="col-span-8">

              {/* Step 1: Privacy */}
              {step === 1 && (
                <div className="bg-white rounded-3xl p-10 shadow-xl border border-slate-200 fade-up">
                  <div className="w-16 h-16 bg-indigo-50 rounded-2xl flex items-center justify-center text-indigo-600 mb-6">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/><path d="m9 12 2 2 4-4"/></svg>
                  </div>
                  <h2 className="text-3xl font-bold mb-4">First, your safety.</h2>
                  <p className="text-slate-500 mb-8 leading-relaxed text-lg">Rare disease data is the most sensitive information you own. Beacon's agents operate in a <strong className="text-slate-700">Secure Sandbox</strong>. Your data is encrypted and only your team sees it.</p>

                  <div className="bg-slate-50 rounded-2xl p-6 border border-slate-100 mb-8 space-y-4">
                    {['Your data is never used to train models.', 'All actions requiring external contact need your approval.', 'Revoke agent access or delete everything at any time.'].map((t, i) => (
                      <div key={i} className="flex items-center gap-3 text-sm font-medium text-slate-700">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#10b981" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
                        {t}
                      </div>
                    ))}
                  </div>

                  <button onClick={() => goStep(2)} className="w-full bg-indigo-600 text-white py-4 rounded-2xl font-bold text-lg hover:bg-indigo-700 transition-all shadow-lg shadow-indigo-200">
                    I Agree. Let's Begin.
                  </button>
                </div>
              )}

              {/* Step 2: Situation */}
              {step === 2 && (
                <div className="bg-white rounded-3xl p-10 shadow-xl border border-slate-200 fade-up">
                  <h2 className="text-3xl font-bold mb-2">Tell us about your journey.</h2>
                  <p className="text-slate-500 mb-8">This helps your AI team personalize their research.</p>

                  {/* Journey stage */}
                  <div className="space-y-3 mb-8">
                    {JOURNEY_STAGES.map(js => (
                      <button
                        key={js.id}
                        onClick={() => setMission({ ...mission, journeyStage: js.id })}
                        className={`w-full flex items-center gap-4 p-4 rounded-2xl border-2 transition-all text-left ${mission.journeyStage === js.id ? 'border-indigo-600 bg-indigo-50' : 'border-slate-200 hover:border-indigo-300'}`}
                      >
                        <span className="text-2xl">{js.emoji}</span>
                        <div>
                          <div className="font-bold text-slate-800">{js.title}</div>
                          <div className="text-xs text-slate-500">{js.desc}</div>
                        </div>
                      </button>
                    ))}
                  </div>

                  {/* Disease input */}
                  {mission.journeyStage !== 'pre-diagnosis' && (
                    <div className="mb-8">
                      <label className="text-sm font-bold text-slate-700 block mb-2">Condition</label>
                      <div className="relative">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#94a3b8" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="absolute left-4 top-1/2 -translate-y-1/2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                        <input
                          type="text"
                          placeholder="Search for a rare disease..."
                          value={searchQuery}
                          onChange={handleSearchChange}
                          onFocus={() => { if (filteredDiseases.length > 0) setShowDropdown(true); }}
                          onBlur={() => setTimeout(() => setShowDropdown(false), 200)}
                          className="w-full pl-12 pr-4 py-3.5 border-2 border-slate-200 rounded-xl text-base focus:outline-none focus:border-indigo-500 bg-slate-50"
                          autoFocus
                        />
                        {showDropdown && filteredDiseases.length > 0 && (
                          <div className="absolute top-full left-0 right-0 bg-white border-2 border-slate-200 border-t-0 rounded-b-xl shadow-lg z-50 max-h-72 overflow-y-auto">
                            {filteredDiseases.map((d, i) => (
                              <div key={i} className="px-4 py-3 cursor-pointer hover:bg-amber-50 border-b border-slate-100 last:border-0" onMouseDown={() => selectDisease(d)}>
                                <div className="font-semibold text-slate-800">{d.name}</div>
                                <div className="text-xs text-slate-400">{d.aliases.join(' \u00B7 ')}</div>
                              </div>
                            ))}
                          </div>
                        )}
                      </div>
                    </div>
                  )}

                  {/* Upload zone for pre-dx */}
                  {mission.journeyStage === 'pre-diagnosis' && (
                    <div className="mb-8">
                      <label className="text-sm font-bold text-slate-700 block mb-2">Medical Records</label>
                      <div className="border-2 border-dashed border-slate-300 rounded-2xl p-8 flex flex-col items-center bg-slate-50 hover:border-indigo-300 hover:bg-indigo-50/30 transition-all cursor-pointer">
                        <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#94a3b8" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M12 12v9"/><path d="m16 16-4-4-4 4"/></svg>
                        <p className="font-bold text-slate-600 text-sm mt-3">Drop files here</p>
                        <p className="text-[11px] text-slate-400 mt-1">PDF, JPG, PNG, or Medical XML</p>
                      </div>
                      <textarea placeholder="Or describe symptoms and timeline in your own words..." className="mt-3 w-full p-3 border-2 border-slate-200 rounded-xl text-sm resize-none h-20 focus:outline-none focus:border-indigo-500"></textarea>
                    </div>
                  )}

                  {/* Quick intake */}
                  <div className="grid grid-cols-2 gap-4 mb-8">
                    <div>
                      <label className="text-sm font-bold text-slate-700 block mb-2">Patient is</label>
                      <div className="flex gap-2">
                        {['My child', 'Myself'].map(label => {
                          const id = label === 'My child' ? 'child' : 'myself';
                          return (
                            <button key={id} onClick={() => setMission({ ...mission, patient: id })}
                              className={`flex-1 py-2 rounded-lg border-2 text-sm font-semibold ${mission.patient === id ? 'border-indigo-600 bg-indigo-50 text-indigo-700' : 'border-slate-200 text-slate-600 hover:border-slate-300'}`}>
                              {label}
                            </button>
                          );
                        })}
                      </div>
                    </div>
                    <div>
                      <label className="text-sm font-bold text-slate-700 block mb-2">Location</label>
                      <div className="flex gap-2">
                        {['US', 'EU', 'Other'].map(label => {
                          const id = label.toLowerCase();
                          return (
                            <button key={id} onClick={() => setMission({ ...mission, location: id })}
                              className={`flex-1 py-2 rounded-lg border-2 text-sm font-semibold ${mission.location === id ? 'border-indigo-600 bg-indigo-50 text-indigo-700' : 'border-slate-200 text-slate-600 hover:border-slate-300'}`}>
                              {label}
                            </button>
                          );
                        })}
                      </div>
                    </div>
                  </div>

                  <button
                    onClick={() => goStep(3)}
                    disabled={mission.journeyStage !== 'pre-diagnosis' && !mission.disease}
                    className="w-full bg-indigo-600 text-white py-4 rounded-2xl font-bold text-lg hover:bg-indigo-700 transition-all shadow-lg shadow-indigo-200 disabled:opacity-40 disabled:cursor-not-allowed"
                  >
                    Start Analysis &rarr;
                  </button>
                </div>
              )}

              {/* Step 3: Agent Awakening */}
              {step === 3 && (
                <div className="bg-slate-900 rounded-3xl p-10 shadow-xl border border-zinc-700 text-white fade-up">
                  <div className="flex justify-between items-center mb-8">
                    <h2 className="text-2xl font-bold">Your Team is Awakening...</h2>
                    <div className="flex gap-2">
                      {['violet', 'pink', 'blue', 'emerald', 'amber'].map((c, i) => (
                        <span key={c} className={`w-2.5 h-2.5 rounded-full bg-${c}-500 agent-pulse`} style={{ animationDelay: `${i * 0.3}s` }}></span>
                      ))}
                    </div>
                  </div>

                  <div className="space-y-3 mb-8">
                    {agentStates.map((a, i) => {
                      const color = Object.values(AGENT_COLORS)[i];
                      return (
                        <div key={a.name} className="p-4 bg-white/5 border border-white/10 rounded-2xl flex items-center gap-4">
                          <div className={`w-8 h-8 rounded-lg bg-${color}-500/20 text-${color}-400 flex items-center justify-center text-sm`}>
                            {Object.values(AGENT_EMOJIS)[i]}
                          </div>
                          <div className="flex-1">
                            <p className={`text-xs font-bold text-${color}-300`}>{a.name}</p>
                            <p className="text-[11px] text-zinc-400">{a.status}</p>
                          </div>
                          {a.done ? (
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#10b981" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
                          ) : (
                            <div className={`w-2 h-2 rounded-full bg-${color}-500 agent-pulse`}></div>
                          )}
                        </div>
                      );
                    })}
                  </div>

                  {/* First insight */}
                  {showInsight && (
                    <div className="text-center p-6 bg-indigo-600 rounded-2xl shadow-xl shadow-indigo-900/40 fade-up">
                      <p className="text-[10px] font-black text-indigo-200 uppercase tracking-widest mb-2">First Insight</p>
                      <h3 className="font-bold text-lg mb-2">AAV9 Gene Therapy Trial Enrolling</h3>
                      <p className="text-sm text-indigo-100 opacity-80 mb-6">"Weill Cornell is actively enrolling CLN3 patients for a Phase I/II intrathecal AAV9 gene therapy trial. Your child may be eligible."</p>
                      <button onClick={onEnterDashboard} className="w-full bg-white text-indigo-600 py-3 rounded-xl font-black uppercase text-xs tracking-widest hover:bg-indigo-50 transition-colors">
                        Enter Dashboard &rarr;
                      </button>
                    </div>
                  )}

                  {/* Fallback enter button before insight shows */}
                  {!showInsight && agentStates.every(a => a.done) && (
                    <button onClick={onEnterDashboard} className="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold hover:bg-indigo-700 transition-colors">
                      Enter Dashboard &rarr;
                    </button>
                  )}
                </div>
              )}
            </div>
          </div>
        </div>
      );
    }

    // ==========================================
    // DASHBOARD VIEW
    // ==========================================

    function DashboardView({ mission, demo, setModalOpen, setSelectedApproval }) {
      const [expandedSections, setExpandedSections] = useState({});
      const [state, setState] = useState(null);

      // Data polling (non-demo)
      useEffect(() => {
        if (demo) return;
        const poll = async () => {
          try {
            const res = await fetch('data/state.json');
            if (res.ok) setState(await res.json());
          } catch {}
        };
        poll();
        const interval = setInterval(poll, 3000);
        return () => clearInterval(interval);
      }, [demo]);

      const toggleExpand = (name) => {
        setExpandedSections(prev => ({ ...prev, [name]: !prev[name] }));
      };

      const handleApproval = (approval) => {
        setSelectedApproval(approval);
        setModalOpen(true);
      };

      const demoApproval = {
        type: 'Outreach Email',
        title: 'Email to Dr. Jonathan Cooper \u2014 Weill Cornell',
        summary: "Personalized introduction about your family's CLN3 journey.",
        to: 'jonathan.cooper@weillcornell.edu',
        subject: "Parent of CLN3 patient \u2014 interested in your gene therapy research",
        body: "Dear Dr. Cooper,\n\nI am writing as a parent of a child recently diagnosed with CLN3 Batten Disease. I've been following your groundbreaking work on AAV9-mediated gene therapy with great interest.\n\nYour 2024 paper on intrathecal delivery showing restored CLN3 protein expression in the murine model was particularly encouraging. I would be grateful for the opportunity to discuss your research.\n\nWith hope,\n[Your name]",
        note: "Dr. Cooper leads the only active AAV9-CLN3 gene therapy program. High priority contact.",
      };

      return (
        <div className="min-h-screen flex">
          {/* Sidebar */}
          <aside className="w-20 bg-indigo-900 flex flex-col items-center py-8 gap-8 h-screen sticky top-0">
            <div className="w-10 h-10 bg-gradient-to-br from-amber-400 to-amber-500 rounded-xl flex items-center justify-center text-white font-black text-lg shadow-lg">B</div>
            <nav className="flex flex-col gap-4">
              {[
                { icon: 'M4 4h16v16H4z M4 4l8 8 8-8', label: 'Dashboard', active: true },
              ].map((item, i) => (
                <button key={i} className={`p-3 rounded-xl ${item.active ? 'bg-indigo-800 text-white shadow-lg' : 'text-indigo-300 hover:text-white'} transition-colors`} title={item.label}>
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="7" height="7" x="3" y="3" rx="1"/><rect width="7" height="7" x="14" y="3" rx="1"/><rect width="7" height="7" x="14" y="14" rx="1"/><rect width="7" height="7" x="3" y="14" rx="1"/></svg>
                </button>
              ))}
            </nav>
          </aside>

          {/* Main */}
          <main className="flex-1 flex flex-col">
            {/* Header */}
            <header className="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-8 shrink-0">
              <div className="flex items-center gap-4">
                <span className="text-[11px] font-bold text-slate-400 uppercase tracking-wider">Patient:</span>
                <span className="text-sm font-bold px-3 py-1 bg-slate-100 rounded-full">{mission.disease || 'CLN3 Batten Disease'}</span>
              </div>
              <div className="flex items-center gap-6">
                <div className="flex -space-x-2">
                  {Object.entries(AGENT_COLORS).map(([name, color]) => (
                    <div key={name} className={`w-7 h-7 rounded-full bg-${color}-500 border-2 border-white flex items-center justify-center text-[8px] text-white font-bold`} title={name}>
                      {name[0]}
                    </div>
                  ))}
                </div>
              </div>
            </header>

            {/* Scrollable content */}
            <div className="flex-1 overflow-y-auto">
              <div className="max-w-5xl mx-auto px-8 py-8 space-y-8">

                {/* ==========================================
                    SECTION 1: YOUR JOURNEY
                    ========================================== */}
                <div className="bg-white rounded-3xl p-8 border border-slate-200 shadow-sm">
                  <div className="flex items-center justify-between mb-6">
                    <h2 className="text-lg font-bold flex items-center gap-2">
                      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#4f46e5" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="3 6 9 3 15 6 21 3 21 18 15 21 9 18 3 21"/><line x1="9" x2="9" y1="3" y2="18"/><line x1="15" x2="15" y1="6" y2="21"/></svg>
                      Your Journey
                    </h2>
                    <span className="text-[11px] text-slate-400 font-medium">Day 3 of your mission</span>
                  </div>

                  {/* Progress bars */}
                  <div className="flex gap-3 mb-6">
                    {[
                      { label: 'Research', status: 'complete', sub: 'Complete' },
                      { label: 'Outreach', pct: 60, sub: '3 contacts identified' },
                      { label: 'Regulatory', pct: 40, sub: 'Pathways mapped' },
                      { label: 'Funding', pct: 0, sub: 'Starting soon' },
                      { label: 'Treatment', pct: 0, sub: 'Long-term goal' },
                    ].map((p, i) => (
                      <div key={i} className="flex-1">
                        <div className={`h-2 rounded-full mb-3 ${p.status === 'complete' ? 'bg-emerald-500' : p.pct > 0 ? 'bg-amber-400 overflow-hidden' : 'bg-slate-200'}`}>
                          {p.pct > 0 && <div className="h-full bg-amber-500 rounded-full" style={{ width: `${p.pct}%` }}></div>}
                        </div>
                        <p className={`text-[10px] font-bold uppercase tracking-wider ${p.status === 'complete' ? 'text-emerald-600' : p.pct > 0 ? 'text-amber-600' : 'text-slate-400'}`}>{p.label}</p>
                        <p className={`text-xs font-semibold mt-0.5 ${p.status === 'complete' || p.pct > 0 ? 'text-slate-600' : 'text-slate-500'}`}>{p.sub}</p>
                      </div>
                    ))}
                  </div>

                  {/* Achievement cards with green checkmarks */}
                  <div className="flex gap-3">
                    {JOURNEY_ACHIEVEMENTS.map((a, i) => (
                      <div key={i} className="flex-1 bg-emerald-50 rounded-xl p-3 border border-emerald-100">
                        <div className="flex items-center gap-2 mb-1">
                          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#059669" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
                          <span className="text-[10px] font-bold text-emerald-700 uppercase">Done</span>
                        </div>
                        <p className="text-xs text-emerald-800 font-semibold">{a.text}</p>
                      </div>
                    ))}
                  </div>
                </div>

                {/* ==========================================
                    SECTION 2: KEY INSIGHTS & DECISIONS
                    ========================================== */}
                <div className="space-y-4">
                  <h2 className="text-lg font-bold flex items-center gap-2 px-1">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-.9 1.5-2.2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/></svg>
                    Key Insights & Decisions
                  </h2>

                  {/* Drug Repurposing Breakthrough */}
                  <div className="bg-indigo-50 rounded-2xl p-6 border-2 border-indigo-200 shadow-sm">
                    <div className="flex justify-between items-start mb-3">
                      <div className="flex items-center gap-3">
                        <div className="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center">
                          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M6 18h8"/><path d="M3 22h18"/><path d="M14 22a7 7 0 1 0 0-14h-1"/><path d="M9 14h2"/><path d="M9 12a2 2 0 0 1-2-2V6h6v4a2 2 0 0 1-2 2Z"/><path d="M12 6V3a1 1 0 0 0-1-1H9a1 1 0 0 0-1 1v3"/></svg>
                        </div>
                        <div>
                          <h3 className="font-bold text-indigo-900">Drug Repurposing Candidate: Tamoxifen</h3>
                          <p className="text-[11px] text-indigo-500">Scout + Navigator + Strategist &middot; 12 min ago</p>
                        </div>
                      </div>
                      <span className="bg-indigo-600 text-white text-[9px] font-black px-2.5 py-0.5 rounded-md uppercase tracking-wide shrink-0">Breakthrough</span>
                    </div>
                    <p className="text-sm text-slate-700 leading-relaxed mb-4">Tamoxifen activates the TRPML1 lysosomal channel that CLN3 patients are missing. It's FDA-approved with existing pediatric safety data. Your team recommends a dual-track strategy: pursue tamoxifen as a near-term option while the gene therapy trial continues.</p>
                    <div className="flex gap-3">
                      <button className="bg-indigo-600 text-white px-4 py-2 rounded-xl text-xs font-bold shadow-md hover:bg-indigo-700 transition-colors">Generate Specialist Briefing</button>
                      <button onClick={() => toggleExpand('repurpose')} className="text-indigo-600 px-4 py-2 rounded-xl text-xs font-bold border border-indigo-200 hover:bg-white transition-colors flex items-center gap-1">
                        See Agent Reasoning
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={`chevron-icon ${expandedSections.repurpose ? 'rotated' : ''}`}><path d="m6 9 6 6 6-6"/></svg>
                      </button>
                    </div>
                    {/* Expandable council discourse */}
                    <div data-expand-target="repurpose" className={expandedSections.repurpose ? 'open mt-4' : 'mt-4'}>
                      <div className="space-y-3 border-l-2 border-indigo-200 pl-4 py-2 bg-white/60 rounded-xl p-4">
                        {REPURPOSING_DEMO_DATA.council.map((msg, i) => (
                          <div key={i} className="flex gap-3">
                            <div className={`text-[10px] font-bold text-${AGENT_COLORS[msg.agent]}-600 uppercase w-20 shrink-0 pt-0.5`}>{msg.agent}</div>
                            <p className="text-sm text-slate-700">"{msg.text}"</p>
                          </div>
                        ))}
                      </div>
                    </div>
                  </div>

                  {/* Clinical Trial Match */}
                  <div className="bg-slate-900 rounded-2xl p-6 text-white shadow-md">
                    <div className="flex justify-between items-start mb-3">
                      <div className="flex items-center gap-3">
                        <div className="w-8 h-8 bg-indigo-500/30 rounded-lg flex items-center justify-center">
                          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#818cf8" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10 2v7.527a2 2 0 0 1-.211.896L4.72 20.55a1 1 0 0 0 .9 1.45h12.76a1 1 0 0 0 .9-1.45l-5.069-10.127A2 2 0 0 1 14 9.527V2"/><path d="M8.5 2h7"/><path d="M7 16h10"/></svg>
                        </div>
                        <div>
                          <p className="text-[10px] font-black text-indigo-400 uppercase tracking-widest">Clinical Trial Match</p>
                          <h3 className="font-bold">Phase I/II AAV9-CLN3 Gene Therapy &mdash; Weill Cornell</h3>
                        </div>
                      </div>
                    </div>
                    <p className="text-xs text-slate-300 leading-relaxed mb-4">Intrathecal AAV9 delivery targeting CLN3 protein restoration. Your child meets <strong className="text-white">8 of 9</strong> eligibility criteria. First-in-human data expected Q3 2026.</p>
                    <div className="flex items-center gap-3 mb-4">
                      <div className="flex-1 bg-white/10 h-2 rounded-full"><div className="bg-indigo-500 h-full w-[89%] rounded-full"></div></div>
                      <span className="text-xs font-bold text-indigo-400">89% match</span>
                    </div>
                    <div className="flex gap-3">
                      <button className="bg-white text-slate-900 px-4 py-2 rounded-xl text-[10px] font-black uppercase tracking-wide">Pre-Screen Now</button>
                      <button className="text-indigo-300 px-4 py-2 rounded-xl text-[10px] font-bold uppercase tracking-wide hover:text-white transition-colors">View Full Details</button>
                    </div>
                  </div>

                  {/* Decision: Outreach Email */}
                  <div className="bg-white rounded-2xl p-6 border border-slate-200 shadow-sm">
                    <div className="flex justify-between items-start mb-3">
                      <div className="flex items-center gap-3">
                        <div className="w-8 h-8 bg-amber-100 rounded-lg flex items-center justify-center">
                          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#d97706" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></svg>
                        </div>
                        <div>
                          <h3 className="font-bold text-slate-800">Email to Dr. Jonathan Cooper</h3>
                          <p className="text-[11px] text-slate-400">Connector &middot; Needs your approval</p>
                        </div>
                      </div>
                      <span className="bg-amber-100 text-amber-800 text-[9px] font-black px-2.5 py-0.5 rounded-md uppercase">Decision</span>
                    </div>
                    <p className="text-sm text-slate-600 leading-relaxed mb-4">Personalized introduction about your family's CLN3 journey and interest in his AAV9 gene therapy research. Includes Scout's evidence summary.</p>
                    <div className="flex gap-3">
                      <button onClick={() => handleApproval(demoApproval)} className="bg-indigo-600 text-white px-4 py-2 rounded-xl text-xs font-bold shadow-md hover:bg-indigo-700 transition-colors">Review & Approve</button>
                      <button className="text-slate-500 px-4 py-2 rounded-xl text-xs font-bold border border-slate-200 hover:bg-slate-50 transition-colors">Skip for Now</button>
                    </div>
                  </div>

                  {/* Decision: EveryCure */}
                  <div className="bg-white rounded-2xl p-6 border border-slate-200 shadow-sm">
                    <div className="flex justify-between items-start mb-3">
                      <div className="flex items-center gap-3">
                        <div className="w-8 h-8 bg-amber-100 rounded-lg flex items-center justify-center">
                          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#d97706" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m10.5 20.5 10-10a4.95 4.95 0 1 0-7-7l-10 10a4.95 4.95 0 1 0 7 7Z"/><path d="m8.5 8.5 7 7"/></svg>
                        </div>
                        <div>
                          <h3 className="font-bold text-slate-800">Contact EveryCure for Repurposing Guidance</h3>
                          <p className="text-[11px] text-slate-400">Mobilizer &middot; Needs your approval</p>
                        </div>
                      </div>
                      <span className="bg-amber-100 text-amber-800 text-[9px] font-black px-2.5 py-0.5 rounded-md uppercase">Decision</span>
                    </div>
                    <p className="text-sm text-slate-600 leading-relaxed mb-4">EveryCure offers free consultation for rare disease drug repurposing using their ROADMAP framework. They can help validate the tamoxifen pathway.</p>
                    <div className="flex gap-3">
                      <button className="bg-indigo-600 text-white px-4 py-2 rounded-xl text-xs font-bold shadow-md hover:bg-indigo-700 transition-colors">Approve Outreach</button>
                      <button className="text-slate-500 px-4 py-2 rounded-xl text-xs font-bold border border-slate-200 hover:bg-slate-50 transition-colors">Skip for Now</button>
                    </div>
                  </div>
                </div>

                {/* ==========================================
                    SECTION 3: DETAILED VIEW (Expandable)
                    ========================================== */}
                <div className="border border-slate-200 rounded-3xl bg-white shadow-sm overflow-hidden">
                  <button onClick={() => toggleExpand('detail')} className="w-full flex items-center justify-between px-8 py-5 hover:bg-slate-50 transition-colors">
                    <h2 className="text-lg font-bold flex items-center gap-2">
                      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#64748b" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12.83 2.18a2 2 0 0 0-1.66 0L2.6 6.08a1 1 0 0 0 0 1.83l8.58 3.91a2 2 0 0 0 1.66 0l8.58-3.9a1 1 0 0 0 0-1.83Z"/><path d="m22 17.65-9.17 4.16a2 2 0 0 1-1.66 0L2 17.65"/><path d="m22 12.65-9.17 4.16a2 2 0 0 1-1.66 0L2 12.65"/></svg>
                      Detailed View
                      <span className="text-xs font-medium text-slate-400 ml-2">Agent activity, timeline, repurposing tracker</span>
                    </h2>
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#94a3b8" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={`chevron-icon ${expandedSections.detail ? 'rotated' : ''}`}><path d="m6 9 6 6 6-6"/></svg>
                  </button>

                  <div data-expand-target="detail" className={expandedSections.detail ? 'open' : ''}>
                    <div className="px-8 pb-8 grid grid-cols-12 gap-8 border-t border-slate-100 pt-6">

                      {/* Left: Living Timeline */}
                      <div className="col-span-7 space-y-6">
                        <div className="flex items-center justify-between">
                          <h3 className="text-base font-bold flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#4f46e5" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M12 7v5l4 2"/></svg>
                            Mission Timeline
                          </h3>
                          <span className="text-[11px] text-slate-400">Updated 2 min ago</span>
                        </div>

                        <div className="relative pl-10 timeline-line space-y-8">
                          {TIMELINE_MILESTONES.map((m, i) => (
                            <div key={i} className="relative">
                              <div className={`absolute -left-[30px] w-10 h-10 ${m.major ? `bg-${m.color}-600 text-white shadow-lg shadow-${m.color}-200` : `bg-white border-2 border-${m.color}-500 text-${m.color}-500`} rounded-full flex items-center justify-center z-10`}>
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                  {m.icon === 'file-check' && <><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="m9 15 2 2 4-4"/></>}
                                  {m.icon === 'microscope' && <><path d="M6 18h8"/><path d="M3 22h18"/><path d="M14 22a7 7 0 1 0 0-14h-1"/><path d="M9 14h2"/><path d="M9 12a2 2 0 0 1-2-2V6h6v4a2 2 0 0 1-2 2Z"/></>}
                                  {m.icon === 'flask-conical' && <><path d="M10 2v7.527a2 2 0 0 1-.211.896L4.72 20.55a1 1 0 0 0 .9 1.45h12.76a1 1 0 0 0 .9-1.45l-5.069-10.127A2 2 0 0 1 14 9.527V2"/><path d="M8.5 2h7"/><path d="M7 16h10"/></>}
                                  {m.icon === 'mail' && <><rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></>}
                                </svg>
                              </div>
                              <div className={`${m.major ? 'bg-indigo-50 border-2 border-indigo-200' : 'bg-white border border-slate-200'} p-5 rounded-2xl`}>
                                <div className="flex justify-between items-start mb-1">
                                  <h4 className={`font-bold text-sm ${m.major ? 'text-indigo-900' : 'text-slate-800'}`}>{m.title}</h4>
                                  {m.major && <span className="bg-indigo-600 text-white text-[8px] font-black px-2 py-0.5 rounded uppercase">Major</span>}
                                  {m.pending && <span className="bg-amber-100 text-amber-700 text-[8px] font-black px-1.5 py-0.5 rounded uppercase">Pending</span>}
                                </div>
                                <p className="text-[11px] text-slate-500">{m.desc}</p>
                                {m.stats && (
                                  <div className="grid grid-cols-2 gap-2 mt-3">
                                    {m.stats.map((s, j) => (
                                      <div key={j} className="bg-slate-50 p-2.5 rounded-lg border border-slate-100">
                                        <span className="text-[9px] font-bold text-slate-400 uppercase">{s.label}</span>
                                        <p className="text-xs font-semibold">{s.value}</p>
                                      </div>
                                    ))}
                                  </div>
                                )}
                                {m.major && (
                                  <div className="space-y-2 border-l-2 border-indigo-200 pl-3 py-1 text-xs mt-3">
                                    {REPURPOSING_DEMO_DATA.council.slice(0, 3).map((msg, j) => (
                                      <div key={j} className="flex gap-2">
                                        <span className={`font-bold text-${AGENT_COLORS[msg.agent]}-600 uppercase w-16 shrink-0 text-[9px]`}>{msg.agent}</span>
                                        <p className="text-slate-600">"{msg.text.substring(0, 80)}..."</p>
                                      </div>
                                    ))}
                                  </div>
                                )}
                              </div>
                            </div>
                          ))}
                        </div>
                      </div>

                      {/* Right: ROADMAP + Team Status */}
                      <div className="col-span-5 space-y-6">

                        {/* ROADMAP Tracker */}
                        <div className="bg-white p-5 rounded-2xl border border-slate-200">
                          <h4 className="font-bold text-sm mb-1 flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#4f46e5" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m10.5 20.5 10-10a4.95 4.95 0 1 0-7-7l-10 10a4.95 4.95 0 1 0 7 7Z"/><path d="m8.5 8.5 7 7"/></svg>
                            Repurposing ROADMAP
                          </h4>
                          <p className="text-[10px] text-slate-400 mb-4">EveryCure Framework</p>

                          <div className="space-y-3 relative">
                            <div className="absolute left-[11px] top-2 bottom-2 w-0.5 bg-slate-200"></div>
                            {REPURPOSING_DEMO_DATA.steps.map((s, i) => (
                              <div key={i} className={`flex items-start gap-3 relative ${!s.done && !s.active ? 'opacity-40' : ''}`}>
                                {s.done ? (
                                  <div className="w-6 h-6 rounded-full bg-emerald-500 flex items-center justify-center z-10 shrink-0">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
                                  </div>
                                ) : s.active ? (
                                  <div className="w-6 h-6 rounded-full bg-amber-500 flex items-center justify-center z-10 shrink-0 ring-2 ring-amber-200">
                                    <span className="text-[9px] font-black text-white">{i + 1}</span>
                                  </div>
                                ) : (
                                  <div className="w-6 h-6 rounded-full bg-slate-200 flex items-center justify-center z-10 shrink-0">
                                    <span className="text-[9px] font-bold text-slate-400">{i + 1}</span>
                                  </div>
                                )}
                                <div>
                                  <p className={`text-[11px] font-bold ${s.active ? 'text-amber-700' : s.done ? 'text-slate-700' : 'text-slate-500'}`}>{s.name}</p>
                                  {s.desc && <p className={`text-[10px] ${s.active ? 'text-amber-600' : 'text-slate-400'}`}>{s.desc}</p>}
                                </div>
                              </div>
                            ))}
                          </div>

                          <div className="mt-4 p-3 bg-emerald-50 rounded-xl border border-emerald-100">
                            <div className="flex items-center gap-2 mb-0.5">
                              <span className="bg-emerald-600 text-white text-[8px] font-black px-1.5 py-0.5 rounded uppercase">Lead</span>
                              <span className="text-xs font-bold text-emerald-900">Tamoxifen</span>
                            </div>
                            <p className="text-[10px] text-emerald-700">TRPML1 agonist &middot; FDA-approved &middot; Ped. data</p>
                          </div>
                        </div>

                        {/* Team Status */}
                        <div className="bg-white p-5 rounded-2xl border border-slate-200">
                          <h4 className="font-bold text-sm mb-4 flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#64748b" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                            Your Team
                          </h4>
                          <div className="space-y-2.5">
                            {[
                              { name: 'Scout', status: 'active', task: 'Monitoring publications' },
                              { name: 'Connector', status: 'waiting', task: 'Awaiting Dr. Cooper' },
                              { name: 'Navigator', status: 'active', task: 'Pathway mapped' },
                              { name: 'Mobilizer', status: 'waiting', task: 'Drafting CZI grant' },
                              { name: 'Strategist', status: 'active', task: 'Briefing ready' },
                            ].map(a => (
                              <div key={a.name} className="flex items-center gap-3">
                                <div className={`w-2 h-2 rounded-full ${a.status === 'active' ? 'bg-emerald-500' : 'bg-amber-500 agent-pulse'}`}></div>
                                <span className="text-[11px] font-bold text-slate-700 w-20">{a.name}</span>
                                <span className="text-[11px] text-slate-400">{a.task}</span>
                              </div>
                            ))}
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

              </div>
            </div>
          </main>
        </div>
      );
    }

    // ==========================================
    // APPROVAL MODAL (reused)
    // ==========================================

    function ApprovalModal({ approval, onClose }) {
      const [edited, setEdited] = useState({ ...approval });

      const handleApprove = () => {
        console.log('Approved:', edited);
        alert('Email approved and queued for sending!');
        onClose();
      };

      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="modal" onClick={e => e.stopPropagation()}>
            <div className="flex justify-between items-center mb-6">
              <h2 className="text-2xl font-bold">Review & Approve</h2>
              <button onClick={onClose} className="text-slate-400 hover:text-slate-800 text-2xl leading-none">&times;</button>
            </div>

            <div className="mb-4">
              <label className="block font-semibold text-sm text-slate-700 mb-1">To:</label>
              <input type="text" value={edited.to || ''} onChange={e => setEdited({ ...edited, to: e.target.value })}
                className="w-full px-3 py-2 border-2 border-slate-200 rounded-lg focus:outline-none focus:border-indigo-500" />
            </div>

            <div className="mb-4">
              <label className="block font-semibold text-sm text-slate-700 mb-1">Subject:</label>
              <input type="text" value={edited.subject || ''} onChange={e => setEdited({ ...edited, subject: e.target.value })}
                className="w-full px-3 py-2 border-2 border-slate-200 rounded-lg focus:outline-none focus:border-indigo-500" />
            </div>

            <div className="mb-4">
              <label className="block font-semibold text-sm text-slate-700 mb-1">Message:</label>
              <textarea value={edited.body || ''} onChange={e => setEdited({ ...edited, body: e.target.value })}
                className="w-full px-3 py-3 border-2 border-slate-200 rounded-lg focus:outline-none focus:border-indigo-500 min-h-[200px] font-sans" />
            </div>

            {approval.note && (
              <div className="bg-amber-50 border-l-4 border-amber-500 p-4 rounded-lg mb-4">
                <div className="font-semibold text-sm text-amber-800 mb-1">Connector's Note:</div>
                <div className="text-sm text-amber-700">{approval.note}</div>
              </div>
            )}

            <div className="flex gap-3 mt-6">
              <button onClick={handleApprove} className="px-6 py-3 bg-emerald-500 text-white rounded-xl font-bold hover:bg-emerald-600 transition-colors shadow-md">Approve & Send</button>
              <button onClick={() => alert('Edits saved!')} className="px-6 py-3 bg-indigo-600 text-white rounded-xl font-bold text-sm hover:bg-indigo-700 transition-colors">Save Edits</button>
              <button onClick={onClose} className="px-6 py-3 bg-slate-200 text-slate-700 rounded-xl font-bold text-sm hover:bg-slate-300 transition-colors">Cancel</button>
            </div>
          </div>
        </div>
      );
    }

    // Render
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
