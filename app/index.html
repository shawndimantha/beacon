<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Beacon - Your AI Team for Rare Disease Treatment</title>

  <!-- React 18 + ReactDOM via CDN -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- Babel Standalone for JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <!-- 3Dmol.js for protein/molecule visualization -->
  <script src="https://3Dmol.org/build/3Dmol-min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
    body { font-family: 'Inter', sans-serif; }

    .step-inactive { opacity: 0.3; filter: grayscale(1); pointer-events: none; }
    .agent-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
    @keyframes fadeUp { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
    .fade-up { animation: fadeUp 0.5s ease-out forwards; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .fade-in { animation: fadeIn 0.6s ease-in forwards; }

    .timeline-line::before { content: ''; position: absolute; left: 19px; top: 0; bottom: 0; width: 2px; background: #e2e8f0; }
    [data-expand-target] { max-height: 0; overflow: hidden; transition: max-height 0.4s ease, opacity 0.3s ease; opacity: 0; }
    [data-expand-target].open { max-height: 3000px; opacity: 1; }
    .chevron-icon { transition: transform 0.3s ease; }
    .chevron-icon.rotated { transform: rotate(180deg); }
    .chevron { transition: transform 0.3s ease; display: inline-block; }
    .chevron.rotated { transform: rotate(180deg); }
    .card-hover { transition: transform 0.3s ease, box-shadow 0.3s ease; }
    .card-hover:hover { transform: translateY(-3px); box-shadow: 0 20px 40px -12px rgba(0,0,0,0.15); }
    @keyframes slideOut { to { opacity: 0; transform: translateX(200px) rotate(10deg); } }
    .slide-out { animation: slideOut 0.3s ease-in forwards; }
    @keyframes slideOutLeft { to { opacity: 0; transform: translateX(-200px) rotate(-10deg); } }
    .slide-out-left { animation: slideOutLeft 0.3s ease-in forwards; }

    /* Modal styles (reused from original) */
    .modal-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.6); display: flex; align-items: center; justify-content: center;
      z-index: 1000; opacity: 0; animation: fadeIn 0.3s ease-out forwards;
    }
    .modal {
      background: white; border-radius: 20px; padding: 2.5rem; max-width: 700px; width: 90%;
      max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      transform: scale(0.9); animation: modalAppear 0.3s ease-out forwards;
    }
    @keyframes modalAppear { to { transform: scale(1); } }
  </style>
</head>
<body class="bg-slate-100 min-h-screen text-slate-900">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useCallback, useRef, useMemo } = React;

    // ==========================================
    // DATA CONSTANTS
    // ==========================================

    const RARE_DISEASES = [
      { name: "Batten Disease (CLN3)", aliases: ["CLN3", "Juvenile Neuronal Ceroid Lipofuscinosis", "JNCL", "Batten Disease"] },
      { name: "Batten Disease (CLN1)", aliases: ["CLN1", "Infantile Neuronal Ceroid Lipofuscinosis"] },
      { name: "Batten Disease (CLN2)", aliases: ["CLN2", "Late Infantile Neuronal Ceroid Lipofuscinosis", "TPP1 Deficiency"] },
      { name: "Spinal Muscular Atrophy (SMA)", aliases: ["SMA", "Werdnig-Hoffmann Disease"] },
      { name: "Duchenne Muscular Dystrophy", aliases: ["DMD", "Duchenne"] },
      { name: "Cystic Fibrosis", aliases: ["CF", "Mucoviscidosis"] },
      { name: "Huntington's Disease", aliases: ["HD", "Huntington Chorea"] },
      { name: "Rett Syndrome", aliases: ["MECP2", "Rett"] },
      { name: "Dravet Syndrome", aliases: ["SCN1A", "Severe Myoclonic Epilepsy of Infancy"] },
      { name: "Fragile X Syndrome", aliases: ["FXS", "Martin-Bell Syndrome"] },
      { name: "Tay-Sachs Disease", aliases: ["Hexosaminidase A Deficiency"] },
      { name: "Gaucher Disease", aliases: ["Glucocerebrosidase Deficiency"] },
      { name: "Pompe Disease", aliases: ["Glycogen Storage Disease Type II"] },
      { name: "Fabry Disease", aliases: ["Alpha-Galactosidase A Deficiency"] },
      { name: "Phenylketonuria (PKU)", aliases: ["PKU"] },
      { name: "Niemann-Pick Disease", aliases: ["NPD"] },
      { name: "Angelman Syndrome", aliases: ["AS"] },
      { name: "Prader-Willi Syndrome", aliases: ["PWS"] },
      { name: "Sanfilippo Syndrome", aliases: ["MPS III"] },
      { name: "Krabbe Disease", aliases: ["Globoid Cell Leukodystrophy"] },
      { name: "CDKL5 Deficiency Disorder", aliases: ["CDKL5", "CDD"] },
      { name: "Giant Axonal Neuropathy", aliases: ["GAN"] },
      { name: "AADC Deficiency", aliases: ["Aromatic L-Amino Acid Decarboxylase Deficiency"] },
      { name: "Epidermolysis Bullosa", aliases: ["EB", "Butterfly Disease"] },
      { name: "Sickle Cell Disease", aliases: ["SCD"] },
    ];

    const JOURNEY_STAGES = [
      { id: 'pre-diagnosis', emoji: '\u{1F50D}', title: "Still searching for answers", desc: "Symptoms but no clear diagnosis yet" },
      { id: 'just-diagnosed', emoji: '\u{1F4CB}', title: "Just received a diagnosis", desc: "Need to make sense of it and build a plan" },
      { id: 'established', emoji: '\u{1F6E4}\u{FE0F}', title: "We've known for a while", desc: "Go deeper on treatment pathways and trials" },
    ];

    const DEMO_EVENTS = [
      { t: 0, type: 'summary', text: 'Analyzing CLN3 Batten Disease...' },
      { t: 2000, type: 'agent_status', agent: 'Scout', status: 'Searching bioRxiv...', done: false },
      { t: 2000, type: 'agent_status', agent: 'Navigator', status: 'Checking FDA orphan drug database...', done: false },
      { t: 2000, type: 'agent_status', agent: 'Connector', status: 'Querying NPI Registry...', done: false },
      { t: 2000, type: 'agent_status', agent: 'Mobilizer', status: 'Scanning NIH grants...', done: false },
      { t: 2000, type: 'agent_status', agent: 'Strategist', status: 'Building framework...', done: false },
      { t: 4000, type: 'progress', phase: 'Research', pct: 30 },
      { t: 4000, type: 'agent_status', agent: 'Navigator', status: 'CLN3 qualifies for Orphan Drug Designation', done: true },
      { t: 6000, type: 'achievement', text: 'FDA orphan drug pathway confirmed viable' },
      { t: 6000, type: 'progress', phase: 'Regulatory', pct: 40 },
      { t: 8000, type: 'agent_status', agent: 'Scout', status: 'AAV9-CLN3 gene therapy trial identified', done: true },
      { t: 8000, type: 'achievement', text: 'Found active gene therapy trial at Weill Cornell' },
      { t: 8000, type: 'progress', phase: 'Research', pct: 70 },
      { t: 10000, type: 'insight', id: 'trial_match' },
      { t: 14000, type: 'achievement', text: 'Identified tamoxifen as repurposing candidate' },
      { t: 14000, type: 'insight', id: 'repurposing' },
      { t: 14000, type: 'progress', phase: 'Research', pct: 100, status: 'complete' },
      { t: 18000, type: 'insight', id: 'email_decision' },
      { t: 18000, type: 'agent_status', agent: 'Connector', status: '5 outreach emails drafted', done: true },
      { t: 18000, type: 'progress', phase: 'Outreach', pct: 60 },
      { t: 22000, type: 'insight', id: 'everycure_decision' },
      { t: 20000, type: 'agent_status', agent: 'Mobilizer', status: 'Matched funding sources to experiment tiers', done: false },
      { t: 22000, type: 'agent_status', agent: 'Mobilizer', status: 'Grant strategy ready — 5 tiers funded', done: true },
      { t: 22000, type: 'agent_status', agent: 'Strategist', status: 'Roadmap complete', done: true },
      { t: 24000, type: 'summary', text: 'Your plan is ready.' },
    ];

    const AGENT_COLORS = {
      Scout: 'violet', Connector: 'pink', Navigator: 'blue', Mobilizer: 'emerald', Strategist: 'amber',
      Biologist: 'cyan', Chemist: 'orange', Preclinician: 'rose'
    };
    const AGENT_EMOJIS = {
      Scout: '\u{1F52C}', Connector: '\u{1F91D}', Navigator: '\u{1F9ED}', Mobilizer: '\u{1F4B0}', Strategist: '\u{1F3AF}',
      Biologist: '\u{1F9EC}', Chemist: '\u{2697}\u{FE0F}', Preclinician: '\u{1F9EA}'
    };

    // ==========================================
    // LAB TAB DEMO DATA
    // ==========================================

    const LAB_TARGETS = [
      {
        name: 'CLN3 / Battenin', gene: 'CLN3', uniprot_id: 'Q13286',
        function: 'Lysosomal transmembrane protein involved in autophagy and endosomal sorting',
        druggability_score: 0.35, genetic_evidence: 0.95,
        pdb_file: 'data/structures/CLN3.pdb',
        pathway: 'Autophagy-lysosome pathway',
        rationale: 'Primary disease gene — loss of function causes lipofuscin accumulation',
      },
      {
        name: 'TRPML1 / Mucolipin-1', gene: 'MCOLN1', uniprot_id: 'Q9GZU1',
        function: 'Lysosomal cation channel; regulates Ca2+ release for autophagy',
        druggability_score: 0.82, genetic_evidence: 0.7,
        pdb_file: 'data/structures/TRPML1.pdb',
        pathway: 'Lysosomal Ca2+ signaling',
        rationale: 'Downstream effector — agonists rescue lysosomal function in CLN3 models',
      },
      {
        name: 'TFEB', gene: 'TFEB', uniprot_id: 'P19484',
        function: 'Master transcription factor for lysosomal biogenesis',
        druggability_score: 0.6, genetic_evidence: 0.55,
        pdb_file: 'data/structures/TFEB.pdb',
        pathway: 'CLEAR gene network / lysosomal biogenesis',
        rationale: 'Activation increases lysosomal clearance capacity — compensatory strategy',
      },
    ];

    const LAB_CANDIDATES = [
      {
        name: 'Tamoxifen', chembl_id: 'CHEMBL83', smiles: 'CC(/C=C/c1ccc(OCCN(C)C)cc1)=C(\\c1ccccc1)c1ccccc1',
        target: 'TRPML1 agonist', pchembl: 6.8, mechanism: 'Activates TRPML1 lysosomal channel → restores Ca2+ flux → enhances autophagy',
        fda_approved: true, max_phase: 4,
        indication: 'Breast cancer (current), CLN3 lysosomal rescue (proposed)',
        evidence: '2021 EMBO Mol Med — reduced lipofuscin in CLN3 mouse model',
        scores: {
          efficacy: { val: 'pChEMBL 6.8', rating: 'green' },
          oral_absorption: { val: 'PSA 12.5', rating: 'green' },
          cns_penetration: { val: 'Crosses BBB', rating: 'green' },
          herg: { val: 'IC50 > 30µM', rating: 'green' },
          cyp_inhibition: { val: 'CYP2D6 moderate', rating: 'amber' },
          solubility: { val: 'LogS -5.1', rating: 'amber' },
          selectivity: { val: '> 50x', rating: 'amber' },
          synthetic_access: { val: 'SA 2.1', rating: 'green' },
        },
        overall: 'green', recommendation: 'Advance — FDA-approved, pediatric data exists',
      },
      {
        name: 'Rapamycin', chembl_id: 'CHEMBL413', smiles: 'placeholder',
        target: 'mTOR inhibitor → TFEB activation', pchembl: 8.2, mechanism: 'Inhibits mTOR → releases TFEB → upregulates lysosomal biogenesis',
        fda_approved: true, max_phase: 4,
        indication: 'Organ transplant (current), CLN3 lysosomal clearance (proposed)',
        evidence: '2019 Autophagy — improved autophagic flux in NCL cell models',
        scores: {
          efficacy: { val: 'pChEMBL 8.2', rating: 'green' },
          oral_absorption: { val: 'PSA 195', rating: 'red' },
          cns_penetration: { val: 'Low BBB', rating: 'red' },
          herg: { val: 'IC50 > 100µM', rating: 'green' },
          cyp_inhibition: { val: 'CYP3A4 substrate', rating: 'amber' },
          solubility: { val: 'LogS -4.8', rating: 'amber' },
          selectivity: { val: '> 1000x', rating: 'green' },
          synthetic_access: { val: 'SA 6.2', rating: 'red' },
        },
        overall: 'amber', recommendation: 'Investigate CNS-penetrant analogs (e.g., everolimus)',
      },
      {
        name: 'Cysteamine', chembl_id: 'CHEMBL602', smiles: 'NCCS',
        target: 'Lysosomal cystine transporter', pchembl: 5.1, mechanism: 'Reduces lysosomal cystine accumulation → decreases oxidative stress',
        fda_approved: true, max_phase: 4,
        indication: 'Cystinosis (current), NCL neuroprotection (proposed)',
        evidence: '2020 Orphanet J Rare Dis — improved biomarkers in open-label NCL study',
        scores: {
          efficacy: { val: 'pChEMBL 5.1', rating: 'amber' },
          oral_absorption: { val: 'PSA 38', rating: 'green' },
          cns_penetration: { val: 'Crosses BBB', rating: 'green' },
          herg: { val: 'IC50 > 100µM', rating: 'green' },
          cyp_inhibition: { val: 'Minimal', rating: 'green' },
          solubility: { val: 'LogS 0.2', rating: 'green' },
          selectivity: { val: 'Broad', rating: 'red' },
          synthetic_access: { val: 'SA 1.0', rating: 'green' },
        },
        overall: 'amber', recommendation: 'Secondary candidate — supportive therapy potential',
      },
      {
        name: '4-Phenylbutyrate', chembl_id: 'CHEMBL1200983', smiles: 'O=C(O)CCCc1ccccc1',
        target: 'Chemical chaperone / HDAC inhibitor', pchembl: 4.5, mechanism: 'Stabilizes misfolded CLN3 protein → restores partial function',
        fda_approved: true, max_phase: 4,
        indication: 'Urea cycle disorders (current), CLN3 chaperone (proposed)',
        evidence: '2018 Hum Mol Genet — partial CLN3 function rescue in patient fibroblasts',
        scores: {
          efficacy: { val: 'pChEMBL 4.5', rating: 'red' },
          oral_absorption: { val: 'PSA 37', rating: 'green' },
          cns_penetration: { val: 'Moderate BBB', rating: 'amber' },
          herg: { val: 'IC50 > 100µM', rating: 'green' },
          cyp_inhibition: { val: 'Minimal', rating: 'green' },
          solubility: { val: 'LogS -1.5', rating: 'green' },
          selectivity: { val: 'Broad HDAC', rating: 'red' },
          synthetic_access: { val: 'SA 1.2', rating: 'green' },
        },
        overall: 'red', recommendation: 'Deprioritize — low potency, broad mechanism',
      },
      {
        name: 'ML-SA1', chembl_id: 'CHEMBL3246985', smiles: 'placeholder',
        target: 'TRPML1 selective agonist', pchembl: 7.1, mechanism: 'Potent selective TRPML1 agonist → lysosomal Ca2+ release',
        fda_approved: false, max_phase: 0,
        indication: 'Research tool compound — not yet in clinical development',
        evidence: '2022 Nature Chem Biol — rescued lysosomal phenotype in CLN3 iPSC neurons',
        scores: {
          efficacy: { val: 'pChEMBL 7.1', rating: 'green' },
          oral_absorption: { val: 'PSA 65', rating: 'green' },
          cns_penetration: { val: 'Unknown', rating: 'amber' },
          herg: { val: 'Not tested', rating: 'amber' },
          cyp_inhibition: { val: 'Not tested', rating: 'amber' },
          solubility: { val: 'LogS -3.8', rating: 'green' },
          selectivity: { val: '> 100x TRPML1', rating: 'green' },
          synthetic_access: { val: 'SA 3.5', rating: 'green' },
        },
        overall: 'amber', recommendation: 'High potential — needs ADMET characterization and IND-enabling studies',
      },
    ];

    const LAB_PIPELINE_FUNNEL = [
      { stage: 'Targets Identified', count: 12, color: 'cyan' },
      { stage: 'Compounds Screened', count: 847, color: 'blue' },
      { stage: 'Hits (pChEMBL ≥ 6)', count: 23, color: 'indigo' },
      { stage: 'Lead Candidates', count: 5, color: 'violet' },
      { stage: 'Lab Testing Queue', count: 2, color: 'emerald' },
    ];

    function buildCroContacts(disease, targets, candidates) {
      const d = disease || 'rare disease';
      const targetNames = (targets || []).slice(0, 3).map(t => t.name || t.gene).filter(Boolean);
      const targetStr = targetNames.length ? targetNames.join(', ') : 'identified therapeutic targets';
      const compoundNames = (candidates || []).slice(0, 5).map(c => c.name).filter(Boolean);
      const topCompounds = compoundNames.slice(0, 5).join(', ') || 'computationally identified candidates';
      const top3 = compoundNames.slice(0, 3).join(', ') || 'top 3 from biochemical screen';
      const top2 = compoundNames.slice(0, 2).join(', ') || 'top 2 leads';
      const lead = compoundNames[0] || 'lead compound';
      const mechs = (candidates || []).slice(0, 3).map(c => c.mechanism).filter(Boolean);
      const mechStr = mechs.length ? mechs.join('; ') : 'multiple mechanisms under evaluation';

      return {
        1: { name: 'Charles River Laboratories', specialty: 'Biochemical assay services', email: 'drugdiscovery@crl.com',
          subject: `BD Inquiry — Biochemical IC50 Assay for ${d} Targets`,
          body: `Dear Charles River Discovery team,\n\nWe are a rare disease family research initiative investigating ${d}. Through computational screening against ${targetStr}, we have identified promising compound candidates and would like to commission a Tier 1 biochemical IC50 assay panel.\n\nTargets: ${targetStr}\nCompounds: ${topCompounds}\nMechanisms: ${mechStr}\nAssay type: Dose-response IC50/EC50\nTimeline need: 2-4 weeks\n\nCould you provide a quote and discuss protocol design?\n\nBest regards,\n[Your name]` },
        2: { name: 'Eurofins Discovery', specialty: 'Cell-based functional assays', email: 'discovery@eurofins.com',
          subject: `Cell-Based Functional Assay — ${d} Compound Panel`,
          body: `Dear Eurofins Discovery team,\n\nFollowing successful biochemical screening for ${d}, we need cell-based functional assays for our top candidates: ${top3}.\n\nTargets: ${targetStr}\nCompounds: ${top3}\nReadouts: Disease-relevant functional endpoints, target engagement confirmation\nTimeline: 4-6 weeks\n\nPlease advise on feasibility, appropriate cell models, and pricing.\n\nBest regards,\n[Your name]` },
        3: { name: 'Absorption Systems (Pharmaron)', specialty: 'ADMET profiling', email: 'admet@pharmaron.com',
          subject: `ADMET Panel Request — ${d} Therapeutic Candidates`,
          body: `Dear Pharmaron ADMET team,\n\nWe require a standard ADMET panel for compounds advancing through our ${d} pipeline: ${top3}.\n\nPanel: Microsomal stability, plasma protein binding, CYP inhibition, Caco-2 permeability, hERG\nCompounds: ${top3}\nTimeline: 2-3 weeks\n\nPlease provide a quote.\n\nBest regards,\n[Your name]` },
        4: { name: 'Charles River Laboratories', specialty: 'In vivo pharmacokinetics', email: 'invivo@crl.com',
          subject: `Mouse PK Study — ${d} Lead Compounds`,
          body: `Dear Charles River In Vivo team,\n\nWe need a mouse PK study for leads advancing through our ${d} drug repurposing pipeline: ${top2}.\n\nStudy: Single-dose PK in CD-1 mice (IV + PO)\nCompounds: ${top2}\nEndpoints: Plasma PK, brain/tissue penetration\nTimeline: 6-8 weeks\n\nPlease advise on study design and pricing.\n\nBest regards,\n[Your name]` },
        5: { name: 'The Jackson Laboratory', specialty: 'Disease model efficacy studies', email: 'services@jax.org',
          subject: `Efficacy Study in ${d} Disease Model — ${lead}`,
          body: `Dear Jackson Laboratory team,\n\nWe are seeking an efficacy study in an appropriate disease model for our lead ${d} compound: ${lead}.\n\nCompound: ${lead} (confirmed PK and target engagement)\nEndpoints: Disease-relevant biomarkers, functional outcomes, survival\nDuration: 3-6 months dosing\n\nPlease discuss model availability, feasibility, and study design.\n\nBest regards,\n[Your name]` },
      };
    }

    const LAB_EXPERIMENTS = [
      { tier: 1, name: 'Biochemical Assay (IC50)', compounds: 'Top 5', cost: '$8-15K', timeline: '2-4 weeks', status: 'ready' },
      { tier: 2, name: 'Cell-Based Functional Assay', compounds: 'Top 3', cost: '$15-30K', timeline: '4-6 weeks', status: 'pending' },
      { tier: 3, name: 'In Vitro ADMET Panel', compounds: 'Top 3', cost: '$10-20K', timeline: '2-3 weeks', status: 'pending' },
      { tier: 4, name: 'Mouse PK Study', compounds: 'Top 2', cost: '$20-50K', timeline: '6-8 weeks', status: 'pending' },
      { tier: 5, name: 'Efficacy in Disease Model', compounds: 'Top 1', cost: '$50-150K', timeline: '3-6 months', status: 'pending' },
    ];

    // ==========================================
    // COMMUNITY TAB DEMO DATA
    // ==========================================

    const COMMUNITY_FAMILIES = [
      { id: 1, name: 'The Martinez Family', location: 'Houston, TX', child: 'Sofia, age 8', stage: 'Established (3 yrs)', treatments: ['Cerliponase alfa (Brineura)', 'Physical therapy'], avatar: 'SM', color: 'pink', willing: ['Share treatment logs', 'Connect with new families'] },
      { id: 2, name: 'The Chen Family', location: 'San Francisco, CA', child: 'Lucas, age 6', stage: 'Recently diagnosed', treatments: ['Gene therapy trial screening'], avatar: 'LC', color: 'blue', willing: ['Share genetic test results', 'Coordinate on trials'] },
      { id: 3, name: 'The Okafor Family', location: 'Chicago, IL', child: 'Amara, age 11', stage: 'Established (5 yrs)', treatments: ['Tamoxifen (off-label pilot)', 'Seizure management'], avatar: 'AO', color: 'violet', willing: ['Share N-of-1 data', 'Advocate for funding'] },
    ];

    const COMMUNITY_DATA_COMMONS = {
      totalFamilies: 12,
      trackingSymptoms: 9,
      treatments: [
        { name: 'Cerliponase alfa (Brineura)', families: 4, avgDuration: '18 months', trend: 'stable' },
        { name: 'Tamoxifen (off-label)', families: 3, avgDuration: '4 months', trend: 'promising' },
        { name: 'Gene therapy trial', families: 2, avgDuration: '6 months', trend: 'early' },
        { name: 'Miglustat', families: 1, avgDuration: '12 months', trend: 'stable' },
      ],
      biomarkers: { avgAge: 8.3, seizureFreq: '2.1/week avg', visionDecline: '67% reporting' },
    };

    const COMMUNITY_NOF1_TRACKER = {
      experiment: 'Tamoxifen 10mg daily — CLN3 lysosomal clearance pilot',
      family: 'Okafor Family',
      startDate: '2025-10-15',
      weeks: 16,
      dataPoints: [
        { week: 0, seizures: 4, mobility: 6, cognition: 5, notes: 'Baseline' },
        { week: 4, seizures: 3, mobility: 6, cognition: 5, notes: 'Slight seizure reduction' },
        { week: 8, seizures: 2, mobility: 7, cognition: 5, notes: 'Continued improvement' },
        { week: 12, seizures: 2, mobility: 7, cognition: 6, notes: 'Cognition uptick noted' },
        { week: 16, seizures: 1, mobility: 7, cognition: 6, notes: 'Sustained response' },
      ],
    };

    const CLINICAL_TRIAL_ROADMAP = [
      { step: 'Patient Community', status: 'active', detail: '12 families connected', icon: 'users', agents: ['Connector'] },
      { step: 'Shared Data Commons', status: 'active', detail: '9 families tracking outcomes', icon: 'database', agents: ['Preclinician'] },
      { step: 'Natural History Study', status: 'next', detail: 'Mapping IRB requirements', icon: 'clipboard', agents: ['Navigator'] },
      { step: 'IND Submission', status: 'future', detail: 'Identifying FDA consultants', icon: 'file-text', agents: ['Mobilizer', 'Navigator'] },
      { step: 'IRB Approval', status: 'future', detail: 'Estimated 4-6 months after IND', icon: 'shield', agents: ['Navigator'] },
      { step: 'Phase 1 Trial', status: 'future', detail: 'Target: 2027', icon: 'activity', agents: ['Strategist', 'Mobilizer'] },
    ];

    const EXPERIMENT_FUNDING = {
      1: [{ source: 'Family GoFundMe', type: 'family', amount: '$8-15K', fit: 'Immediate, no approval needed' }, { source: 'BDSRA Pilot Grant', type: 'foundation', amount: '$10K', fit: 'Annual cycle, strong fit' }],
      2: [{ source: 'Beyond Batten Disease Foundation', type: 'foundation', amount: '$25K', fit: 'Research grants for CLN3' }, { source: 'NORD Research Grant', type: 'foundation', amount: '$30K', fit: 'Competitive, 6-month cycle' }],
      3: [{ source: 'CZI Rare As One', type: 'grant', amount: '$50K', fit: 'Supports patient-led research' }, { source: 'NCATS TRND', type: 'nih', amount: '$20K', fit: 'Pre-clinical validation' }],
      4: [{ source: 'NIH NCATS UG3/UH3', type: 'nih', amount: '$50K', fit: 'Translational research' }, { source: 'EveryCure Partnership', type: 'pharma', amount: '$30-50K', fit: 'Drug repurposing focus' }],
      5: [{ source: 'DoD CDMRP', type: 'nih', amount: '$150K', fit: 'Rare disease efficacy studies' }, { source: 'Harrington Discovery Inst.', type: 'venture', amount: '$100K+', fit: 'Venture philanthropy, requires 501(c)(3)' }],
    };

    const REPURPOSING_DEMO_DATA = {
      steps: [
        { name: 'Supporting Repurposing', desc: 'Disease characterized', done: true },
        { name: 'Identifying the Drug', desc: '47 screened, 2 candidates', done: true },
        { name: 'Validating the Drug', desc: 'Drafting protocol...', active: true },
        { name: 'Clinical Access', desc: '', done: false },
        { name: 'Reaching an Endpoint', desc: '', done: false },
      ],
      candidates: [
        { name: 'Tamoxifen', stage: 'Lead', mechanism: 'TRPML1 agonist', fdaApproved: true, pediatricData: true },
        { name: '4-Phenylbutyrate (4-PBA)', stage: 'Early', mechanism: 'Chemical chaperone', fdaApproved: true, pediatricData: false },
      ],
      council: [
        { agent: 'Scout', text: 'ChEMBL screen returned 47 compounds. Tamoxifen shows TRPML1 agonist activity at clinically achievable doses. Found 2 off-label case reports in adult NCL patients.' },
        { agent: 'Navigator', text: 'FDA-approved since 1977. Pediatric dosing from precocious puberty studies. Off-label use needs physician agreement only \u2014 no IND required.' },
        { agent: 'Strategist', text: 'Dual track: tamoxifen near-term (months) + AAV9 gene therapy long-term. These are complementary, not competing.' },
        { agent: 'Scout', text: '4-PBA is a secondary candidate \u2014 chemical chaperone that may stabilize misfolded CLN3 protein. Less evidence but worth monitoring.' },
        { agent: 'Connector', text: 'Dr. Bhatt at UCL has published on lysosomal channel modulators in NCL models. Recommending outreach.' },
        { agent: 'Navigator', text: 'For tamoxifen: off-label prescribing is the fastest path. Compassionate use (FDA Form 3926) as backup if physician is hesitant.' },
        { agent: 'Mobilizer', text: 'EveryCure offers free consultation for rare disease drug repurposing using their ROADMAP framework. Recommending outreach.' },
        { agent: 'Strategist', text: 'Action items: (1) Specialist briefing on tamoxifen for your neurologist, (2) EveryCure outreach, (3) Continue gene therapy trial pre-screening.' },
      ],
    };

    const TIMELINE_MILESTONES = [
      { icon: 'file-check', color: 'emerald', title: 'Initial Analysis Complete', desc: '127 papers, 8 trials, 34 compounds analyzed', major: false, stats: [{ label: 'Target', value: 'CLN3 / Battenin' }, { label: 'Trials', value: '3 recruiting' }] },
      { icon: 'microscope', color: 'indigo', title: 'Drug Repurposing Candidate Found', desc: 'Tamoxifen identified via ChEMBL screen', major: true },
      { icon: 'flask-conical', color: 'blue', title: 'Clinical Trial Match: 89%', desc: 'Phase I/II AAV9-CLN3 at Weill Cornell \u2014 8/9 criteria met', major: false },
      { icon: 'mail', color: 'pink', title: 'Outreach Email Drafted', desc: 'Email to Dr. Cooper about AAV9-CLN3 trial', major: false, pending: true },
    ];

    const JOURNEY_ACHIEVEMENTS = [
      { text: 'Found active gene therapy trial at Weill Cornell' },
      { text: 'Identified tamoxifen as repurposing candidate' },
      { text: 'FDA orphan drug pathway confirmed viable' },
    ];

    const INSIGHT_CARDS = [
      {
        id: 'trial',
        badge: 'Clinical Trial Match', badgeColor: 'indigo',
        title: 'Phase I/II AAV9-CLN3 Gene Therapy',
        subtitle: 'Weill Cornell Medical Center',
        description: 'Intrathecal AAV9 delivery targeting CLN3 protein restoration. Your child meets 8 of 9 eligibility criteria.',
        matchBar: { pct: 89, label: '89% match' },
        cta: 'Start Pre-Screening',
        whatItMeans: {
          summary: "This is an experimental treatment being tested for the first time in children with CLN3. Doctors insert a corrected copy of the CLN3 gene using a harmless virus.",
          proceed: "We'll help you contact the trial team and start a pre-screening conversation. No commitment yet.",
          timeline: "Pre-screening takes 2-4 weeks. Enrollment decisions are made by the trial team, not us.",
          caveat: "This is Phase I/II \u2014 safety is still being evaluated. Your care team should be part of this conversation.",
        },
      },
      {
        id: 'repurpose',
        badge: 'Breakthrough', badgeColor: 'indigo',
        title: 'Drug Repurposing: Tamoxifen',
        subtitle: 'Scout + Navigator + Strategist',
        description: 'Tamoxifen activates the TRPML1 lysosomal channel that CLN3 patients are missing. FDA-approved with existing pediatric safety data.',
        cta: 'Generate Specialist Briefing',
        whatItMeans: {
          summary: "Tamoxifen is a well-known, safe medication already approved by the FDA for other conditions. Researchers found it may also help with the specific protein problem in CLN3.",
          proceed: "We'll generate a briefing document your neurologist can review. They would decide if it's appropriate for your child.",
          timeline: "This could move fast \u2014 weeks, not months. It's a conversation with your existing doctor, not a new trial.",
          caveat: "This is \"off-label\" use \u2014 legal and common, but not specifically tested for CLN3 in clinical trials yet.",
        },
      },
    ];

    const DECISION_QUEUE = [
      {
        id: 'email',
        badge: 'Needs Your Approval', badgeColor: 'amber',
        title: 'Email to Dr. Jonathan Cooper',
        subtitle: 'Connector agent',
        description: "Personalized introduction about your family's CLN3 journey and interest in his AAV9 gene therapy research at Weill Cornell.",
        cta: 'Review & Approve',
        whatItMeans: {
          summary: "Your Connector agent drafted a professional, warm email introducing your family to the lead researcher on the gene therapy trial your child matched with.",
          proceed: "You'll see the full email and can edit it before sending. Nothing goes out without your OK.",
          timeline: "Researchers typically respond within 1-2 weeks. We'll follow up if needed.",
          caveat: "This is an introduction, not a commitment. You're starting a conversation, not signing up for anything.",
        },
      },
      {
        id: 'everycure',
        badge: 'Needs Your Approval', badgeColor: 'amber',
        title: 'Contact EveryCure for Repurposing Guidance',
        subtitle: 'Mobilizer agent',
        description: 'EveryCure offers free consultation for rare disease drug repurposing using their ROADMAP framework. They can help validate the tamoxifen pathway.',
        cta: 'Approve Outreach',
        whatItMeans: {
          summary: "EveryCure is a nonprofit that helps families find existing drugs that might work for their child's condition. Their service is completely free.",
          proceed: "We'll send a brief outreach to EveryCure explaining your situation. They'll schedule a consultation call with you.",
          timeline: "They typically respond within a few days. The consultation itself is about 30 minutes.",
          caveat: "EveryCure provides guidance, not medical advice. Any treatment decisions still go through your doctor.",
        },
      },
    ];

    const BACKEND_URL = 'https://beacon-backend-production-bbf8.up.railway.app';

    function isDemo() {
      return new URLSearchParams(window.location.search).has('demo');
    }

    // Helper to fetch and unwrap JSON
    const fetchReport = async (url) => {
      try {
        const res = await fetch(url);
        if (!res.ok) return null;
        const text = await res.text();
        let data;
        try { data = JSON.parse(text); } catch {
          const match = text.match(/```(?:json)?\s*([\s\S]*?)```/);
          if (match) data = JSON.parse(match[1]); else return null;
        }
        if (data && data.type === 'result' && typeof data.result === 'string') {
          try { return JSON.parse(data.result); } catch { return null; }
        }
        return data;
      } catch { return null; }
    };

    // ==========================================
    // MAIN APP
    // ==========================================

    function App() {
      const [view, setView] = useState('onboarding'); // 'onboarding' | 'dashboard'
      const [onboardingStep, setOnboardingStep] = useState(1);
      const [mission, setMission] = useState({
        disease: '', journeyStage: 'just-diagnosed', patient: 'child', location: 'us',
      });
      const [modalOpen, setModalOpen] = useState(false);
      const [selectedApproval, setSelectedApproval] = useState(null);
      const [userApiKey, setUserApiKey] = useState(sessionStorage.getItem('beacon_api_key') || '');

      const demo = isDemo();
      const urlParams = new URLSearchParams(window.location.search);
      const urlToken = urlParams.get('token') || '';
      const urlDisease = urlParams.get('disease');
      const hasAuth = !!urlToken || (!!userApiKey && userApiKey.startsWith('sk-ant-'));

      useEffect(() => {
        if (demo && !mission.disease) {
          setMission({ disease: 'Batten Disease (CLN3)', journeyStage: 'just-diagnosed', patient: 'child', location: 'us' });
        }
        if (urlDisease && !demo) {
          setMission(prev => ({ ...prev, disease: urlDisease }));
          setView('dashboard');
        }
      }, [demo]);

      return (
        <>
          {view === 'onboarding' ? (
            <OnboardingView
              step={onboardingStep}
              setStep={setOnboardingStep}
              mission={mission}
              setMission={setMission}
              onEnterDashboard={async () => {
                // Gate: must have token or API key
                if (!urlToken && !userApiKey) {
                  alert('Please enter your Anthropic API key to launch agents.');
                  return;
                }
                try {
                  const res = await fetch(`${BACKEND_URL}/api/launch`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                      disease: mission.disease || 'CLN3 Batten Disease',
                      patient: mission.patient || 'child',
                      location: mission.location || 'us',
                      priorities: ['research', 'experts', 'regulatory', 'funding'],
                      journeyStage: mission.journeyStage || 'just-diagnosed',
                      demo: isDemo() || new URLSearchParams(window.location.search).has('cheap'),
                      token: urlToken || undefined,
                      api_key: (!urlToken && userApiKey) ? userApiKey : undefined,
                    })
                  });
                  if (!res.ok) {
                    const err = await res.json().catch(() => ({}));
                    alert(err.error || 'Launch failed — check your API key or token.');
                    return;
                  }
                } catch(err) { console.error('Launch error:', err); alert('Could not reach backend.'); return; }
                setView('dashboard');
              }}
              demo={demo}
              hasAuth={hasAuth}
              userApiKey={userApiKey}
              setUserApiKey={(k) => { setUserApiKey(k); sessionStorage.setItem('beacon_api_key', k); }}
            />
          ) : (
            <DashboardView
              key={mission.disease || 'default'}
              mission={mission}
              demo={demo}
              setModalOpen={setModalOpen}
              setSelectedApproval={setSelectedApproval}
            />
          )}
          {modalOpen && selectedApproval && (
            <ApprovalModal approval={selectedApproval} onClose={() => setModalOpen(false)} />
          )}
        </>
      );
    }

    // ==========================================
    // ONBOARDING VIEW (3 steps, single page)
    // ==========================================

    function OnboardingView({ step, setStep, mission, setMission, onEnterDashboard, demo, hasAuth, userApiKey, setUserApiKey }) {
      const [showAdvanced, setShowAdvanced] = useState(false);
      const [searchQuery, setSearchQuery] = useState(demo ? 'Batten Disease (CLN3)' : '');
      const [showDropdown, setShowDropdown] = useState(false);
      const [filteredDiseases, setFilteredDiseases] = useState([]);

      const handleSearchChange = (e) => {
        const query = e.target.value;
        setSearchQuery(query);
        setMission({ ...mission, disease: query });
        if (query.trim().length > 0) {
          const q = query.toLowerCase();
          const matches = RARE_DISEASES.filter(d =>
            d.name.toLowerCase().includes(q) || d.aliases.some(a => a.toLowerCase().includes(q))
          ).slice(0, 8);
          setFilteredDiseases(matches);
          setShowDropdown(true);
        } else {
          setFilteredDiseases([]);
          setShowDropdown(false);
        }
      };

      const selectDisease = (d) => {
        setSearchQuery(d.name);
        setMission({ ...mission, disease: d.name });
        setShowDropdown(false);
      };

      const goStep = (n) => setStep(n);

      const stepNav = [
        { num: 1, label: 'Welcome', sub: 'Meet Beacon' },
        { num: 2, label: 'Connect', sub: 'Your Situation' },
      ];

      return (
        <div className="min-h-screen flex items-center justify-center p-6">
          <div className="max-w-4xl w-full grid grid-cols-12 gap-8">

            {/* Left: Step sidebar */}
            <div className="col-span-4 pt-10 space-y-6">
              <div className="flex items-center gap-3 mb-10">
                <div className="w-10 h-10 bg-gradient-to-br from-amber-500 to-amber-600 rounded-xl flex items-center justify-center text-white font-black text-lg shadow-lg shadow-amber-200">B</div>
                <span className="text-xl font-extrabold bg-gradient-to-r from-amber-600 to-amber-500 bg-clip-text text-transparent">Beacon</span>
              </div>

              {stepNav.map(s => (
                <div key={s.num} className={`flex items-center gap-4 ${step < s.num ? 'step-inactive' : ''}`}>
                  <div className={`w-10 h-10 rounded-full flex items-center justify-center font-bold text-white ${step >= s.num ? 'bg-indigo-600 shadow-md shadow-indigo-200' : 'bg-slate-300'}`}>{s.num}</div>
                  <div>
                    <p className={`text-[10px] font-bold uppercase tracking-wider ${step >= s.num ? 'text-indigo-600' : 'text-slate-400'}`}>{s.label}</p>
                    <p className="text-sm font-semibold text-slate-800">{s.sub}</p>
                  </div>
                </div>
              ))}
            </div>

            {/* Right: Content cards */}
            <div className="col-span-8">

              {/* Step 1: Privacy */}
              {step === 1 && (
                <div className="bg-white rounded-3xl p-10 shadow-xl border border-slate-200 fade-up">
                  <div className="w-20 h-20 bg-gradient-to-br from-amber-500 to-amber-600 rounded-2xl flex items-center justify-center text-white font-black text-4xl mb-6 shadow-lg shadow-amber-200">B</div>
                  <h2 className="text-3xl font-bold mb-4">Your AI-powered team for rare disease.</h2>
                  <p className="text-slate-500 mb-8 leading-relaxed text-lg">Beacon coordinates research, outreach, regulatory strategy, and funding — so no family has to navigate the system alone.</p>

                  <div className="bg-slate-50 rounded-2xl p-5 border border-slate-100 mb-8 space-y-3">
                    {['Your data is never used to train models.', 'All actions requiring external contact need your approval.', 'Revoke agent access or delete everything at any time.'].map((t, i) => (
                      <div key={i} className="flex items-center gap-3 text-xs font-medium text-slate-500">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#10b981" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
                        {t}
                      </div>
                    ))}
                  </div>

                  {/* API key gate for public visitors (no token in URL) */}
                  {!hasAuth && (
                    <div className="mb-6 p-5 bg-amber-50 rounded-2xl border border-amber-200">
                      <div className="flex items-center gap-2 mb-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#d97706" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                        <span className="text-sm font-bold text-amber-800">Bring Your Own Key</span>
                      </div>
                      <p className="text-xs text-amber-700 mb-3">Beacon's agents run on Claude. Enter your Anthropic API key to get started — it's only used for this session and never stored on our servers.</p>
                      <input
                        type="password"
                        placeholder="sk-ant-..."
                        value={userApiKey}
                        onChange={(e) => setUserApiKey(e.target.value)}
                        className="w-full px-3 py-2.5 border border-amber-300 rounded-xl text-sm font-mono focus:outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 bg-white"
                      />
                      <p className="text-[10px] text-amber-500 mt-2">Get a key at <a href="https://console.anthropic.com" target="_blank" className="underline hover:text-amber-700">console.anthropic.com</a></p>
                    </div>
                  )}

                  <button
                    onClick={() => goStep(2)}
                    disabled={!hasAuth}
                    className="w-full bg-indigo-600 text-white py-4 rounded-2xl font-bold text-lg hover:bg-indigo-700 transition-all shadow-lg shadow-indigo-200 disabled:opacity-40 disabled:cursor-not-allowed"
                  >
                    {hasAuth ? 'Get Started' : 'Enter API key to continue'}
                  </button>
                </div>
              )}

              {/* Step 2: Situation */}
              {step === 2 && (
                <div className="bg-white rounded-3xl p-10 shadow-xl border border-slate-200 fade-up">
                  <h2 className="text-3xl font-bold mb-2">Tell us about your journey.</h2>
                  <p className="text-slate-500 mb-8">This helps your AI team personalize their research.</p>

                  {/* Journey stage */}
                  <div className="space-y-3 mb-8">
                    {JOURNEY_STAGES.map(js => (
                      <button
                        key={js.id}
                        onClick={() => setMission({ ...mission, journeyStage: js.id })}
                        className={`w-full flex items-center gap-4 p-4 rounded-2xl border-2 transition-all text-left ${mission.journeyStage === js.id ? 'border-indigo-600 bg-indigo-50' : 'border-slate-200 hover:border-indigo-300'}`}
                      >
                        <span className="text-2xl">{js.emoji}</span>
                        <div>
                          <div className="font-bold text-slate-800">{js.title}</div>
                          <div className="text-xs text-slate-500">{js.desc}</div>
                        </div>
                      </button>
                    ))}
                  </div>

                  {/* Disease input */}
                  {mission.journeyStage !== 'pre-diagnosis' && (
                    <div className="mb-8">
                      <label className="text-sm font-bold text-slate-700 block mb-2">Condition</label>
                      <div className="relative">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#94a3b8" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="absolute left-4 top-1/2 -translate-y-1/2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                        <input
                          type="text"
                          placeholder="Search for a rare disease..."
                          value={searchQuery}
                          onChange={handleSearchChange}
                          onFocus={() => { if (filteredDiseases.length > 0) setShowDropdown(true); }}
                          onBlur={() => setTimeout(() => setShowDropdown(false), 200)}
                          className="w-full pl-12 pr-4 py-3.5 border-2 border-slate-200 rounded-xl text-base focus:outline-none focus:border-indigo-500 bg-slate-50"
                          autoFocus
                        />
                        {showDropdown && filteredDiseases.length > 0 && (
                          <div className="absolute top-full left-0 right-0 bg-white border-2 border-slate-200 border-t-0 rounded-b-xl shadow-lg z-50 max-h-72 overflow-y-auto">
                            {filteredDiseases.map((d, i) => (
                              <div key={i} className="px-4 py-3 cursor-pointer hover:bg-amber-50 border-b border-slate-100 last:border-0" onMouseDown={() => selectDisease(d)}>
                                <div className="font-semibold text-slate-800">{d.name}</div>
                                <div className="text-xs text-slate-400">{d.aliases.join(' \u00B7 ')}</div>
                              </div>
                            ))}
                          </div>
                        )}
                      </div>
                    </div>
                  )}

                  {/* Upload zone for pre-dx */}
                  {mission.journeyStage === 'pre-diagnosis' && (
                    <div className="mb-8">
                      <label className="text-sm font-bold text-slate-700 block mb-2">Medical Records</label>
                      <div className="border-2 border-dashed border-slate-300 rounded-2xl p-8 flex flex-col items-center bg-slate-50 hover:border-indigo-300 hover:bg-indigo-50/30 transition-all cursor-pointer">
                        <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#94a3b8" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M12 12v9"/><path d="m16 16-4-4-4 4"/></svg>
                        <p className="font-bold text-slate-600 text-sm mt-3">Drop files here</p>
                        <p className="text-[11px] text-slate-400 mt-1">PDF, JPG, PNG, or Medical XML</p>
                      </div>
                      <textarea placeholder="Or describe symptoms and timeline in your own words..." className="mt-3 w-full p-3 border-2 border-slate-200 rounded-xl text-sm resize-none h-20 focus:outline-none focus:border-indigo-500"></textarea>
                    </div>
                  )}

                  {/* Quick intake */}
                  <div className="grid grid-cols-2 gap-4 mb-8">
                    <div>
                      <label className="text-sm font-bold text-slate-700 block mb-2">Patient is</label>
                      <div className="flex gap-2">
                        {[{label: 'My child', id: 'child'}, {label: 'A family member', id: 'family'}, {label: 'Myself', id: 'myself'}].map(({label, id}) => {
                          return (
                            <button key={id} onClick={() => setMission({ ...mission, patient: id })}
                              className={`flex-1 py-2 rounded-lg border-2 text-sm font-semibold ${mission.patient === id ? 'border-indigo-600 bg-indigo-50 text-indigo-700' : 'border-slate-200 text-slate-600 hover:border-slate-300'}`}>
                              {label}
                            </button>
                          );
                        })}
                      </div>
                    </div>
                    <div>
                      <label className="text-sm font-bold text-slate-700 block mb-2">Location</label>
                      <div className="flex gap-2">
                        {['US', 'EU', 'Other'].map(label => {
                          const id = label.toLowerCase();
                          return (
                            <button key={id} onClick={() => setMission({ ...mission, location: id })}
                              className={`flex-1 py-2 rounded-lg border-2 text-sm font-semibold ${mission.location === id ? 'border-indigo-600 bg-indigo-50 text-indigo-700' : 'border-slate-200 text-slate-600 hover:border-slate-300'}`}>
                              {label}
                            </button>
                          );
                        })}
                      </div>
                    </div>
                  </div>

                  <button
                    onClick={onEnterDashboard}
                    disabled={(mission.journeyStage !== 'pre-diagnosis' && !mission.disease) || (!hasAuth && !userApiKey)}
                    className="w-full bg-indigo-600 text-white py-4 rounded-2xl font-bold text-lg hover:bg-indigo-700 transition-all shadow-lg shadow-indigo-200 disabled:opacity-40 disabled:cursor-not-allowed"
                  >
                    {hasAuth ? 'Launch Your Team' : 'Enter API key to launch'} &rarr;
                  </button>
                </div>
              )}

            </div>
          </div>
        </div>
      );
    }

    // ==========================================
    // DASHBOARD VIEW
    // ==========================================

    // ==========================================
    // WHAT-IT-MEANS ACCORDION (shared)
    // ==========================================
    function WhatItMeansAccordion({ item, expanded, onToggle }) {
      return (
        <>
          <button onClick={onToggle} className="flex items-center gap-1.5 text-slate-400 text-[11px] font-bold mb-3 hover:text-indigo-600 transition-colors self-start">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
            What this means for your family
            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={`chevron ${expanded ? 'rotated' : ''}`}><path d="m6 9 6 6 6-6"/></svg>
          </button>
          {expanded && (
            <div className="bg-slate-50 rounded-2xl p-4 mb-4 border border-slate-100 fade-up">
              <p className="text-sm text-slate-700 leading-relaxed mb-3">{item.whatItMeans.summary}</p>
              <div className="space-y-2.5">
                <div className="flex items-start gap-2.5">
                  <div className="w-5 h-5 rounded-full bg-emerald-100 flex items-center justify-center shrink-0 mt-0.5">
                    <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="#059669" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
                  </div>
                  <p className="text-xs text-slate-600"><strong className="text-slate-800">If you proceed:</strong> {item.whatItMeans.proceed}</p>
                </div>
                <div className="flex items-start gap-2.5">
                  <div className="w-5 h-5 rounded-full bg-blue-100 flex items-center justify-center shrink-0 mt-0.5">
                    <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="#2563eb" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                  </div>
                  <p className="text-xs text-slate-600"><strong className="text-slate-800">Timeline:</strong> {item.whatItMeans.timeline}</p>
                </div>
                <div className="flex items-start gap-2.5">
                  <div className="w-5 h-5 rounded-full bg-amber-100 flex items-center justify-center shrink-0 mt-0.5">
                    <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="#d97706" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>
                  </div>
                  <p className="text-xs text-slate-600"><strong className="text-slate-800">Good to know:</strong> {item.whatItMeans.caveat}</p>
                </div>
              </div>
            </div>
          )}
        </>
      );
    }

    // ==========================================
    // INSIGHT CARD (spatial canvas style)
    // ==========================================
    function InsightCard({ insight, expanded, onToggle, onLater, onAction }) {
      return (
        <div className="bg-white rounded-3xl p-6 shadow-xl border border-slate-200 card-hover flex flex-col fade-up">
          <span className={`bg-${insight.badgeColor}-600 text-white text-[9px] font-black px-2.5 py-0.5 rounded-md uppercase self-start`}>{insight.badge}</span>
          <h3 className="font-bold text-slate-900 text-lg mt-3 mb-1">{insight.title}</h3>
          <p className="text-[11px] text-slate-400 font-medium mb-3">{insight.subtitle}</p>
          <p className="text-sm text-slate-600 leading-relaxed mb-4">{insight.description}</p>
          {insight.matchBar && (
            <div className="flex items-center gap-3 mb-4">
              <div className="flex-1 bg-slate-100 h-2 rounded-full overflow-hidden">
                <div className="bg-indigo-500 h-full rounded-full" style={{ width: `${insight.matchBar.pct}%` }}></div>
              </div>
              <span className="text-xs font-bold text-indigo-600">{insight.matchBar.label}</span>
            </div>
          )}
          <WhatItMeansAccordion item={insight} expanded={expanded} onToggle={onToggle} />
          <div className="mt-auto flex gap-3">
            <button onClick={() => onAction && onAction(insight)} className="flex-1 bg-indigo-600 text-white py-3 rounded-xl text-xs font-bold shadow-md hover:bg-indigo-700 transition-colors">{insight.cta}</button>
            <button onClick={onLater} className="px-4 py-3 text-slate-400 rounded-xl text-xs font-bold border border-slate-200 hover:bg-slate-50 hover:text-slate-600 transition-colors flex items-center gap-1.5">
              <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
              Later
            </button>
          </div>
        </div>
      );
    }

    // ==========================================
    // DELEGATION INBOX (Tinder-style)
    // ==========================================
    function DelegationInbox({ expandedId, onToggle, onApprove, onLater, cards }) {
      const [queue, setQueue] = useState([...(cards || DECISION_QUEUE)]);
      const [animating, setAnimating] = useState(null);
      const prevCardsRef = useRef(cards);
      useEffect(() => {
        if (cards && cards.length > 0 && cards !== prevCardsRef.current) {
          prevCardsRef.current = cards;
          setQueue(prev => {
            const existingIds = new Set(prev.map(q => q.id));
            const newCards = cards.filter(c => !existingIds.has(c.id));
            return newCards.length > 0 ? [...prev, ...newCards] : prev;
          });
        }
      }, [cards]);

      const handleAction = (action) => {
        const current = queue[0];
        setAnimating(action);
        setTimeout(() => {
          if (action === 'approve') onApprove(current);
          else onLater(current);
          setQueue(prev => prev.slice(1));
          setAnimating(null);
        }, 300);
      };

      if (queue.length === 0) {
        return (
          <div className="text-center py-8 fade-up">
            <div className="w-16 h-16 bg-emerald-100 rounded-full flex items-center justify-center mx-auto mb-3">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#059669" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
            </div>
            <h3 className="font-bold text-slate-700">All caught up!</h3>
            <p className="text-xs text-slate-400 mt-1">Your agents will notify you when new items need attention.</p>
          </div>
        );
      }

      const current = queue[0];
      const expanded = expandedId === current.id;

      return (
        <div className="max-w-md mx-auto">
          <div className="text-center mb-5">
            <p className="text-[10px] font-black text-amber-600 uppercase tracking-widest">Needs Your Sign-Off</p>
          </div>
          <div className="relative" style={{ minHeight: '320px' }}>
            {queue.length > 2 && <div className="absolute inset-0 translate-y-5 scale-[0.92] bg-white/30 rounded-[32px] border border-slate-200 z-10"></div>}
            {queue.length > 1 && <div className="absolute inset-0 translate-y-2.5 scale-[0.96] bg-white/50 rounded-[32px] border border-slate-200 z-20"></div>}

            <div className={`relative z-30 bg-white rounded-[32px] shadow-2xl border border-amber-200 p-6 flex flex-col ${animating === 'approve' ? 'slide-out' : animating === 'reject' ? 'slide-out-left' : 'fade-up'}`}>
              <span className="bg-amber-100 text-amber-800 text-[9px] font-black px-2.5 py-0.5 rounded-md uppercase self-start">{current.badge}</span>
              <h3 className="font-bold text-slate-900 text-lg mt-3 mb-1">{current.title}</h3>
              <p className="text-[11px] text-slate-400 font-medium mb-3">{current.subtitle}</p>
              <p className="text-sm text-slate-600 leading-relaxed mb-4">{current.description}</p>

              <WhatItMeansAccordion item={current} expanded={expanded} onToggle={() => onToggle(current.id)} />

              <div className="grid grid-cols-2 gap-3 mt-auto">
                <button onClick={() => handleAction('reject')} className="py-3 bg-slate-100 text-slate-500 rounded-2xl font-bold text-xs flex items-center justify-center gap-2 hover:bg-red-50 hover:text-red-500 transition-colors">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                  Later
                </button>
                <button onClick={() => handleAction('approve')} className="py-3 bg-amber-500 text-white rounded-2xl font-bold text-xs flex items-center justify-center gap-2 shadow-lg shadow-amber-200 hover:bg-amber-600 transition-colors">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
                  {current.cta}
                </button>
              </div>
            </div>
          </div>
          {queue.length > 1 && <p className="mt-4 text-center text-[11px] text-slate-400 font-bold">{queue.length - 1} more in queue</p>}
        </div>
      );
    }

    function DashboardView({ mission, demo, setModalOpen, setSelectedApproval }) {
      const [activeTab, setActiveTab] = useState('dashboard');
      const [expandedSections, setExpandedSections] = useState({});
      const [expandedId, setExpandedId] = useState(null);
      const [laterItems, setLaterItems] = useState([]);
      const [liveInsightCards, setLiveInsightCards] = useState([]);
      const [liveDecisionCards, setLiveDecisionCards] = useState([]);
      const [showToast, setShowToast] = useState(null);
      const [state, setState] = useState(null);
      const [summaryText, setSummaryText] = useState(`Analyzing ${mission.disease || 'your condition'}...`);
      const [summaryDone, setSummaryDone] = useState(false);
      const [achievements, setAchievements] = useState([]);
      const [visibleInsights, setVisibleInsights] = useState(new Set());
      const [progressBars, setProgressBars] = useState({ Research: 0, Outreach: 0, Regulatory: 0, Funding: 0, Treatment: 0 });
      const [progressStatus, setProgressStatus] = useState({});
      const [labReady, setLabReady] = useState(false);
      const [actionModal, setActionModal] = useState(null);
      const [showArch, setShowArch] = useState(false);
      const [liveTimeline, setLiveTimeline] = useState([]);
      const [liveRoadmap, setLiveRoadmap] = useState([]);
      const [launchReady, setLaunchReady] = useState(demo ? true : false);
      const [agentStatuses, setAgentStatuses] = useState(
        Object.fromEntries(['Scout','Connector','Navigator','Mobilizer','Strategist','Biologist','Chemist','Preclinician'].map(n => [n, { status: 'Initializing...', done: false }]))
      );
      const [livePlan, setLivePlan] = useState(null);
      const [showBriefing, setShowBriefing] = useState(false);

      // Demo event stream
      useEffect(() => {
        if (!demo) return;
        const LAB_EVENTS = [
          { t: 3000, type: 'agent_status', agent: 'Biologist', status: 'Querying ChEMBL for CLN3 targets...', done: false },
          { t: 5000, type: 'agent_status', agent: 'Biologist', status: 'Fetching AlphaFold structure for Q13286...', done: false },
          { t: 7000, type: 'agent_status', agent: 'Biologist', status: '12 therapeutic targets identified', done: true },
          { t: 7000, type: 'achievement', text: '12 druggable targets mapped with AlphaFold structures' },
          { t: 8000, type: 'agent_status', agent: 'Chemist', status: 'Screening 847 compounds across targets...', done: false },
          { t: 10000, type: 'progress', phase: 'Treatment', pct: 30 },
          { t: 12000, type: 'agent_status', agent: 'Chemist', status: '23 hits found, 5 FDA-approved candidates', done: true },
          { t: 13000, type: 'agent_status', agent: 'Preclinician', status: 'Evaluating ADMET profiles...', done: false },
          { t: 16000, type: 'agent_status', agent: 'Preclinician', status: 'ADMET scoring complete — 2 candidates ready for lab', done: true },
          { t: 16000, type: 'progress', phase: 'Treatment', pct: 60 },
          { t: 17000, type: 'lab_ready' },
        ];
        const allEvents = [...DEMO_EVENTS, ...LAB_EVENTS];
        const timers = allEvents.map(evt =>
          setTimeout(() => {
            if (evt.type === 'summary') {
              setSummaryText(evt.text);
              if (evt.text === 'Your plan is ready.') setSummaryDone(true);
            } else if (evt.type === 'agent_status') {
              setAgentStatuses(prev => ({ ...prev, [evt.agent]: { status: evt.status, done: evt.done } }));
            } else if (evt.type === 'progress') {
              setProgressBars(prev => ({ ...prev, [evt.phase]: evt.pct }));
              if (evt.status === 'complete') setProgressStatus(prev => ({ ...prev, [evt.phase]: 'complete' }));
            } else if (evt.type === 'achievement') {
              setAchievements(prev => [...prev, { text: evt.text }]);
            } else if (evt.type === 'insight') {
              setVisibleInsights(prev => new Set([...prev, evt.id]));
            } else if (evt.type === 'lab_ready') {
              setLabReady(true);
            }
          }, evt.t)
        );
        return () => timers.forEach(clearTimeout);
      }, [demo]);

      // Data polling (non-demo) — consume live agent state
      const prevFindingCountRef = useRef({});
      const expectedDisease = mission.disease;
      useEffect(() => {
        if (demo) return;
        // Reset stale state refs on mount
        prevFindingCountRef.current = {};
        const AGENT_NAME_MAP = { scout: 'Scout', connector: 'Connector', navigator: 'Navigator', mobilizer: 'Mobilizer', strategist: 'Strategist', biologist: 'Biologist', chemist: 'Chemist', preclinician: 'Preclinician' };
        const poll = async () => {
          try {
            const res = await fetch(`${BACKEND_URL}/api/state`);
            if (!res.ok) return;
            const data = await res.json();
            // Skip stale data from a different disease
            const backendDisease = data.mission?.disease;
            if (expectedDisease && backendDisease && backendDisease.toLowerCase() !== expectedDisease.toLowerCase()) return;
            setState(data);

            // Also fetch plan for lab data
            try {
              const planRes = await fetch(`${BACKEND_URL}/api/plan`);
              if (planRes.ok) setLivePlan(await planRes.json());
            } catch(e) {}

            const agents = data.agents || {};
            const newStatuses = {};
            const newAchievements = [];
            let anyComplete = false;
            let allComplete = true;
            let hasScout = false, hasConnector = false;
            let hasBiologist = false, hasChemist = false, hasPreclinician = false;

            for (const [key, agent] of Object.entries(agents)) {
              const name = AGENT_NAME_MAP[key] || key;
              const updates = agent.updates || [];
              const lastUpdate = updates[updates.length - 1];
              const isComplete = agent.status === 'complete';
              const findings = updates.filter(u => u.type === 'finding');

              newStatuses[name] = {
                status: lastUpdate ? lastUpdate.message : (isComplete ? 'Complete' : 'Initializing...'),
                done: isComplete
              };

              // Track new findings as achievements
              const prevCount = prevFindingCountRef.current[key] || 0;
              if (findings.length > prevCount) {
                for (let i = prevCount; i < findings.length; i++) {
                  newAchievements.push({ text: findings[i].message });
                }
                prevFindingCountRef.current[key] = findings.length;
              }

              if (isComplete) anyComplete = true;
              else allComplete = false;
              if (key === 'scout' && isComplete) hasScout = true;
              if (key === 'connector' && isComplete) hasConnector = true;
              if (key === 'biologist' && isComplete) hasBiologist = true;
              if (key === 'chemist' && isComplete) hasChemist = true;
              if (key === 'preclinician' && isComplete) hasPreclinician = true;
            }

            setAgentStatuses(prev => ({ ...prev, ...newStatuses }));
            if (newAchievements.length > 0) {
              setAchievements(prev => {
                const existing = new Set(prev.map(a => a.text));
                const fresh = newAchievements.filter(a => !existing.has(a.text));
                return fresh.length > 0 ? [...prev, ...fresh] : prev;
              });
            }

            // Show insights when relevant agents complete
            if (hasScout) {
              setVisibleInsights(prev => {
                const next = new Set(prev);
                next.add('trial_match');
                next.add('repurposing');
                return next;
              });
            }
            if (hasConnector) {
              setVisibleInsights(prev => {
                const next = new Set(prev);
                next.add('email_decision');
                next.add('everycure_decision');
                return next;
              });
            }

            // Build dynamic insight & decision cards from backend approvals
            const approvals = data.approvals || [];
            if (approvals.length > 0) {
              const emailApprovals = approvals.filter(a => a.type === 'outreach_email');
              const otherApprovals = approvals.filter(a => a.type !== 'outreach_email');

              // First email approval becomes the decision card
              if (emailApprovals.length > 0) {
                const decCards = emailApprovals.slice(0, 4).map((a, i) => ({
                  id: a.id || `email-${i}`,
                  badge: 'Needs Your Approval', badgeColor: 'amber',
                  title: a.title,
                  subtitle: `${a.agent} agent`,
                  description: a.summary || a.content?.body?.slice(0, 150) + '...',
                  cta: 'Review & Approve',
                  approval: a,
                  whatItMeans: {
                    summary: `Your ${a.agent} agent drafted a professional outreach email to connect your family with this expert.`,
                    proceed: "You'll see the full email and can edit before sending.",
                    timeline: "Researchers typically respond within 1-2 weeks.",
                    caveat: "This is an introduction, not a commitment.",
                  },
                }));
                setLiveDecisionCards(decCards);
              }

              // Scout findings become insight cards
              const scoutFindings = (agents.scout?.updates || []).filter(u => u.type === 'finding');
              if (scoutFindings.length > 0) {
                const insCards = scoutFindings.slice(0, 2).map((f, i) => ({
                  id: i === 0 ? 'trial' : 'repurpose',
                  badge: i === 0 ? 'Clinical Trial Match' : 'Research Finding',
                  badgeColor: 'indigo',
                  title: f.message,
                  subtitle: 'Scout agent',
                  description: `Discovered by your Scout agent during live research on ${data.mission?.disease || 'your condition'}.`,
                  cta: i === 0 ? 'Start Pre-Screening' : 'Generate Specialist Briefing',
                  whatItMeans: {
                    summary: f.message,
                    proceed: "We can help you explore this finding further with your care team.",
                    timeline: "Next steps depend on your specialist's review.",
                    caveat: "All findings should be discussed with your medical team.",
                  },
                }));
                setLiveInsightCards(insCards);
              }
            }

            // Build live timeline milestones from agent findings
            const allFindings = [];
            for (const [key, agent] of Object.entries(agents)) {
              const findings = (agent.updates || []).filter(u => u.type === 'finding');
              findings.forEach(f => allFindings.push({ agent: AGENT_NAME_MAP[key] || key, message: f.message }));
            }
            if (allFindings.length > 0) {
              const icons = ['file-check', 'microscope', 'flask-conical', 'mail'];
              const colors = ['emerald', 'indigo', 'blue', 'pink'];
              const timeline = allFindings.slice(0, 6).map((f, i) => ({
                icon: icons[i % icons.length],
                color: colors[i % colors.length],
                title: f.message,
                desc: `Discovered by ${f.agent} agent`,
                major: i === 0,
              }));
              setLiveTimeline(timeline);
            }

            // Build live roadmap from agent completion status
            const disease = data.mission?.disease || 'your condition';
            const roadmapSteps = [
              { name: 'Disease Analysis', desc: hasScout ? `Research complete for ${disease}` : 'Researching...', done: hasScout, active: !hasScout },
              { name: 'Expert Identification', desc: hasConnector ? 'Outreach targets identified' : 'Searching...', done: hasConnector, active: !hasConnector && hasScout },
              { name: 'Regulatory Mapping', desc: agents.navigator?.status === 'complete' ? 'Pathways mapped' : 'Analyzing...', done: agents.navigator?.status === 'complete', active: agents.navigator?.status !== 'complete' },
              { name: 'Treatment Evaluation', desc: hasPreclinician ? 'Candidates evaluated' : (hasChemist ? 'Screening compounds...' : 'Identifying targets...'), done: hasPreclinician, active: !hasPreclinician },
              { name: 'Family Briefing', desc: allComplete ? 'Briefing ready' : 'Awaiting agent completion', done: allComplete && Object.keys(agents).length > 0 },
            ];
            setLiveRoadmap(roadmapSteps);

            // Progress bars from agent completion
            const agentCount = Object.keys(agents).length || 1;
            const completeCount = Object.values(agents).filter(a => a.status === 'complete').length;
            if (hasScout) setProgressBars(prev => ({ ...prev, Research: 100 }));
            if (agents.navigator?.status === 'complete') setProgressBars(prev => ({ ...prev, Regulatory: 100 }));
            if (hasConnector) setProgressBars(prev => ({ ...prev, Outreach: Math.max(prev.Outreach, 60) }));
            if (agents.mobilizer?.status === 'complete') setProgressBars(prev => ({ ...prev, Funding: 100 }));
            if (hasPreclinician) setProgressBars(prev => ({ ...prev, Treatment: 100 }));
            else if (hasChemist) setProgressBars(prev => ({ ...prev, Treatment: 60 }));
            else if (hasBiologist) setProgressBars(prev => ({ ...prev, Treatment: 30 }));

            // Lab ready when all 3 lab agents complete
            if (hasBiologist && hasChemist && hasPreclinician) setLabReady(true);

            // Summary text
            if (allComplete && Object.keys(agents).length > 0) {
              setSummaryText('Your plan is ready.');
              setSummaryDone(true);
            } else if (anyComplete) {
              setSummaryText(`${completeCount} of ${agentCount} agents complete...`);
            }
          } catch(e) { console.error('Poll error:', e); }
        };
        poll();
        const interval = setInterval(poll, 3000);
        return () => clearInterval(interval);
      }, [demo]);

      const toggleExpand = (name) => {
        setExpandedSections(prev => ({ ...prev, [name]: !prev[name] }));
      };

      const toggleAccordion = (id) => {
        setExpandedId(prev => prev === id ? null : id);
      };

      const handleLaterInsight = (insight) => {
        setLaterItems(prev => [...prev, insight]);
        setShowToast(insight.title);
        setTimeout(() => setShowToast(null), 2500);
      };

      const handleLaterDecision = (decision) => {
        setLaterItems(prev => [...prev, decision]);
        setShowToast(decision.title);
        setTimeout(() => setShowToast(null), 2500);
      };

      const demoApproval = {
        type: 'Outreach Email',
        title: 'Email to Dr. Jonathan Cooper \u2014 Weill Cornell',
        summary: "Personalized introduction about your family's CLN3 journey.",
        to: 'jonathan.cooper@weillcornell.edu',
        subject: "Parent of CLN3 patient \u2014 interested in your gene therapy research",
        body: "Dear Dr. Cooper,\n\nI am writing as a parent of a child recently diagnosed with CLN3 Batten Disease. I've been following your groundbreaking work on AAV9-mediated gene therapy with great interest.\n\nYour 2024 paper on intrathecal delivery showing restored CLN3 protein expression in the murine model was particularly encouraging. I would be grateful for the opportunity to discuss your research.\n\nWith hope,\n[Your name]",
        note: "Dr. Cooper leads the only active AAV9-CLN3 gene therapy program. High priority contact.",
      };

      const handleInsightAction = (insight) => {
        if (insight.id === 'trial') {
          setActionModal({ type: 'pre-screening', title: insight.title, subtitle: insight.subtitle, description: insight.description, disease: mission.disease });
        } else if (insight.id === 'repurpose') {
          setActionModal({ type: 'briefing', title: insight.title, subtitle: insight.subtitle, description: insight.description, disease: mission.disease });
        }
      };

      const handleApproveDecision = (decision) => {
        // Live mode: decision cards carry backend approval data
        if (decision.approval && decision.approval.content) {
          const a = decision.approval;
          setSelectedApproval({
            type: 'Outreach Email',
            title: a.title,
            summary: a.summary,
            to: a.content.to,
            subject: a.content.subject,
            body: a.content.body,
            note: `Drafted by ${a.agent} agent. Review and approve before sending.`,
          });
          setModalOpen(true);
          return;
        }
        // Demo mode fallbacks
        if (decision.id === 'email') {
          setSelectedApproval(demoApproval);
          setModalOpen(true);
        } else if (decision.id === 'everycure') {
          setActionModal({
            type: 'outreach',
            to: 'intake@everycure.org',
            subject: 'CLN3 Batten Disease — Drug Repurposing Consultation Request',
            body: "Dear EveryCure Team,\n\nI am the parent of a child diagnosed with CLN3 Batten Disease (Juvenile Neuronal Ceroid Lipofuscinosis). Through our research, we have identified tamoxifen as a potential repurposing candidate based on its TRPML1 activation mechanism.\n\nWe would greatly appreciate a consultation through your ROADMAP framework to help validate this pathway and identify any additional repurposing candidates we may have missed.\n\nOur child's treating neurologist is supportive of exploring off-label options and would be available for a joint call if helpful.\n\nThank you for the work you do for rare disease families.\n\nWith gratitude,\n[Your name]",
            note: "EveryCure's ROADMAP framework has identified repurposing candidates for 12,000+ diseases. Their consultation is free and typically takes 2-4 weeks."
          });
        }
      };

      // Which insight cards are visible (not later'd)
      const laterIds = laterItems.map(i => i.id);
      const insightSource = (!demo && liveInsightCards.length > 0) ? liveInsightCards : INSIGHT_CARDS;
      const activeInsightCards = insightSource.filter(c =>
        !laterIds.includes(c.id) &&
        ((c.id === 'trial' && visibleInsights.has('trial_match')) || (c.id === 'repurpose' && visibleInsights.has('repurposing')))
      );

      const showInbox = visibleInsights.has('email_decision') || visibleInsights.has('everycure_decision');

      return (
        <div className="min-h-screen flex">
          {/* Sidebar */}
          <aside className="w-20 bg-indigo-900 flex flex-col items-center py-8 gap-8 h-screen sticky top-0">
            <div className="w-10 h-10 bg-gradient-to-br from-amber-400 to-amber-500 rounded-xl flex items-center justify-center text-white font-black text-lg shadow-lg">B</div>
            <nav className="flex flex-col gap-4">
              <button onClick={() => setActiveTab('dashboard')} className={`p-3 rounded-xl ${activeTab === 'dashboard' ? 'bg-indigo-800 text-white shadow-lg' : 'text-indigo-300 hover:text-white'} transition-colors`} title="Mission Control">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="7" height="7" x="3" y="3" rx="1"/><rect width="7" height="7" x="14" y="3" rx="1"/><rect width="7" height="7" x="14" y="14" rx="1"/><rect width="7" height="7" x="3" y="14" rx="1"/></svg>
              </button>
              <button onClick={() => setActiveTab('lab')} className={`p-3 rounded-xl relative ${activeTab === 'lab' ? 'bg-indigo-800 text-white shadow-lg' : 'text-indigo-300 hover:text-white'} transition-colors`} title="Drug Discovery Lab">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10 2v7.527a2 2 0 0 1-.211.896L4.72 20.55a1 1 0 0 0 .9 1.45h12.76a1 1 0 0 0 .9-1.45l-5.069-10.127A2 2 0 0 1 14 9.527V2"/><path d="M8.5 2h7"/><path d="M7 16h10"/></svg>
                {labReady && activeTab !== 'lab' && <span className="absolute -top-1 -right-1 w-3 h-3 bg-emerald-400 rounded-full animate-ping"></span>}
                {labReady && activeTab !== 'lab' && <span className="absolute -top-1 -right-1 w-3 h-3 bg-emerald-400 rounded-full"></span>}
              </button>
              <button onClick={() => setActiveTab('community')} className={`p-3 rounded-xl ${activeTab === 'community' ? 'bg-indigo-800 text-white shadow-lg' : 'text-indigo-300 hover:text-white'} transition-colors`} title="Community & Funding">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
              </button>
            </nav>
          </aside>

          {/* Main */}
          <main className="flex-1 flex flex-col">
            {/* Header */}
            <header className="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-8 shrink-0">
              <div className="flex items-center gap-4">
                <span className="text-[11px] font-bold text-slate-400 uppercase tracking-wider">Patient:</span>
                <span className="text-sm font-bold px-3 py-1 bg-slate-100 rounded-full">{mission.disease || 'CLN3 Batten Disease'}</span>
              </div>
              <div className="flex items-center gap-4">
                <div className="flex -space-x-1.5 group/agents">
                  {Object.entries(AGENT_COLORS).map(([name, color]) => {
                    const s = agentStatuses[name];
                    const done = s?.done;
                    const statusText = s?.status || 'Waiting...';
                    return (
                      <div key={name} className="relative">
                        <div className={`w-7 h-7 rounded-full border-2 flex items-center justify-center text-[8px] font-bold transition-all ${done ? 'bg-emerald-500 border-emerald-300 text-white' : `bg-${color}-500 border-white text-white`}`}
                          title={`${name}: ${statusText}`}>
                          {done ? (
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
                          ) : name[0]}
                          {!done && s?.status && (
                            <span className="absolute -bottom-0.5 -right-0.5 w-2.5 h-2.5 bg-amber-400 rounded-full border border-white animate-pulse"></span>
                          )}
                        </div>
                        <div className="absolute top-9 left-1/2 -translate-x-1/2 bg-slate-800 text-white text-[9px] px-2 py-1.5 rounded-lg whitespace-nowrap z-50 shadow-lg max-w-[200px] transition-opacity duration-150" style={{opacity: 0, pointerEvents: 'none'}}
                          ref={el => {
                            if (!el) return;
                            const parent = el.parentElement;
                            parent.onmouseenter = () => { el.style.opacity = 1; el.style.pointerEvents = 'auto'; };
                            parent.onmouseleave = () => { el.style.opacity = 0; el.style.pointerEvents = 'none'; };
                          }}>
                          <span className="font-bold">{name}</span>
                          <span className={`ml-1.5 ${done ? 'text-emerald-300' : 'text-amber-300'}`}>{done ? 'Done' : 'Working'}</span>
                          <div className="text-slate-300 mt-0.5 truncate">{statusText.length > 50 ? statusText.slice(0, 50) + '...' : statusText}</div>
                          <div className="absolute -top-1 left-1/2 -translate-x-1/2 w-2 h-2 bg-slate-800 rotate-45"></div>
                        </div>
                      </div>
                    );
                  })}
                </div>
                <button
                  onClick={() => setShowArch(true)}
                  className="w-7 h-7 rounded-full bg-slate-100 border border-slate-200 flex items-center justify-center text-slate-400 hover:text-indigo-600 hover:bg-indigo-50 hover:border-indigo-200 transition-colors text-xs font-bold"
                  title="Architecture"
                >i</button>
              </div>
            </header>

            {/* Scrollable content */}
            <div className="flex-1 overflow-y-auto">

            {activeTab === 'dashboard' && (
              <div className="max-w-7xl mx-auto px-8 py-8 space-y-8">

                <div className="grid grid-cols-1 lg:grid-cols-5 gap-8">

                {/* Left column: Hero + Journey */}
                <div className="lg:col-span-3 space-y-8">

                  {/* ==========================================
                    SUMMARY HERO CARD
                    ========================================== */}
                <div className={`rounded-3xl p-8 border shadow-sm transition-all duration-700 ${summaryDone ? 'bg-emerald-50 border-emerald-200' : 'bg-gradient-to-r from-indigo-50 to-violet-50 border-indigo-200'}`}>
                  <div className="flex items-center gap-4 mb-3">
                    <div className={`w-12 h-12 rounded-2xl flex items-center justify-center ${summaryDone ? 'bg-emerald-500' : 'bg-indigo-600'} text-white shadow-lg`}>
                      {summaryDone ? (
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
                      ) : (
                        <div className="w-10 h-10 bg-gradient-to-br from-amber-400 to-amber-500 rounded-xl flex items-center justify-center text-white font-black text-lg">B</div>
                      )}
                    </div>
                    <div>
                      <h2 className={`text-2xl font-bold ${summaryDone ? 'text-emerald-900' : 'text-indigo-900'}`}>{summaryText}</h2>
                      <p className={`text-sm ${summaryDone ? 'text-emerald-600' : 'text-indigo-500'}`}>
                        {summaryDone ? "Here's what your team found." : `${mission.disease || 'CLN3 Batten Disease'} — your 8 agents are working`}
                        {!summaryDone && <span className="agent-pulse"> ...</span>}
                      </p>
                    </div>
                  </div>
                </div>

                {/* ==========================================
                    SECTION 1: YOUR JOURNEY
                    ========================================== */}
                <div className="bg-white rounded-3xl p-8 border border-slate-200 shadow-sm">
                  <div className="flex items-center justify-between mb-6">
                    <h2 className="text-lg font-bold flex items-center gap-2">
                      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#4f46e5" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="3 6 9 3 15 6 21 3 21 18 15 21 9 18 3 21"/><line x1="9" x2="9" y1="3" y2="18"/><line x1="15" x2="15" y1="6" y2="21"/></svg>
                      Your Journey
                    </h2>
                  </div>

                  {/* Progress bars — animated */}
                  <div className="flex gap-3 mb-6">
                    {['Research', 'Outreach', 'Regulatory', 'Funding', 'Treatment'].map((label) => {
                      const pct = progressBars[label] || 0;
                      const isComplete = progressStatus[label] === 'complete';
                      const sub = isComplete ? 'Complete' : pct > 0 ? `${pct}%` : 'Waiting...';
                      return (
                        <div key={label} className="flex-1">
                          <div className={`h-2 rounded-full mb-3 bg-slate-200 overflow-hidden`}>
                            <div className={`h-full rounded-full transition-all duration-1000 ease-out ${isComplete ? 'bg-emerald-500' : pct > 0 ? 'bg-amber-500' : ''}`} style={{ width: `${pct}%` }}></div>
                          </div>
                          <p className={`text-[10px] font-bold uppercase tracking-wider ${isComplete ? 'text-emerald-600' : pct > 0 ? 'text-amber-600' : 'text-slate-400'}`}>{label}</p>
                          <p className={`text-xs font-semibold mt-0.5 ${isComplete || pct > 0 ? 'text-slate-600' : 'text-slate-400'}`}>{sub}</p>
                        </div>
                      );
                    })}
                  </div>

                  {/* Achievement cards — stream in, max 3 visible with overflow */}
                  <div className="grid grid-cols-3 gap-2 max-h-[120px] overflow-y-auto">
                    {achievements.slice(0, 9).map((a, i) => {
                      const isBriefing = a.text.toLowerCase().includes('briefing');
                      return (
                        <div key={i} onClick={isBriefing ? () => setShowBriefing(true) : undefined}
                          className={`bg-emerald-50 rounded-xl p-2.5 border border-emerald-100 fade-up ${isBriefing ? 'cursor-pointer hover:ring-2 hover:ring-indigo-300' : ''}`}>
                          <div className="flex items-center gap-1.5 mb-0.5">
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#059669" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
                            <span className="text-[9px] font-bold text-emerald-700 uppercase">Done</span>
                          </div>
                          <p className="text-[10px] text-emerald-800 font-semibold leading-tight line-clamp-2">{a.text}</p>
                          {isBriefing && <span className="text-[8px] text-indigo-500 block">Click to view</span>}
                        </div>
                      );
                    })}
                  </div>
                  {achievements.length === 0 && (
                    <div className="bg-slate-50 rounded-xl p-3 border border-slate-100 text-center">
                      <p className="text-xs text-slate-400 font-medium">Your team is analyzing<span className="agent-pulse"> ...</span></p>
                    </div>
                  )}
                </div>

                </div>{/* end left column */}

                {/* Right column: Insights + Inbox */}
                <div className="lg:col-span-2 space-y-6">

                {/* ==========================================
                    SECTION 2: KEY INSIGHTS (Spatial Canvas)
                    ========================================== */}
                <div className="space-y-4">

                  {/* Later list indicator */}
                  {laterItems.length > 0 && (
                    <div className="flex items-center gap-3 bg-white rounded-2xl px-5 py-3 border border-slate-200 shadow-sm fade-up">
                      <div className="w-8 h-8 bg-slate-100 rounded-lg flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#64748b" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 12h-2.48a2 2 0 0 0-1.93 1.46l-2.35 8.36a.25.25 0 0 1-.48 0L9.24 2.18a.25.25 0 0 0-.48 0l-2.35 8.36A2 2 0 0 1 4.49 12H2"/></svg>
                      </div>
                      <div className="flex-1">
                        <p className="text-xs font-bold text-slate-700">Your Later List</p>
                        <p className="text-[11px] text-slate-400">{laterItems.length} item{laterItems.length !== 1 ? 's' : ''} saved — come back anytime</p>
                      </div>
                      <div className="flex gap-1 flex-wrap">
                        {laterItems.map((item, i) => (
                          <button key={i} onClick={() => {
                            if (item.id === 'email' || item.id === 'everycure') {
                              handleApproveDecision(item);
                              setLaterItems(prev => prev.filter((_, idx) => idx !== i));
                            } else {
                              setLaterItems(prev => prev.filter((_, idx) => idx !== i));
                            }
                          }} className="px-2.5 py-1 bg-indigo-100 hover:bg-indigo-200 rounded-full text-[9px] font-bold text-indigo-600 transition-colors cursor-pointer truncate max-w-[120px]" title={item.title}>{item.title || `Item ${i+1}`}</button>
                        ))}
                      </div>
                    </div>
                  )}

                  {/* Insights board */}
                  {(visibleInsights.has('trial_match') || visibleInsights.has('repurposing')) && (
                    <div className="bg-gradient-to-br from-slate-50 to-slate-100 rounded-3xl p-8 border border-slate-200">
                      <h2 className="text-lg font-bold flex items-center gap-2 mb-6">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-.9 1.5-2.2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/></svg>
                        Key Insights
                      </h2>

                      {activeInsightCards.length > 0 ? (
                        <div className="grid grid-cols-1 gap-4">
                          {activeInsightCards.map(insight => (
                            <InsightCard
                              key={insight.id}
                              insight={insight}
                              expanded={expandedId === insight.id}
                              onToggle={() => toggleAccordion(insight.id)}
                              onLater={() => handleLaterInsight(insight)}
                              onAction={handleInsightAction}
                            />
                          ))}
                        </div>
                      ) : (
                        <div className="text-center py-8">
                          <p className="text-slate-400 font-medium">All items moved to your Later list.</p>
                          <p className="text-xs text-slate-300 mt-1">Your agents will keep working and surface new findings.</p>
                        </div>
                      )}
                    </div>
                  )}

                  {/* Placeholder when nothing visible yet */}
                  {!visibleInsights.has('trial_match') && !visibleInsights.has('repurposing') && !showInbox && (
                    <div className="bg-slate-50 rounded-2xl p-8 border border-slate-200 text-center fade-in">
                      <p className="text-slate-400 font-medium">Your team is analyzing<span className="agent-pulse"> ...</span></p>
                      <p className="text-xs text-slate-300 mt-1">Insights will appear here as your agents make discoveries</p>
                    </div>
                  )}

                  {/* Delegation Inbox */}
                  {showInbox && (
                    <div className="bg-gradient-to-br from-amber-50/50 to-slate-50 rounded-3xl p-8 border border-amber-200/50">
                      <DelegationInbox
                        expandedId={expandedId}
                        onToggle={toggleAccordion}
                        onApprove={handleApproveDecision}
                        onLater={handleLaterDecision}
                        cards={(!demo && liveDecisionCards.length > 0) ? liveDecisionCards : null}
                      />
                    </div>
                  )}
                </div>

                </div>{/* end right column */}
                </div>{/* end grid */}

                {/* ==========================================
                    SECTION 3: DETAILED VIEW (Expandable)
                    ========================================== */}
                <div className="border border-slate-200 rounded-3xl bg-white shadow-sm overflow-hidden">
                  <button onClick={() => toggleExpand('detail')} className="w-full flex items-center justify-between px-8 py-5 hover:bg-slate-50 transition-colors">
                    <h2 className="text-lg font-bold flex items-center gap-2">
                      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#64748b" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12.83 2.18a2 2 0 0 0-1.66 0L2.6 6.08a1 1 0 0 0 0 1.83l8.58 3.91a2 2 0 0 0 1.66 0l8.58-3.9a1 1 0 0 0 0-1.83Z"/><path d="m22 17.65-9.17 4.16a2 2 0 0 1-1.66 0L2 17.65"/><path d="m22 12.65-9.17 4.16a2 2 0 0 1-1.66 0L2 12.65"/></svg>
                      Detailed View
                      <span className="text-xs font-medium text-slate-400 ml-2">Agent activity, timeline, repurposing tracker</span>
                    </h2>
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#94a3b8" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={`chevron-icon ${expandedSections.detail ? 'rotated' : ''}`}><path d="m6 9 6 6 6-6"/></svg>
                  </button>

                  <div data-expand-target="detail" className={expandedSections.detail ? 'open' : ''}>
                    <div className="px-8 pb-8 grid grid-cols-12 gap-8 border-t border-slate-100 pt-6">

                      {/* Left: Living Timeline */}
                      <div className="col-span-7 space-y-6">
                        <div className="flex items-center justify-between">
                          <h3 className="text-base font-bold flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#4f46e5" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M12 7v5l4 2"/></svg>
                            Mission Timeline
                          </h3>
                          <span className="text-[11px] text-slate-400">Updated 2 min ago</span>
                        </div>

                        <div className="relative pl-10 timeline-line space-y-8">
                          {((!demo && liveTimeline.length > 0) ? liveTimeline : TIMELINE_MILESTONES).map((m, i) => (
                            <div key={i} className="relative">
                              <div className={`absolute -left-[30px] w-10 h-10 ${m.major ? `bg-${m.color}-600 text-white shadow-lg shadow-${m.color}-200` : `bg-white border-2 border-${m.color}-500 text-${m.color}-500`} rounded-full flex items-center justify-center z-10`}>
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                  {m.icon === 'file-check' && <><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="m9 15 2 2 4-4"/></>}
                                  {m.icon === 'microscope' && <><path d="M6 18h8"/><path d="M3 22h18"/><path d="M14 22a7 7 0 1 0 0-14h-1"/><path d="M9 14h2"/><path d="M9 12a2 2 0 0 1-2-2V6h6v4a2 2 0 0 1-2 2Z"/></>}
                                  {m.icon === 'flask-conical' && <><path d="M10 2v7.527a2 2 0 0 1-.211.896L4.72 20.55a1 1 0 0 0 .9 1.45h12.76a1 1 0 0 0 .9-1.45l-5.069-10.127A2 2 0 0 1 14 9.527V2"/><path d="M8.5 2h7"/><path d="M7 16h10"/></>}
                                  {m.icon === 'mail' && <><rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></>}
                                </svg>
                              </div>
                              <div className={`${m.major ? 'bg-indigo-50 border-2 border-indigo-200' : 'bg-white border border-slate-200'} p-5 rounded-2xl`}>
                                <div className="flex justify-between items-start mb-1">
                                  <h4 className={`font-bold text-sm ${m.major ? 'text-indigo-900' : 'text-slate-800'}`}>{m.title}</h4>
                                  {m.major && <span className="bg-indigo-600 text-white text-[8px] font-black px-2 py-0.5 rounded uppercase">Major</span>}
                                  {m.pending && <span className="bg-amber-100 text-amber-700 text-[8px] font-black px-1.5 py-0.5 rounded uppercase">Pending</span>}
                                </div>
                                <p className="text-[11px] text-slate-500">{m.desc}</p>
                                {m.stats && (
                                  <div className="grid grid-cols-2 gap-2 mt-3">
                                    {m.stats.map((s, j) => (
                                      <div key={j} className="bg-slate-50 p-2.5 rounded-lg border border-slate-100">
                                        <span className="text-[9px] font-bold text-slate-400 uppercase">{s.label}</span>
                                        <p className="text-xs font-semibold">{s.value}</p>
                                      </div>
                                    ))}
                                  </div>
                                )}
                                {m.major && (
                                  <div className="space-y-2 border-l-2 border-indigo-200 pl-3 py-1 text-xs mt-3">
                                    {(demo ? REPURPOSING_DEMO_DATA.council.slice(0, 3) : Object.entries(agentStatuses).filter(([,s]) => s.done).slice(0, 3).map(([name, s]) => ({ agent: name, text: s.status }))).map((msg, j) => (
                                      <div key={j} className="flex gap-2">
                                        <span className={`font-bold text-${AGENT_COLORS[msg.agent] || 'slate'}-600 uppercase w-16 shrink-0 text-[9px]`}>{msg.agent}</span>
                                        <p className="text-slate-600">"{(msg.text || '').substring(0, 80)}{msg.text && msg.text.length > 80 ? '...' : ''}"</p>
                                      </div>
                                    ))}
                                  </div>
                                )}
                              </div>
                            </div>
                          ))}
                        </div>
                      </div>

                      {/* Right: ROADMAP + Team Status */}
                      <div className="col-span-5 space-y-6">

                        {/* ROADMAP Tracker */}
                        <div className="bg-white p-5 rounded-2xl border border-slate-200">
                          <h4 className="font-bold text-sm mb-1 flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#4f46e5" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m10.5 20.5 10-10a4.95 4.95 0 1 0-7-7l-10 10a4.95 4.95 0 1 0 7 7Z"/><path d="m8.5 8.5 7 7"/></svg>
                            {demo ? 'Repurposing ROADMAP' : 'Mission Progress'}
                          </h4>
                          <p className="text-[10px] text-slate-400 mb-4">{demo ? 'EveryCure Framework' : `${mission.disease || 'Disease'} Research Pipeline`}</p>

                          <div className="space-y-3 relative">
                            <div className="absolute left-[11px] top-2 bottom-2 w-0.5 bg-slate-200"></div>
                            {((!demo && liveRoadmap.length > 0) ? liveRoadmap : REPURPOSING_DEMO_DATA.steps).map((s, i) => (
                              <div key={i} className={`flex items-start gap-3 relative ${!s.done && !s.active ? 'opacity-40' : ''}`}>
                                {s.done ? (
                                  <div className="w-6 h-6 rounded-full bg-emerald-500 flex items-center justify-center z-10 shrink-0">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
                                  </div>
                                ) : s.active ? (
                                  <div className="w-6 h-6 rounded-full bg-amber-500 flex items-center justify-center z-10 shrink-0 ring-2 ring-amber-200">
                                    <span className="text-[9px] font-black text-white">{i + 1}</span>
                                  </div>
                                ) : (
                                  <div className="w-6 h-6 rounded-full bg-slate-200 flex items-center justify-center z-10 shrink-0">
                                    <span className="text-[9px] font-bold text-slate-400">{i + 1}</span>
                                  </div>
                                )}
                                <div>
                                  <p className={`text-[11px] font-bold ${s.active ? 'text-amber-700' : s.done ? 'text-slate-700' : 'text-slate-500'}`}>{s.name}</p>
                                  {s.desc && <p className={`text-[10px] ${s.active ? 'text-amber-600' : 'text-slate-400'}`}>{s.desc}</p>}
                                </div>
                              </div>
                            ))}
                          </div>

                          {(() => {
                            const leadCandidate = livePlan?.knowledge?.chemist?.repurposing_candidates?.[0];
                            if (!leadCandidate) return null;
                            return (
                              <div className="mt-4 p-3 bg-emerald-50 rounded-xl border border-emerald-100">
                                <div className="flex items-center gap-2 mb-0.5">
                                  <span className="bg-emerald-600 text-white text-[8px] font-black px-1.5 py-0.5 rounded uppercase">Lead</span>
                                  <span className="text-xs font-bold text-emerald-900">{leadCandidate.name}</span>
                                </div>
                                <p className="text-[10px] text-emerald-700">
                                  {[leadCandidate.mechanism || leadCandidate.moa, leadCandidate.fda_approved || leadCandidate.max_phase === 4 ? 'FDA-approved' : null].filter(Boolean).join(' · ') || 'Repurposing candidate'}
                                </p>
                              </div>
                            );
                          })()}
                        </div>

                        {/* Team Status */}
                        <div className="bg-white p-5 rounded-2xl border border-slate-200">
                          <h4 className="font-bold text-sm mb-4 flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#64748b" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                            Your Team
                          </h4>
                          <div className="space-y-2.5">
                            {Object.entries(agentStatuses).map(([name, a]) => (
                              <div key={name} className="flex items-center gap-3">
                                <div className={`w-2 h-2 rounded-full ${a.done ? 'bg-emerald-500' : 'bg-amber-500 agent-pulse'}`}></div>
                                <span className="text-[11px] font-bold text-slate-700 w-20">{name}</span>
                                <span className="text-[11px] text-slate-400">{a.status}</span>
                              </div>
                            ))}
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

              </div>
            )}

            {activeTab === 'lab' && <LabTab labReady={labReady} livePlan={!demo ? livePlan : null} mission={mission} />}

            {activeTab === 'community' && <CommunityTab setActiveTab={setActiveTab} />}

            </div>
          </main>

          {showBriefing && (
            <div className="modal-overlay" onClick={() => setShowBriefing(false)}>
              <div className="modal" onClick={e => e.stopPropagation()} style={{maxWidth: '700px', maxHeight: '80vh', overflow: 'auto'}}>
                <div className="flex justify-between items-center mb-6">
                  <div>
                    <span className="bg-violet-100 text-violet-700 text-[10px] font-black px-2 py-0.5 rounded uppercase">Strategist Briefing</span>
                    <h2 className="text-xl font-bold mt-2">Family Briefing: {mission.disease || 'Your Condition'}</h2>
                  </div>
                  <button onClick={() => setShowBriefing(false)} className="text-slate-400 hover:text-slate-800 text-2xl leading-none">&times;</button>
                </div>
                <div className="bg-slate-50 border border-slate-200 rounded-xl p-5 max-h-[60vh] overflow-y-auto">
                  {state?.synthesis?.result ? (
                    <div className="prose prose-sm max-w-none text-slate-700" dangerouslySetInnerHTML={{__html: state.synthesis.result.replace(/\n/g, '<br/>').replace(/#{1,3}\s(.+)/g, '<strong>$1</strong>').replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')}} />
                  ) : livePlan?.knowledge?.strategist ? (
                    <div className="space-y-4 text-sm text-slate-700">
                      {livePlan.knowledge.strategist.roadmap && (
                        <div>
                          <h3 className="font-bold text-indigo-700 mb-1">Current Phase</h3>
                          <p>{livePlan.knowledge.strategist.roadmap.currentPhase}</p>
                          <p className="text-xs text-slate-500 mt-1">Next: {livePlan.knowledge.strategist.roadmap.nextMilestone}</p>
                          <p className="text-xs text-slate-500">Timeline: {livePlan.knowledge.strategist.roadmap.estimatedTimeline}</p>
                        </div>
                      )}
                      {livePlan.knowledge.strategist.priorities?.map((p, i) => (
                        <div key={i} className="bg-white p-3 rounded-lg border border-slate-200">
                          <div className="flex items-center gap-2 mb-1">
                            <span className="bg-indigo-100 text-indigo-700 text-[9px] font-bold px-1.5 py-0.5 rounded">Priority {p.priority}</span>
                            <span className="font-semibold text-sm">{p.action}</span>
                          </div>
                          {p.rationale && <p className="text-xs text-slate-500">{p.rationale}</p>}
                          {p.timeline && <p className="text-xs text-slate-400 mt-1">{p.timeline}</p>}
                        </div>
                      ))}
                    </div>
                  ) : (
                    <p className="text-slate-400 text-center py-8">Briefing is being prepared...</p>
                  )}
                </div>
              </div>
            </div>
          )}

          {actionModal && (
            <ActionModal action={actionModal} onClose={() => setActionModal(null)} />
          )}

          {showArch && (
            <div className="fixed inset-0 z-50 flex items-center justify-center" style={{ backdropFilter: 'blur(8px)', WebkitBackdropFilter: 'blur(8px)', background: 'rgba(15, 23, 42, 0.6)' }} onClick={() => setShowArch(false)}>
              <div className="bg-white/95 rounded-3xl shadow-2xl border border-slate-200 p-8 max-w-lg w-[90%] fade-up" onClick={e => e.stopPropagation()}>
                <div className="flex justify-between items-start mb-6">
                  <h3 className="font-bold text-lg text-slate-800 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#6366f1" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M3 9h18"/><path d="M9 21V9"/></svg>
                    Built with Claude Code + Opus 4.6
                  </h3>
                  <button onClick={() => setShowArch(false)} className="text-slate-400 hover:text-slate-800 text-xl leading-none">&times;</button>
                </div>

                <div className="flex items-center justify-center gap-3 mb-6">
                  <div className="bg-gradient-to-br from-indigo-500 to-indigo-600 text-white font-bold px-4 py-2 rounded-xl text-sm shadow-lg">React Frontend</div>
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#a5b4fc" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
                  <div className="bg-gradient-to-br from-violet-500 to-violet-600 text-white font-bold px-4 py-2 rounded-xl text-sm shadow-lg">FastAPI Backend</div>
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#a5b4fc" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
                  <div className="bg-gradient-to-br from-amber-500 to-amber-600 text-white font-bold px-4 py-2 rounded-xl text-sm shadow-lg">8 Agents</div>
                </div>

                <div className="mb-5">
                  <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">Opus 4.6 Agents</p>
                  <div className="flex flex-wrap gap-1.5">
                    {Object.entries(AGENT_COLORS).map(([name, color]) => (
                      <span key={name} className={`text-[10px] font-bold px-3 py-1 rounded-full bg-${color}-100 text-${color}-700 border border-${color}-200`}>{name}</span>
                    ))}
                  </div>
                </div>

                <div className="mb-5">
                  <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">MCP Connectors</p>
                  <div className="flex flex-wrap gap-1.5">
                    {['ClinicalTrials.gov', 'ChEMBL', 'PubMed', 'bioRxiv', 'Open Targets', 'NPI Registry'].map(c => (
                      <span key={c} className="text-[10px] font-semibold px-3 py-1 rounded-full bg-emerald-100 text-emerald-700 border border-emerald-200">{c}</span>
                    ))}
                  </div>
                </div>

                <div className="bg-gradient-to-r from-indigo-50 to-violet-50 rounded-xl p-4 border border-indigo-100">
                  <p className="text-[10px] font-black text-indigo-400 uppercase tracking-widest mb-2">Why Opus 4.6</p>
                  <div className="flex gap-4 text-xs text-indigo-700 font-medium">
                    <div className="flex items-center gap-1.5">
                      <div className="w-2 h-2 rounded-full bg-indigo-400"></div>
                      2x computational biology
                    </div>
                    <div className="flex items-center gap-1.5">
                      <div className="w-2 h-2 rounded-full bg-violet-400"></div>
                      1M token context
                    </div>
                    <div className="flex items-center gap-1.5">
                      <div className="w-2 h-2 rounded-full bg-amber-400"></div>
                      BrowseComp #1
                    </div>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* Toast notification */}
          {showToast && (
            <div className="fixed bottom-6 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-5 py-3 rounded-2xl shadow-2xl flex items-center gap-3 fade-up z-50">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#818cf8" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
              <span className="text-sm font-medium">"{showToast}" saved to Later</span>
            </div>
          )}
        </div>
      );
    }

    // ==========================================
    // LAB TAB
    // ==========================================

    function LabTab({ labReady, livePlan, mission }) {
      const [selectedTarget, setSelectedTarget] = useState(0);
      const [selectedCandidate, setSelectedCandidate] = useState(null);
      const [viewerMode, setViewerMode] = useState('target'); // 'target' | 'candidate'
      const viewerInstanceRef = useRef(null);
      const [pdbLoaded, setPdbLoaded] = useState(false);
      const [labSection, setLabSection] = useState('overview'); // 'overview' | 'candidates' | 'experiments'
      const [labSummary, setLabSummary] = useState(null);
      const [croModal, setCroModal] = useState(null);
      const [researcherBriefing, setResearcherBriefing] = useState(null);
      const [showResearcherBriefing, setShowResearcherBriefing] = useState(false);
      const [summaryExpanded, setSummaryExpanded] = useState(false);
      const summaryFetched = useRef(false);

      useEffect(() => {
        if (!livePlan || summaryFetched.current) return;
        summaryFetched.current = true;
        fetch(`${BACKEND_URL}/api/lab-summary`).then(r => r.json()).then(d => {
          if (d.status === 'complete') setLabSummary(d.result);
          else if (d.status === 'generating' || d.status === 'waiting') {
            // Poll until ready
            const iv = setInterval(() => {
              fetch(`${BACKEND_URL}/api/lab-summary`).then(r => r.json()).then(d2 => {
                if (d2.status === 'complete') { setLabSummary(d2.result); clearInterval(iv); }
              }).catch(() => {});
            }, 5000);
            setTimeout(() => clearInterval(iv), 60000);
          }
        }).catch(() => {});
        fetch(`${BACKEND_URL}/api/researcher-briefing`).then(r => r.json()).then(d => {
          if (d.status === 'complete') setResearcherBriefing(d.result);
          else if (d.status === 'generating' || d.status === 'waiting') {
            const iv = setInterval(() => {
              fetch(`${BACKEND_URL}/api/researcher-briefing`).then(r => r.json()).then(d2 => {
                if (d2.status === 'complete') { setResearcherBriefing(d2.result); clearInterval(iv); }
              }).catch(() => {});
            }, 5000);
            setTimeout(() => clearInterval(iv), 60000);
          }
        }).catch(() => {});
      }, [livePlan]);

      const liveTargets = useMemo(() => {
        if (!livePlan) return null;
        const bio = livePlan.knowledge?.biologist?.targets || [];
        return bio.slice(0, 5).map(t => ({
          name: t.name || 'Unknown Target',
          gene: t.gene || '',
          uniprot_id: t.uniprot_id || '',
          function: t.function || t.disease_role || '',
          druggability_score: t.druggability_score || 0.5,
          genetic_evidence: t.genetic_evidence || 0.5,
          pathway: t.pathway || '',
          rationale: t.rationale || t.disease_role || '',
          pdb_file: (() => {
            const raw = t.alphafold_pdb_url || t.pdb_file;
            if (raw) return raw.replace(/model_v\d+/, 'model_v6');
            if (t.uniprot_id) return `https://alphafold.ebi.ac.uk/files/AF-${t.uniprot_id}-F1-model_v6.pdb`;
            return null;
          })(),
        }));
      }, [livePlan]);

      const liveCandidates = useMemo(() => {
        if (!livePlan) return null;
        const chem = livePlan.knowledge?.chemist?.repurposing_candidates || [];
        const prec = livePlan.knowledge?.preclinician?.candidate_evaluations || [];
        const precMap = {};
        prec.forEach(p => { precMap[(p.name || '').toLowerCase()] = p; });

        return chem.slice(0, 6).map(c => {
          const evaluation = precMap[(c.name || '').toLowerCase()];
          const scores = evaluation?.scores || {};
          return {
            name: c.name || 'Unknown',
            chembl_id: c.chembl_id || '',
            smiles: c.smiles || '',
            target: c.target || '',
            pchembl: c.pchembl_value || c.pchembl || 0,
            mechanism: c.mechanism || c.moa || '',
            fda_approved: c.fda_approved || (c.max_phase === 4),
            max_phase: c.max_phase || 0,
            indication: c.indication || '',
            evidence: c.evidence || '',
            scores: {
              efficacy: { val: scores.efficacy?.value || `pChEMBL ${c.pchembl_value || '?'}`, rating: scores.efficacy?.rating || 'amber' },
              oral_absorption: { val: scores.oral_bioavailability?.value || 'Unknown', rating: scores.oral_bioavailability?.rating || 'amber' },
              cns_penetration: { val: scores.cns_penetration?.value || 'Unknown', rating: scores.cns_penetration?.rating || 'amber' },
              herg: { val: scores.herg?.value || 'Unknown', rating: scores.herg?.rating || 'amber' },
              cyp_inhibition: { val: scores.cyp_inhibition?.value || 'Unknown', rating: scores.cyp_inhibition?.rating || 'amber' },
              solubility: { val: scores.solubility?.value || 'Unknown', rating: scores.solubility?.rating || 'amber' },
              selectivity: { val: scores.selectivity?.value || 'Unknown', rating: scores.selectivity?.rating || 'amber' },
              synthetic_access: { val: scores.synthetic_access?.value || 'Unknown', rating: scores.synthetic_access?.rating || 'amber' },
            },
            overall: evaluation?.overall_recommendation?.includes('Advance') || evaluation?.overall_recommendation?.includes('First-line') ? 'green' : evaluation?.overall_recommendation?.includes('Deprioritize') || evaluation?.overall_recommendation?.includes('Not recommended') ? 'red' : 'amber',
            recommendation: evaluation?.overall_recommendation || c.recommendation || '',
          };
        });
      }, [livePlan]);

      const targets = liveTargets || LAB_TARGETS;
      const candidates = liveCandidates || LAB_CANDIDATES;
      const croContacts = useMemo(() => buildCroContacts(mission?.disease, targets, candidates), [mission?.disease, targets, candidates]);

      const doLoadPdb = async (viewer, target) => {
        const renderPdb = (pdb) => {
          viewer.addModel(pdb, 'pdb');
          viewer.setStyle({}, { cartoon: { color: 'spectrum' } });
          viewer.zoomTo();
          viewer.render();
          viewer.spin('y', 0.5);
          setPdbLoaded(true);
        };
        const tryFetch = async (url) => {
          const resp = await fetch(url);
          if (!resp.ok) throw new Error('HTTP ' + resp.status);
          const pdb = await resp.text();
          if (!pdb || pdb.length < 100) throw new Error('Empty PDB');
          return pdb;
        };
        try {
          // Try direct URL first
          const pdb = await tryFetch(target.pdb_file);
          renderPdb(pdb);
        } catch (e) {
          console.warn('Direct PDB failed:', e.message, '- trying AlphaFold API lookup');
          try {
            // Fallback: query AlphaFold API for correct URL using uniprot_id
            if (target.uniprot_id) {
              const apiResp = await fetch(`https://alphafold.ebi.ac.uk/api/prediction/${target.uniprot_id}`);
              if (apiResp.ok) {
                const data = await apiResp.json();
                const entry = data[0];
                if (entry) {
                  const pdbUrl = `https://alphafold.ebi.ac.uk/files/AF-${entry.uniprotAccession}-F1-model_v${entry.latestVersion}.pdb`;
                  const pdb = await tryFetch(pdbUrl);
                  renderPdb(pdb);
                  return;
                }
              }
            }
            throw new Error('API fallback failed');
          } catch (e2) {
            console.error('All PDB load attempts failed:', e2, 'for', target.name);
            viewer.addSphere({ center: { x: 0, y: 0, z: 0 }, radius: 10, color: '0x6366f1', alpha: 0.5 });
            viewer.addLabel(target.name, { position: { x: 0, y: 12, z: 0 }, fontSize: 14, backgroundColor: '0x6366f1', fontColor: 'white' });
            viewer.zoomTo();
            viewer.render();
            setPdbLoaded(true);
          }
        }
      };

      // Callback ref: creates a child div for 3Dmol so React never touches its DOM
      const viewerContainerRef = useRef(null);
      const viewerRefCallback = useCallback((node) => {
        if (!node) return;
        viewerContainerRef.current = node;
        // Create a child div that 3Dmol owns — React won't manage it
        const molDiv = document.createElement('div');
        molDiv.style.cssText = 'width:100%;height:100%;position:absolute;top:0;left:0;';
        node.appendChild(molDiv);
        // Destroy previous viewer
        if (viewerInstanceRef.current) {
          try { viewerInstanceRef.current.clear(); } catch(e) {}
        }
        const viewer = $3Dmol.createViewer(molDiv, {
          backgroundColor: 'white',
          antialias: true,
        });
        viewerInstanceRef.current = viewer;
        setPdbLoaded(false);
        if (targets[selectedTarget]?.pdb_file) doLoadPdb(viewer, targets[selectedTarget]);
      }, []);

      const handleTargetSelect = (idx) => {
        setSelectedTarget(idx);
        setViewerMode('target');
        const viewer = viewerInstanceRef.current;
        if (viewer) {
          setPdbLoaded(false);
          viewer.removeAllModels();
          viewer.removeAllLabels();
          viewer.removeAllShapes();
          if (targets[idx]?.pdb_file) doLoadPdb(viewer, targets[idx]);
        }
      };

      const ratingColor = (r) => r === 'green' ? 'emerald' : r === 'amber' ? 'amber' : 'red';
      const ratingBg = (r) => r === 'green' ? 'bg-emerald-100 text-emerald-700' : r === 'amber' ? 'bg-amber-100 text-amber-700' : 'bg-red-100 text-red-700';
      const ratingDot = (r) => r === 'green' ? 'bg-emerald-500' : r === 'amber' ? 'bg-amber-500' : 'bg-red-500';

      // Guard: if no targets available yet, show loading state
      if (!targets || targets.length === 0) {
        return (
          <div className="max-w-7xl mx-auto px-8 py-8">
            <div className="bg-gradient-to-r from-cyan-50 via-indigo-50 to-violet-50 rounded-3xl p-8 border border-indigo-200 shadow-sm text-center">
              <div className="w-12 h-12 border-4 border-indigo-200 border-t-indigo-600 rounded-full animate-spin mx-auto mb-4"></div>
              <h2 className="text-xl font-bold text-indigo-900 mb-2">Drug Discovery Lab</h2>
              <p className="text-sm text-indigo-500">Lab agents are analyzing disease targets... This may take a minute.</p>
            </div>
          </div>
        );
      }

      return (<React.Fragment>
        <div className="max-w-7xl mx-auto px-8 py-8 space-y-8">

          {/* Lab Header */}
          <div className="bg-gradient-to-r from-cyan-50 via-indigo-50 to-violet-50 rounded-3xl p-8 border border-indigo-200 shadow-sm">
            <div className="flex items-center gap-4 mb-2">
              <div className="w-12 h-12 rounded-2xl bg-gradient-to-br from-cyan-500 to-indigo-600 flex items-center justify-center text-white shadow-lg">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10 2v7.527a2 2 0 0 1-.211.896L4.72 20.55a1 1 0 0 0 .9 1.45h12.76a1 1 0 0 0 .9-1.45l-5.069-10.127A2 2 0 0 1 14 9.527V2"/><path d="M8.5 2h7"/><path d="M7 16h10"/></svg>
              </div>
              <div>
                <h2 className="text-2xl font-bold text-indigo-900">Drug Discovery Lab</h2>
                <p className="text-sm text-indigo-500">Biologist + Chemist + Preclinician working on your targets</p>
              </div>
            </div>

            {/* Sub-nav */}
            <div className="flex gap-2 mt-4">
              {[{id:'overview',label:'Overview & Targets'},{id:'candidates',label:'Candidate Pipeline'},{id:'experiments',label:'Lab Testing'}].map(tab => (
                <button key={tab.id} onClick={() => setLabSection(tab.id)}
                  className={`px-4 py-2 rounded-xl text-xs font-bold transition-all ${labSection === tab.id ? 'bg-indigo-600 text-white shadow-md' : 'bg-white/70 text-indigo-600 hover:bg-white'}`}>
                  {tab.label}
                </button>
              ))}
            </div>
          </div>

          {/* OVERVIEW SECTION */}
          {labSection === 'overview' && (
            <div className="space-y-6">

            {/* Agent Progress Bar */}
            {livePlan && (() => {
              const hasBio = (livePlan.knowledge?.biologist?.targets || []).length > 0;
              const hasChem = (livePlan.knowledge?.chemist?.repurposing_candidates || []).length > 0;
              const hasPrec = (livePlan.knowledge?.preclinician?.candidate_evaluations || []).length > 0;
              const done = [hasBio, hasChem, hasPrec].filter(Boolean).length;
              if (done === 3) return null;
              return (
                <div className="bg-white/80 backdrop-blur rounded-2xl p-4 border border-indigo-100 flex items-center gap-4">
                  <div className="w-8 h-8 border-3 border-indigo-200 border-t-indigo-600 rounded-full animate-spin flex-shrink-0"></div>
                  <div className="flex-1">
                    <div className="text-sm font-bold text-indigo-900 mb-1">Lab agents working... ({done}/3 complete)</div>
                    <div className="flex gap-3">
                      {[{name:'Biologist',ok:hasBio},{name:'Chemist',ok:hasChem},{name:'Preclinician',ok:hasPrec}].map(a => (
                        <span key={a.name} className={`text-[11px] font-bold px-2 py-0.5 rounded-full ${a.ok ? 'bg-emerald-100 text-emerald-700' : 'bg-slate-100 text-slate-400'}`}>
                          {a.ok ? '✓' : '⏳'} {a.name}
                        </span>
                      ))}
                    </div>
                  </div>
                </div>
              );
            })()}

            {/* Family Summary */}
            {(livePlan) && (
              <div className="bg-gradient-to-r from-indigo-50 to-violet-50 rounded-3xl p-6 border border-indigo-200 shadow-sm">
                <div className="flex items-start justify-between mb-3">
                  <div className="flex items-center gap-3">
                    <div className="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center text-white shadow-lg">
                      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="m9 15 2 2 4-4"/></svg>
                    </div>
                    <div>
                      <h3 className="font-bold text-indigo-900">What Our Lab Team Found</h3>
                      <p className="text-[11px] text-indigo-500">AI-generated summary for your family</p>
                    </div>
                  </div>
                  {researcherBriefing && (
                    <button onClick={() => setShowResearcherBriefing(true)}
                      className="px-3 py-1.5 bg-white border border-indigo-200 rounded-lg text-[11px] font-bold text-indigo-600 hover:bg-indigo-100 transition-colors flex items-center gap-1.5">
                      <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" x2="12" y1="2" y2="15"/></svg>
                      Researcher Briefing
                    </button>
                  )}
                </div>
                {labSummary ? (() => {
                  const sentences = labSummary.split(/(?<=\.)\s+/);
                  const tldr = sentences.slice(0, 2).join(' ');
                  const hasMore = sentences.length > 2;
                  return (
                    <div>
                      <div className="text-sm text-slate-700 leading-relaxed whitespace-pre-line">
                        {summaryExpanded ? labSummary : tldr}
                      </div>
                      {hasMore && (
                        <button onClick={() => setSummaryExpanded(!summaryExpanded)}
                          className="mt-2 text-[11px] font-bold text-indigo-600 hover:text-indigo-800 transition-colors">
                          {summaryExpanded ? '▲ Show less' : '▼ Read more'}
                        </button>
                      )}
                    </div>
                  );
                })() : (
                  <div className="flex items-center gap-2 text-sm text-indigo-400">
                    <div className="w-4 h-4 border-2 border-indigo-300 border-t-transparent rounded-full animate-spin"></div>
                    Generating family-friendly summary...
                  </div>
                )}
              </div>
            )}

            {/* Researcher Briefing Modal */}
            {showResearcherBriefing && researcherBriefing && (
              <div className="modal-overlay" onClick={() => setShowResearcherBriefing(false)}>
                <div className="modal" onClick={e => e.stopPropagation()} style={{maxWidth: '750px', maxHeight: '85vh'}}>
                  <div className="flex justify-between items-center mb-4">
                    <div>
                      <span className="bg-violet-100 text-violet-700 text-[10px] font-black px-2 py-0.5 rounded uppercase">Researcher Briefing</span>
                      <h2 className="text-lg font-bold mt-1.5">Forward to Your Specialist</h2>
                      <p className="text-[11px] text-slate-400">Technical briefing suitable for researchers and physicians</p>
                    </div>
                    <button onClick={() => setShowResearcherBriefing(false)} className="text-slate-400 hover:text-slate-800 text-2xl leading-none">&times;</button>
                  </div>
                  <div className="bg-slate-50 border border-slate-200 rounded-xl p-5 mb-4 max-h-[55vh] overflow-y-auto">
                    <pre className="text-xs text-slate-700 whitespace-pre-wrap font-mono leading-relaxed">{researcherBriefing}</pre>
                  </div>
                  <div className="flex gap-3">
                    <button onClick={() => { navigator.clipboard.writeText(researcherBriefing); }}
                      className="px-5 py-2.5 bg-indigo-600 text-white rounded-xl font-bold text-sm hover:bg-indigo-700 transition-colors shadow-md flex items-center gap-2">
                      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>
                      Copy to Clipboard
                    </button>
                    <button onClick={() => {
                        const blob = new Blob([researcherBriefing], { type: 'text/plain' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a'); a.href = url; a.download = 'researcher-briefing.txt'; a.click();
                        URL.revokeObjectURL(url);
                      }}
                      className="px-5 py-2.5 bg-emerald-500 text-white rounded-xl font-bold text-sm hover:bg-emerald-600 transition-colors shadow-md flex items-center gap-2">
                      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
                      Download
                    </button>
                    <button onClick={() => setShowResearcherBriefing(false)} className="px-5 py-2.5 bg-slate-200 text-slate-700 rounded-xl font-bold text-sm hover:bg-slate-300 transition-colors">Cancel</button>
                  </div>
                </div>
              </div>
            )}

            <div className="grid grid-cols-12 gap-8">

              {/* 3D Viewer */}
              <div className="col-span-7 bg-white rounded-3xl border border-slate-200 shadow-sm overflow-hidden">
                <div className="px-6 py-4 border-b border-slate-100 flex items-center justify-between">
                  <div>
                    <h3 className="font-bold text-slate-800">Protein Target: {targets[selectedTarget].name}</h3>
                    <p className="text-[11px] text-slate-400">{targets[selectedTarget].gene} — AlphaFold predicted structure</p>
                  </div>
                  <div className="flex gap-2">
                    <button onClick={() => { const v = viewerInstanceRef.current; if(v){v.setStyle({},{cartoon:{color:'spectrum'}}); v.render();} }} className="px-3 py-1.5 text-[10px] font-bold rounded-lg bg-indigo-50 text-indigo-600 hover:bg-indigo-100">Cartoon</button>
                    <button onClick={() => { const v = viewerInstanceRef.current; if(v){v.setStyle({},{stick:{colorscheme:'Jmol'}}); v.render();} }} className="px-3 py-1.5 text-[10px] font-bold rounded-lg bg-slate-50 text-slate-600 hover:bg-slate-100">Stick</button>
                    <button onClick={() => { const v = viewerInstanceRef.current; if(v){v.setStyle({},{surface:{opacity:0.8,color:'white'}}); v.render();} }} className="px-3 py-1.5 text-[10px] font-bold rounded-lg bg-slate-50 text-slate-600 hover:bg-slate-100">Surface</button>
                  </div>
                </div>
                <div style={{ width: '100%', height: '420px', position: 'relative' }}>
                  <div ref={viewerRefCallback} style={{ width: '100%', height: '100%' }}></div>
                  {!pdbLoaded && (
                    <div className="absolute inset-0 flex items-center justify-center bg-slate-50 z-10">
                      <div className="text-center">
                        <div className="w-10 h-10 border-4 border-indigo-200 border-t-indigo-600 rounded-full animate-spin mx-auto mb-3"></div>
                        <p className="text-xs text-slate-400 font-medium">Preparing 3D protein structure...</p>
                      </div>
                    </div>
                  )}
                </div>
              </div>

              {/* Target List + Pipeline Funnel */}
              <div className="col-span-5 space-y-6">

                {/* Target selector */}
                <div className="bg-white rounded-3xl p-6 border border-slate-200 shadow-sm">
                  <h4 className="font-bold text-sm mb-4 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#06b6d4" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>
                    Therapeutic Targets ({targets.length})
                  </h4>
                  <div className="space-y-2">
                    {targets.map((t, i) => (
                      <button key={i} onClick={() => handleTargetSelect(i)}
                        className={`w-full text-left p-3 rounded-2xl border-2 transition-all ${selectedTarget === i ? 'border-indigo-500 bg-indigo-50' : 'border-slate-100 hover:border-slate-300'}`}>
                        <div className="flex items-center justify-between mb-1">
                          <span className="text-sm font-bold text-slate-800">{t.name}</span>
                          <span className={`text-[9px] font-black px-2 py-0.5 rounded ${t.druggability_score >= 0.7 ? 'bg-emerald-100 text-emerald-700' : t.druggability_score >= 0.5 ? 'bg-amber-100 text-amber-700' : 'bg-red-100 text-red-700'}`}>
                            Druggability: {(t.druggability_score * 100).toFixed(0)}%
                          </span>
                        </div>
                        <p className="text-[10px] text-slate-400">{t.gene} — {t.pathway}</p>
                        <p className="text-[10px] text-slate-500 mt-1">{t.rationale}</p>
                      </button>
                    ))}
                  </div>
                </div>

                {/* Pipeline Funnel */}
                <div className="bg-white rounded-3xl p-6 border border-slate-200 shadow-sm">
                  <h4 className="font-bold text-sm mb-4 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#8b5cf6" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>
                    Discovery Pipeline
                  </h4>
                  <div className="space-y-2">
                    {(() => {
                      const ss = livePlan?.knowledge?.chemist?.screening_summary;
                      const bioTargets = livePlan?.knowledge?.biologist?.targets;
                      const precEvals = livePlan?.knowledge?.preclinician?.candidate_evaluations;
                      const pipeline = (ss && bioTargets) ? [
                        { stage: 'Targets Identified', count: bioTargets.length, color: 'cyan' },
                        { stage: 'Compounds Screened', count: ss.total_compounds_found || 0, color: 'blue' },
                        { stage: 'Hits (pChEMBL ≥ 6)', count: ss.hits_above_threshold || 0, color: 'indigo' },
                        { stage: 'Lead Candidates', count: (ss.approved_drugs_found || 0) + (ss.phase3_compounds || 0), color: 'violet' },
                        { stage: 'Lab Testing Queue', count: precEvals?.length || 0, color: 'emerald' },
                      ] : LAB_PIPELINE_FUNNEL;
                      return pipeline;
                    })().map((s, i, arr) => {
                      const maxCount = Math.max(...arr.map(x => x.count), 1);
                      const pct = Math.max(15, (s.count / maxCount) * 100);
                      return (
                        <div key={i} className="flex items-center gap-3">
                          <div className="w-20 text-right">
                            <span className={`text-lg font-black text-${s.color}-600`}>{s.count}</span>
                          </div>
                          <div className="flex-1">
                            <div className={`h-8 bg-${s.color}-500 rounded-lg flex items-center px-3 transition-all duration-700`} style={{ width: `${pct}%` }}>
                              <span className="text-[10px] font-bold text-white whitespace-nowrap">{s.stage}</span>
                            </div>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                  <div className="mt-3 flex items-center gap-2 text-[10px] text-slate-400">
                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>
                    {(() => {
                      const ss = livePlan?.knowledge?.chemist?.screening_summary;
                      const precEvals = livePlan?.knowledge?.preclinician?.candidate_evaluations;
                      if (ss) return `${ss.total_compounds_found || 0} compounds screened → ${precEvals?.length || 0} ready for lab testing`;
                      return '847 compounds screened → 2 ready for lab testing';
                    })()}
                  </div>
                </div>
              </div>
            </div>
            </div>
          )}

          {/* CANDIDATES SECTION */}
          {labSection === 'candidates' && (
            <div className="space-y-6">

              {/* Candidate Comparison Grid */}
              <div className="bg-white rounded-3xl p-6 border border-slate-200 shadow-sm overflow-x-auto">
                <h3 className="font-bold text-lg mb-1">Candidate Comparison</h3>
                <p className="text-xs text-slate-400 mb-6">ADMET traffic-light scoring across all parameters</p>

                <table className="w-full text-xs">
                  <thead>
                    <tr className="border-b border-slate-200">
                      <th className="text-left py-3 px-2 font-bold text-slate-600 w-40">Candidate</th>
                      <th className="text-center py-3 px-1 font-bold text-slate-500">Efficacy</th>
                      <th className="text-center py-3 px-1 font-bold text-slate-500">Oral Abs.</th>
                      <th className="text-center py-3 px-1 font-bold text-slate-500">CNS</th>
                      <th className="text-center py-3 px-1 font-bold text-slate-500">hERG</th>
                      <th className="text-center py-3 px-1 font-bold text-slate-500">CYP</th>
                      <th className="text-center py-3 px-1 font-bold text-slate-500">Solub.</th>
                      <th className="text-center py-3 px-1 font-bold text-slate-500">Select.</th>
                      <th className="text-center py-3 px-1 font-bold text-slate-500">Synth.</th>
                      <th className="text-center py-3 px-2 font-bold text-slate-600 w-24">Overall</th>
                      <th className="text-right py-3 px-2 w-36"></th>
                    </tr>
                  </thead>
                  <tbody>
                    {candidates.map((c, i) => (
                      <tr key={i} className={`border-b border-slate-100 hover:bg-slate-50 transition-colors ${selectedCandidate === i ? 'bg-indigo-50' : ''}`}>
                        <td className="py-3 px-2">
                          <button onClick={() => setSelectedCandidate(selectedCandidate === i ? null : i)} className="text-left">
                            <div className="font-bold text-slate-800">{c.name}</div>
                            <div className="text-[10px] text-slate-400">{c.target}</div>
                            {c.fda_approved && <span className="text-[8px] font-black bg-emerald-100 text-emerald-700 px-1.5 py-0.5 rounded mt-0.5 inline-block">FDA APPROVED</span>}
                          </button>
                        </td>
                        {['efficacy','oral_absorption','cns_penetration','herg','cyp_inhibition','solubility','selectivity','synthetic_access'].map(key => (
                          <td key={key} className="text-center py-3 px-1">
                            <div className={`w-6 h-6 rounded-full ${ratingDot(c.scores[key].rating)} mx-auto`} title={c.scores[key].val}></div>
                          </td>
                        ))}
                        <td className="text-center py-3 px-2">
                          <span className={`text-[10px] font-black px-2.5 py-1 rounded-lg ${ratingBg(c.overall)}`}>
                            {c.overall.toUpperCase()}
                          </span>
                        </td>
                        <td className="text-right py-3 px-2">
                          {(c.overall === 'green' || (c.overall === 'amber' && c.fda_approved)) && (
                            <button className="px-3 py-1.5 bg-indigo-600 text-white rounded-lg text-[10px] font-bold hover:bg-indigo-700 transition-colors">
                              Queue for Lab
                            </button>
                          )}
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>

              {/* Expanded candidate detail */}
              {selectedCandidate !== null && (
                <div className="bg-white rounded-3xl p-6 border border-indigo-200 shadow-sm fade-up">
                  {(() => {
                    const c = candidates[selectedCandidate];
                    return (
                      <div className="grid grid-cols-12 gap-6">
                        <div className="col-span-5">
                          <h4 className="font-bold text-lg text-slate-900 mb-1">{c.name}</h4>
                          <p className="text-xs text-slate-400 mb-4">{c.chembl_id} — pChEMBL {c.pchembl}</p>
                          <div className="space-y-3">
                            <div>
                              <span className="text-[10px] font-bold text-slate-400 uppercase">Mechanism</span>
                              <p className="text-sm text-slate-700">{c.mechanism}</p>
                            </div>
                            <div>
                              <span className="text-[10px] font-bold text-slate-400 uppercase">Indication</span>
                              <p className="text-sm text-slate-700">{c.indication}</p>
                            </div>
                            <div>
                              <span className="text-[10px] font-bold text-slate-400 uppercase">Evidence</span>
                              <p className="text-sm text-slate-700">{c.evidence}</p>
                            </div>
                            <div>
                              <span className="text-[10px] font-bold text-slate-400 uppercase">Recommendation</span>
                              <p className={`text-sm font-semibold ${c.overall === 'green' ? 'text-emerald-700' : c.overall === 'amber' ? 'text-amber-700' : 'text-red-700'}`}>{c.recommendation}</p>
                            </div>
                          </div>
                        </div>
                        <div className="col-span-7">
                          <h5 className="text-xs font-bold text-slate-500 uppercase mb-3">ADMET Profile</h5>
                          <div className="grid grid-cols-2 gap-2">
                            {Object.entries(c.scores).map(([key, s]) => (
                              <div key={key} className={`p-2.5 rounded-xl border ${s.rating === 'green' ? 'bg-emerald-50 border-emerald-100' : s.rating === 'amber' ? 'bg-amber-50 border-amber-100' : 'bg-red-50 border-red-100'}`}>
                                <div className="flex items-center justify-between mb-0.5">
                                  <span className="text-[9px] font-bold text-slate-500 uppercase">{key.replace(/_/g, ' ')}</span>
                                  <div className={`w-2.5 h-2.5 rounded-full ${ratingDot(s.rating)}`}></div>
                                </div>
                                <p className="text-[11px] font-semibold text-slate-700">{s.val}</p>
                              </div>
                            ))}
                          </div>
                        </div>
                      </div>
                    );
                  })()}
                </div>
              )}
            </div>
          )}

          {/* EXPERIMENTS SECTION */}
          {labSection === 'experiments' && (
            <div className="space-y-6">
              <div className="bg-white rounded-3xl p-6 border border-slate-200 shadow-sm">
                <h3 className="font-bold text-lg mb-1">Experiment Tiers</h3>
                <p className="text-xs text-slate-400 mb-6">Progressive validation — each tier narrows the candidate pool</p>

                <div className="space-y-3">
                  {LAB_EXPERIMENTS.map((exp, i) => (
                    <div key={i} className={`p-5 rounded-2xl border-2 transition-all ${exp.status === 'ready' ? 'border-indigo-500 bg-indigo-50' : 'border-slate-200'}`}>
                      <div className="flex items-center justify-between mb-2">
                        <div className="flex items-center gap-3">
                          <div className={`w-8 h-8 rounded-lg flex items-center justify-center text-xs font-black ${exp.status === 'ready' ? 'bg-indigo-600 text-white' : 'bg-slate-200 text-slate-500'}`}>T{exp.tier}</div>
                          <div>
                            <h4 className="font-bold text-sm text-slate-800">{exp.name}</h4>
                            <p className="text-[10px] text-slate-400">Compounds: {exp.compounds}</p>
                          </div>
                        </div>
                        <div className="flex items-center gap-4">
                          <div className="text-right">
                            <p className="text-sm font-bold text-slate-800">{exp.cost}</p>
                            <p className="text-[10px] text-slate-400">{exp.timeline}</p>
                          </div>
                          {exp.status === 'ready' ? (
                            <button onClick={() => setCroModal(croContacts[exp.tier])} className="px-4 py-2 bg-indigo-600 text-white rounded-xl text-xs font-bold hover:bg-indigo-700 transition-colors shadow-md shadow-indigo-200">
                              Approve & Queue
                            </button>
                          ) : (
                            <span className="px-3 py-1.5 bg-slate-100 text-slate-400 rounded-lg text-[10px] font-bold">Pending prior tier</span>
                          )}
                        </div>
                      </div>
                      {/* Funding sources for this tier */}
                      {EXPERIMENT_FUNDING[exp.tier] && (
                        <div className="mt-3 pt-3 border-t border-slate-100">
                          <div className="flex items-center gap-2 mb-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#10b981" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                            <span className="text-[10px] font-bold text-emerald-700">Funding Sources</span>
                          </div>
                          <div className="flex flex-wrap gap-2">
                            {EXPERIMENT_FUNDING[exp.tier].map((f, fi) => (
                              <span key={fi} className="inline-flex items-center gap-1 px-2 py-1 bg-emerald-50 border border-emerald-200 rounded-lg text-[10px] text-emerald-800">
                                <span className="font-semibold">{f.source}</span>
                                <span className="text-emerald-500">·</span>
                                <span>{f.amount}</span>
                              </span>
                            ))}
                          </div>
                        </div>
                      )}
                      {exp.status === 'ready' && (
                        <div className="mt-3 pt-3 border-t border-indigo-200">
                          <p className="text-xs text-indigo-700">Ready to proceed — your Connector agent will draft a CRO outreach with the assay protocol attached.</p>
                        </div>
                      )}
                    </div>
                  ))}
                </div>

                <div className="mt-6 bg-amber-50 rounded-2xl p-4 border border-amber-200">
                  <div className="flex items-start gap-3">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#d97706" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="shrink-0 mt-0.5"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>
                    <div>
                      <p className="text-xs font-bold text-amber-800 mb-1">How this works</p>
                      <p className="text-xs text-amber-700">Approving an experiment tier means your Connector agent will reach out to qualified CROs (Contract Research Organizations) with a detailed protocol. You'll review every quote and CRO proposal before committing. Nothing is sent without your approval.</p>
                    </div>
                  </div>
                </div>
              </div>

              {/* CRO Pipeline */}
              <div className="bg-white rounded-3xl p-6 border border-slate-200 shadow-sm">
                <h3 className="font-bold text-sm mb-3 flex items-center gap-2">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#64748b" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                  CRO Pipeline
                </h3>
                <div className="space-y-3">
                  {LAB_EXPERIMENTS.map((exp, i) => {
                    const cro = croContacts[exp.tier];
                    return (
                      <div key={i} className={`flex items-center justify-between p-3 rounded-xl border ${exp.status === 'ready' ? 'border-indigo-200 bg-indigo-50' : 'border-slate-100 bg-slate-50'}`}>
                        <div className="flex items-center gap-3">
                          <div className={`w-7 h-7 rounded-lg flex items-center justify-center text-[10px] font-black ${exp.status === 'ready' ? 'bg-indigo-600 text-white' : 'bg-slate-200 text-slate-400'}`}>T{exp.tier}</div>
                          <div>
                            <p className={`text-xs font-bold ${exp.status === 'ready' ? 'text-slate-800' : 'text-slate-400'}`}>{cro.name}</p>
                            <p className="text-[10px] text-slate-400">{cro.specialty}</p>
                          </div>
                        </div>
                        {exp.status === 'ready' ? (
                          <button onClick={() => setCroModal(cro)} className="px-3 py-1.5 bg-indigo-100 text-indigo-700 rounded-lg text-[10px] font-bold hover:bg-indigo-200 transition-colors">View Draft</button>
                        ) : (
                          <span className="px-2 py-1 bg-slate-100 text-slate-400 rounded-lg text-[10px] font-medium">Pending</span>
                        )}
                      </div>
                    );
                  })}
                </div>
              </div>
            </div>
          )}
        </div>

        {croModal && (
          <div className="modal-overlay" onClick={() => setCroModal(null)}>
            <div className="modal" onClick={e => e.stopPropagation()}>
              <div className="flex justify-between items-center mb-6">
                <div>
                  <span className="bg-indigo-100 text-indigo-700 text-[10px] font-black px-2 py-0.5 rounded uppercase">CRO Outreach</span>
                  <h2 className="text-xl font-bold mt-2">{croModal.name}</h2>
                  <p className="text-xs text-slate-400 mt-1">{croModal.specialty}</p>
                </div>
                <button onClick={() => setCroModal(null)} className="text-slate-400 hover:text-slate-800 text-2xl leading-none">&times;</button>
              </div>
              <div className="mb-4">
                <label className="block font-semibold text-sm text-slate-700 mb-1">To:</label>
                <input type="text" defaultValue={croModal.email} className="w-full px-3 py-2 border-2 border-slate-200 rounded-lg focus:outline-none focus:border-indigo-500" id="cro-to" />
              </div>
              <div className="mb-4">
                <label className="block font-semibold text-sm text-slate-700 mb-1">Subject:</label>
                <input type="text" defaultValue={croModal.subject} className="w-full px-3 py-2 border-2 border-slate-200 rounded-lg focus:outline-none focus:border-indigo-500" id="cro-subject" />
              </div>
              <div className="mb-4">
                <label className="block font-semibold text-sm text-slate-700 mb-1">Message:</label>
                <textarea defaultValue={croModal.body} className="w-full px-3 py-3 border-2 border-slate-200 rounded-lg focus:outline-none focus:border-indigo-500 min-h-[180px] font-sans" id="cro-body" />
              </div>
              <div className="flex gap-3">
                <button onClick={() => {
                  const to = document.getElementById('cro-to').value;
                  const subject = document.getElementById('cro-subject').value;
                  const body = document.getElementById('cro-body').value;
                  const gmailUrl = `https://mail.google.com/mail/?view=cm&to=${encodeURIComponent(to)}&su=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                  window.open(gmailUrl, '_blank');
                  setCroModal(null);
                }} className="px-6 py-3 bg-emerald-500 text-white rounded-xl font-bold hover:bg-emerald-600 transition-colors shadow-md">Open in Gmail</button>
                <button onClick={() => setCroModal(null)} className="px-6 py-3 bg-slate-200 text-slate-700 rounded-xl font-bold text-sm hover:bg-slate-300 transition-colors">Cancel</button>
              </div>
            </div>
          </div>
        )}
      </React.Fragment>);
    }

    // ==========================================
    // COMMUNITY TAB
    // ==========================================

    function CommunityTab({ setActiveTab }) {
      const [communitySection, setCommunitySection] = useState('network');
      const sectionBtns = [
        { id: 'network', label: 'Patient Network', icon: '\u{1F465}' },
        { id: 'data', label: 'Data Commons', icon: '\u{1F4CA}' },
        { id: 'trial', label: 'Path to Trial', icon: '\u{1F3AF}' },
      ];

      return (
        <div className="max-w-6xl mx-auto px-8 py-8 space-y-6">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <div>
                <h2 className="text-2xl font-bold text-slate-800">Community & Funding</h2>
                <p className="text-sm text-slate-500 mt-1">Connect with families, share data, and build toward a clinical trial</p>
              </div>
              <span className="bg-amber-100 text-amber-700 text-[10px] font-black px-2.5 py-1 rounded-full uppercase tracking-wide border border-amber-200">Coming Soon</span>
            </div>
          </div>
          <div className="bg-amber-50 border border-amber-200 rounded-xl px-4 py-3 flex items-center gap-3">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#d97706" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
            <p className="text-xs text-amber-700">This is a preview of planned features. Data shown is illustrative and does not reflect your specific condition.</p>
          </div>

          {/* Your Team on This */}
          <div className="bg-white rounded-2xl p-4 border border-slate-200 shadow-sm">
            <p className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-3">Your Team on This</p>
            <div className="flex flex-wrap gap-4">
              {[
                { name: 'Connector', status: 'Matching families & drafting introductions' },
                { name: 'Preclinician', status: 'Analyzing community data to refine treatment models' },
                { name: 'Mobilizer', status: 'Identifying grants & funding strategy' },
                { name: 'Navigator', status: 'Mapping regulatory path to clinical trial' },
              ].map(a => (
                <div key={a.name} className="flex items-center gap-2">
                  <div className={`w-7 h-7 rounded-full bg-${AGENT_COLORS[a.name]}-500 flex items-center justify-center text-xs`}>{AGENT_EMOJIS[a.name]}</div>
                  <div>
                    <p className={`text-xs font-bold text-${AGENT_COLORS[a.name]}-700`}>{a.name}</p>
                    <p className="text-[10px] text-slate-400">{a.status}</p>
                  </div>
                </div>
              ))}
            </div>
          </div>

          {/* Section tabs */}
          <div className="flex gap-2">
            {sectionBtns.map(s => (
              <button key={s.id} onClick={() => setCommunitySection(s.id)}
                className={`px-4 py-2 rounded-xl text-sm font-semibold transition-all ${communitySection === s.id ? 'bg-indigo-600 text-white shadow-md' : 'bg-white text-slate-600 border border-slate-200 hover:border-indigo-300'}`}>
                {s.icon} {s.label}
              </button>
            ))}
          </div>

          {/* PATIENT NETWORK */}
          {communitySection === 'network' && (
            <div className="space-y-4">
              <div className="bg-gradient-to-r from-indigo-50 to-violet-50 rounded-3xl p-6 border border-indigo-100">
                <div className="flex items-center gap-3 mb-1">
                  <span className="text-2xl">{'\u{1F91D}'}</span>
                  <h3 className="font-bold text-lg text-slate-800">CLN3 Family Network</h3>
                </div>
                <p className="text-xs text-slate-500 ml-10 mb-3">Families matched by disease, geography, and treatment stage. All connections require your approval.</p>
                <div className="ml-10 inline-flex items-center gap-2 px-3 py-1.5 bg-pink-50 border border-pink-200 rounded-full">
                  <span className="text-sm">{AGENT_EMOJIS.Connector}</span>
                  <span className="text-[10px] font-bold text-pink-700">Connector</span>
                  <span className="text-[10px] text-pink-500">Matching families & drafting introductions</span>
                </div>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                {COMMUNITY_FAMILIES.map(fam => (
                  <div key={fam.id} className="bg-white rounded-2xl p-5 border border-slate-200 shadow-sm card-hover">
                    <div className="flex items-center gap-3 mb-4">
                      <div className={`w-10 h-10 rounded-full bg-${fam.color}-100 flex items-center justify-center text-${fam.color}-600 font-bold text-sm`}>{fam.avatar}</div>
                      <div>
                        <h4 className="font-bold text-sm text-slate-800">{fam.name}</h4>
                        <p className="text-[10px] text-slate-400">{fam.location}</p>
                      </div>
                    </div>
                    <div className="space-y-2 mb-4">
                      <div className="flex items-center gap-2">
                        <span className="text-[10px] font-bold text-slate-400 w-14">Patient</span>
                        <span className="text-xs text-slate-700">{fam.child}</span>
                      </div>
                      <div className="flex items-center gap-2">
                        <span className="text-[10px] font-bold text-slate-400 w-14">Stage</span>
                        <span className="text-xs text-slate-700">{fam.stage}</span>
                      </div>
                      <div className="flex items-center gap-2">
                        <span className="text-[10px] font-bold text-slate-400 w-14 shrink-0">Tx</span>
                        <div className="flex flex-wrap gap-1">
                          {fam.treatments.map((t, i) => <span key={i} className="text-[10px] bg-slate-100 px-2 py-0.5 rounded-full text-slate-600">{t}</span>)}
                        </div>
                      </div>
                    </div>
                    <div className="mb-3">
                      <p className="text-[10px] font-bold text-emerald-600 mb-1">Willing to share:</p>
                      <div className="flex flex-wrap gap-1">
                        {fam.willing.map((w, i) => <span key={i} className="text-[10px] bg-emerald-50 text-emerald-700 px-2 py-0.5 rounded-full border border-emerald-200">{w}</span>)}
                      </div>
                    </div>
                    <div className="flex items-center gap-1.5 mb-3 text-[9px] text-pink-500">
                      <span className="w-4 h-4 rounded-full bg-pink-500 flex items-center justify-center text-[8px]">{AGENT_EMOJIS.Connector}</span>
                      <span className="font-semibold text-pink-600">Connector</span> found this match via NPI Registry
                    </div>
                    <button className="w-full py-2 bg-indigo-50 text-indigo-600 rounded-xl text-xs font-bold hover:bg-indigo-100 transition-colors border border-indigo-200">
                      Request Introduction
                    </button>
                  </div>
                ))}
              </div>

              <div className="bg-amber-50 rounded-2xl p-4 border border-amber-200 flex items-start gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#d97706" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="shrink-0 mt-0.5"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                <div>
                  <p className="text-xs font-bold text-amber-800 mb-0.5">Privacy-First</p>
                  <p className="text-[11px] text-amber-700">All connections are opt-in. Your Connector agent will draft a warm introduction for your approval before any contact is made. No personal information is shared without explicit consent.</p>
                </div>
              </div>
            </div>
          )}

          {/* DATA COMMONS */}
          {communitySection === 'data' && (
            <div className="space-y-4">
              {/* Aggregate stats */}
              <div className="grid grid-cols-3 gap-4">
                <div className="bg-white rounded-2xl p-5 border border-slate-200 text-center">
                  <p className="text-3xl font-black text-indigo-600">{COMMUNITY_DATA_COMMONS.totalFamilies}</p>
                  <p className="text-xs text-slate-500 mt-1">CLN3 families connected</p>
                </div>
                <div className="bg-white rounded-2xl p-5 border border-slate-200 text-center">
                  <p className="text-3xl font-black text-emerald-600">{COMMUNITY_DATA_COMMONS.trackingSymptoms}</p>
                  <p className="text-xs text-slate-500 mt-1">Families tracking outcomes</p>
                </div>
                <div className="bg-white rounded-2xl p-5 border border-slate-200 text-center">
                  <p className="text-3xl font-black text-violet-600">{COMMUNITY_DATA_COMMONS.treatments.length}</p>
                  <p className="text-xs text-slate-500 mt-1">Treatments being tracked</p>
                </div>
              </div>

              {/* Agent activity banner */}
              <div className="flex flex-wrap gap-2">
                <div className="inline-flex items-center gap-2 px-3 py-1.5 bg-rose-50 border border-rose-200 rounded-full">
                  <span className="text-sm">{AGENT_EMOJIS.Preclinician}</span>
                  <span className="text-[10px] font-bold text-rose-700">Preclinician</span>
                  <span className="text-[10px] text-rose-500">Analyzing community data</span>
                </div>
                <div className="inline-flex items-center gap-2 px-3 py-1.5 bg-orange-50 border border-orange-200 rounded-full">
                  <span className="text-sm">{AGENT_EMOJIS.Chemist}</span>
                  <span className="text-[10px] font-bold text-orange-700">Chemist</span>
                  <span className="text-[10px] text-orange-500">Refining treatment models</span>
                </div>
              </div>

              {/* Treatment tracking table */}
              <div className="bg-white rounded-3xl p-6 border border-slate-200 shadow-sm">
                <h3 className="font-bold text-sm mb-4">Aggregated Treatment Data</h3>
                <div className="space-y-3">
                  {COMMUNITY_DATA_COMMONS.treatments.map((tx, i) => (
                    <div key={i} className="flex items-center justify-between p-3 rounded-xl bg-slate-50 border border-slate-100">
                      <div className="flex items-center gap-3">
                        <div className={`w-2 h-2 rounded-full ${tx.trend === 'promising' ? 'bg-emerald-500' : tx.trend === 'early' ? 'bg-amber-500' : 'bg-slate-400'}`}></div>
                        <div>
                          <p className="text-sm font-semibold text-slate-800">{tx.name}</p>
                          <p className="text-[10px] text-slate-400">{tx.families} families · avg {tx.avgDuration}</p>
                        </div>
                      </div>
                      <div className="flex items-center gap-2">
                        <span className="inline-flex items-center gap-1 text-[9px] text-rose-500"><span className="w-3.5 h-3.5 rounded-full bg-rose-500 flex items-center justify-center text-[7px]">{AGENT_EMOJIS.Preclinician}</span></span>
                        <span className={`text-[10px] font-bold px-2 py-1 rounded-full ${tx.trend === 'promising' ? 'bg-emerald-100 text-emerald-700' : tx.trend === 'early' ? 'bg-amber-100 text-amber-700' : 'bg-slate-100 text-slate-500'}`}>
                          {tx.trend}
                        </span>
                      </div>
                    </div>
                  ))}
                </div>
              </div>

              {/* N-of-1 Tracker */}
              <div className="bg-white rounded-3xl p-6 border border-slate-200 shadow-sm">
                <div className="flex items-center gap-2 mb-1">
                  <span className="text-lg">{'\u{1F9EA}'}</span>
                  <h3 className="font-bold text-sm">N-of-1 Experiment Tracker</h3>
                </div>
                <p className="text-xs text-slate-400 mb-4">{COMMUNITY_NOF1_TRACKER.experiment}</p>
                <p className="text-[10px] text-slate-500 mb-3">Family: {COMMUNITY_NOF1_TRACKER.family} · Started: {COMMUNITY_NOF1_TRACKER.startDate}</p>

                <div className="overflow-x-auto">
                  <table className="w-full text-xs">
                    <thead>
                      <tr className="border-b border-slate-200">
                        <th className="text-left py-2 px-2 text-slate-400 font-semibold">Week</th>
                        <th className="text-center py-2 px-2 text-slate-400 font-semibold">Seizures/wk</th>
                        <th className="text-center py-2 px-2 text-slate-400 font-semibold">Mobility (1-10)</th>
                        <th className="text-center py-2 px-2 text-slate-400 font-semibold">Cognition (1-10)</th>
                        <th className="text-left py-2 px-2 text-slate-400 font-semibold">Notes</th>
                      </tr>
                    </thead>
                    <tbody>
                      {COMMUNITY_NOF1_TRACKER.dataPoints.map((dp, i) => (
                        <tr key={i} className="border-b border-slate-50">
                          <td className="py-2 px-2 font-bold text-slate-700">{dp.week}</td>
                          <td className="py-2 px-2 text-center">
                            <span className={`font-bold ${dp.seizures <= 2 ? 'text-emerald-600' : dp.seizures <= 3 ? 'text-amber-600' : 'text-slate-600'}`}>{dp.seizures}</span>
                          </td>
                          <td className="py-2 px-2 text-center font-semibold text-slate-700">{dp.mobility}</td>
                          <td className="py-2 px-2 text-center font-semibold text-slate-700">{dp.cognition}</td>
                          <td className="py-2 px-2 text-slate-500">{dp.notes}</td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>

                <div className="mt-4 p-3 bg-rose-50 rounded-xl border border-rose-200">
                  <div className="flex items-center gap-2 mb-1.5">
                    <div className="w-6 h-6 rounded-full bg-rose-500 flex items-center justify-center text-xs">{AGENT_EMOJIS.Preclinician}</div>
                    <span className="text-[10px] font-bold text-rose-700">Preclinician</span>
                    <span className="text-[9px] text-rose-400">Analysis Note</span>
                  </div>
                  <p className="text-xs text-rose-800 ml-8">Seizure frequency reduced 75% over 16 weeks. Data shared (anonymized) with <span className="inline-flex items-center gap-1 mx-0.5"><span className="w-3.5 h-3.5 rounded-full bg-orange-500 inline-flex items-center justify-center text-[7px]">{AGENT_EMOJIS.Chemist}</span><span className="font-bold text-orange-700">Chemist</span></span> to refine dosing model.</p>
                </div>
              </div>
            </div>
          )}

          {/* PATH TO CLINICAL TRIAL */}
          {communitySection === 'trial' && (
            <div className="space-y-4">
              {/* Agent activity banner */}
              <div className="flex flex-wrap gap-2">
                {['Navigator', 'Mobilizer', 'Strategist'].map(name => (
                  <div key={name} className={`inline-flex items-center gap-2 px-3 py-1.5 bg-${AGENT_COLORS[name]}-50 border border-${AGENT_COLORS[name]}-200 rounded-full`}>
                    <span className="text-sm">{AGENT_EMOJIS[name]}</span>
                    <span className={`text-[10px] font-bold text-${AGENT_COLORS[name]}-700`}>{name}</span>
                  </div>
                ))}
                <span className="self-center text-[10px] text-slate-400">Mapping regulatory path & funding strategy</span>
              </div>

              <div className="bg-white rounded-3xl p-6 border border-slate-200 shadow-sm">
                <h3 className="font-bold text-lg mb-1">From Community to Clinical Trial</h3>
                <p className="text-xs text-slate-400 mb-6">Your agents are mapping the path from shared patient data to a formal clinical study</p>

                <div className="space-y-0">
                  {CLINICAL_TRIAL_ROADMAP.map((step, i) => (
                    <div key={i} className="flex items-start gap-4 relative">
                      {/* Connector line */}
                      {i < CLINICAL_TRIAL_ROADMAP.length - 1 && (
                        <div className="absolute left-5 top-10 w-0.5 h-12 bg-slate-200" style={{ left: '19px' }}></div>
                      )}
                      <div className={`w-10 h-10 rounded-xl flex items-center justify-center shrink-0 ${
                        step.status === 'active' ? 'bg-indigo-600 text-white' :
                        step.status === 'next' ? 'bg-amber-100 text-amber-600 border-2 border-amber-300' :
                        'bg-slate-100 text-slate-400'
                      }`}>
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                          {step.icon === 'users' && <><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></>}
                          {step.icon === 'database' && <><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M3 5V19A9 3 0 0 0 21 19V5"/><path d="M3 12A9 3 0 0 0 21 12"/></>}
                          {step.icon === 'clipboard' && <><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/></>}
                          {step.icon === 'file-text' && <><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/></>}
                          {step.icon === 'shield' && <path d="M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z"/>}
                          {step.icon === 'activity' && <path d="M22 12h-2.48a2 2 0 0 0-1.93 1.46l-2.35 8.36a.25.25 0 0 1-.48 0L9.24 2.18a.25.25 0 0 0-.48 0l-2.35 8.36A2 2 0 0 1 4.49 12H2"/>}
                        </svg>
                      </div>
                      <div className="pb-8">
                        <div className="flex items-center gap-2">
                          <h4 className={`font-bold text-sm ${step.status === 'active' ? 'text-indigo-700' : step.status === 'next' ? 'text-amber-700' : 'text-slate-400'}`}>{step.step}</h4>
                          {step.status === 'active' && <span className="text-[9px] font-bold px-2 py-0.5 bg-indigo-100 text-indigo-600 rounded-full">ACTIVE</span>}
                          {step.status === 'next' && <span className="text-[9px] font-bold px-2 py-0.5 bg-amber-100 text-amber-600 rounded-full">NEXT</span>}
                        </div>
                        <div className="flex items-center gap-2 mt-0.5">
                          <p className="text-xs text-slate-500">{step.detail}</p>
                          <div className="flex -space-x-1">
                            {step.agents && step.agents.map(a => (
                              <div key={a} className={`w-5 h-5 rounded-full bg-${AGENT_COLORS[a]}-500 flex items-center justify-center text-[8px] border border-white`} title={a}>{AGENT_EMOJIS[a]}</div>
                            ))}
                          </div>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              </div>

              {/* Funding by stage */}
              <div className="bg-white rounded-3xl p-6 border border-slate-200 shadow-sm">
                <h3 className="font-bold text-sm mb-4">Funding Needed by Stage</h3>
                <div className="space-y-3">
                  {[
                    { stage: 'Natural History Study', amount: '$50-100K', sources: 'NORD, CZI Rare As One, BDSRA', agent: 'Mobilizer' },
                    { stage: 'IND Preparation', amount: '$100-250K', sources: 'NIH NCATS, pharma partnerships', agent: 'Mobilizer + Navigator' },
                    { stage: 'Phase 1 Trial', amount: '$500K-2M', sources: 'DoD CDMRP, venture philanthropy, 501(c)(3) fundraising', agent: 'Mobilizer' },
                  ].map((item, i) => (
                    <div key={i} className="p-4 bg-slate-50 rounded-xl border border-slate-100">
                      <div className="flex items-center justify-between mb-1">
                        <h4 className="text-sm font-bold text-slate-800">{item.stage}</h4>
                        <span className="text-sm font-black text-emerald-600">{item.amount}</span>
                      </div>
                      <p className="text-[10px] text-slate-500">Sources: {item.sources}</p>
                      <div className="flex items-center gap-1.5 mt-1.5">
                        {item.agent.split(' + ').map(a => (
                          <div key={a} className={`inline-flex items-center gap-1 px-2 py-0.5 bg-${AGENT_COLORS[a]}-50 rounded-full`}>
                            <span className="text-[9px]">{AGENT_EMOJIS[a]}</span>
                            <span className={`text-[9px] font-bold text-${AGENT_COLORS[a]}-700`}>{a}</span>
                          </div>
                        ))}
                      </div>
                    </div>
                  ))}
                </div>
              </div>

              {/* Organize a study CTA */}
              <div className="bg-gradient-to-r from-indigo-600 to-violet-600 rounded-3xl p-6 text-white">
                <h3 className="font-bold text-lg mb-2">Ready to organize a study?</h3>
                <p className="text-sm text-indigo-100 mb-4">When your community has enough shared data, your agents can draft an IRB protocol outline, identify sites, and map the regulatory path.</p>
                <button className="px-6 py-3 bg-white text-indigo-700 rounded-xl text-sm font-bold hover:bg-indigo-50 transition-colors shadow-lg">
                  Draft IRB Protocol Outline
                </button>
              </div>
            </div>
          )}
        </div>
      );
    }

    // ==========================================
    // ACTION MODAL (for insight & decision CTAs)
    // ==========================================

    function ActionModal({ action, onClose }) {
      const [success, setSuccess] = useState(false);

      const showSuccess = (msg) => {
        setSuccess(msg || 'Done!');
        setTimeout(() => onClose(), 1500);
      };

      if (success) {
        return (
          <div className="modal-overlay" onClick={onClose}>
            <div className="modal text-center" onClick={e => e.stopPropagation()}>
              <div className="w-20 h-20 bg-emerald-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="#059669" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
              </div>
              <h3 className="text-xl font-bold text-slate-800">{success}</h3>
            </div>
          </div>
        );
      }

      if (action.type === 'pre-screening') return <PreScreeningModal action={action} onClose={onClose} onSuccess={showSuccess} />;
      if (action.type === 'briefing') return <BriefingModal action={action} onClose={onClose} onSuccess={showSuccess} />;
      if (action.type === 'outreach') return <OutreachModal action={action} onClose={onClose} onSuccess={showSuccess} />;
      return null;
    }

    function PreScreeningModal({ action, onClose, onSuccess }) {
      useEffect(() => { const h = e => e.key === 'Escape' && onClose(); window.addEventListener('keydown', h); return () => window.removeEventListener('keydown', h); }, []);
      const [checks, setChecks] = useState({});
      const toggle = (k) => setChecks(prev => ({ ...prev, [k]: !prev[k] }));
      const disease = action.disease || 'CLN3 Batten Disease';
      const isLive = !!action.disease && action.disease !== 'CLN3 Batten Disease';

      const criteria = isLive ? [
        { key: 'age', label: 'Patient meets age requirements' },
        { key: 'diagnosis', label: `Confirmed ${disease} diagnosis` },
        { key: 'functional', label: 'Meets functional status requirements' },
        { key: 'records', label: 'Medical records available within 6 months' },
        { key: 'noother', label: 'Not enrolled in another interventional trial' },
        { key: 'travel', label: 'Able to travel to trial site' },
      ] : [
        { key: 'age', label: 'Patient age 3-18 years' },
        { key: 'diagnosis', label: 'Confirmed CLN3 genetic diagnosis' },
        { key: 'ambulatory', label: 'Ambulatory or semi-ambulatory' },
        { key: 'vision', label: 'Documented vision assessment within 6 months' },
        { key: 'noother', label: 'Not enrolled in another interventional trial' },
        { key: 'travel', label: 'Able to travel to Weill Cornell (New York, NY)' },
      ];

      const docs = isLive ? [
        `Genetic/diagnostic testing report (${disease} confirmation)`,
        'Recent medical records & specialist evaluations',
        'Insurance information & pre-authorization',
        'List of current medications',
      ] : [
        'Genetic testing report (CLN3 mutation confirmation)',
        'Recent medical records & neuropsych evaluation',
        'Insurance information & pre-authorization',
        'List of current medications',
      ];

      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="modal" onClick={e => e.stopPropagation()}>
            <div className="flex justify-between items-center mb-6">
              <div>
                <span className="bg-indigo-100 text-indigo-700 text-[10px] font-black px-2 py-0.5 rounded uppercase">Pre-Screening</span>
                <h2 className="text-xl font-bold mt-2">{action.title || 'Phase I/II AAV9-CLN3 Gene Therapy'}</h2>
                <p className="text-xs text-slate-400 mt-1">{action.subtitle || 'NCT-2024-CLN3-001 · Weill Cornell Medical Center'}</p>
              </div>
              <button onClick={onClose} className="text-slate-400 hover:text-slate-800 text-2xl leading-none">&times;</button>
            </div>

            <div className="mb-6">
              <h3 className="font-bold text-sm text-slate-700 mb-3">Eligibility Checklist</h3>
              <div className="space-y-2">
                {criteria.map(c => (
                  <label key={c.key} className="flex items-center gap-3 p-2.5 rounded-lg hover:bg-slate-50 cursor-pointer">
                    <input type="checkbox" checked={!!checks[c.key]} onChange={() => toggle(c.key)}
                      className="w-4 h-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500" />
                    <span className="text-sm text-slate-700">{c.label}</span>
                  </label>
                ))}
              </div>
            </div>

            <div className="mb-6 bg-slate-50 rounded-xl p-4">
              <h3 className="font-bold text-sm text-slate-700 mb-3">What to Prepare</h3>
              <ul className="space-y-2">
                {docs.map((d, i) => (
                  <li key={i} className="flex items-start gap-2 text-sm text-slate-600">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#6366f1" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="mt-0.5 shrink-0"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8Z"/><polyline points="14 2 14 8 20 8"/></svg>
                    {d}
                  </li>
                ))}
              </ul>
            </div>

            <div className="flex gap-3">
              <button onClick={() => onSuccess('Pre-screening request sent!')} className="px-6 py-3 bg-emerald-500 text-white rounded-xl font-bold hover:bg-emerald-600 transition-colors shadow-md">Request Pre-Screening Call</button>
              <button onClick={onClose} className="px-6 py-3 bg-slate-200 text-slate-700 rounded-xl font-bold text-sm hover:bg-slate-300 transition-colors">Cancel</button>
            </div>
          </div>
        </div>
      );
    }

    function BriefingModal({ action, onClose, onSuccess }) {
      useEffect(() => { const h = e => e.key === 'Escape' && onClose(); window.addEventListener('keydown', h); return () => window.removeEventListener('keydown', h); }, []);
      const disease = action.disease || 'CLN3 Batten Disease';
      const isLive = !!action.disease && action.disease !== 'CLN3 Batten Disease';
      const finding = action.title || 'Tamoxifen';

      const briefingText = isLive ? `SPECIALIST BRIEFING: Research Finding
══════════════════════════════════════════════

Patient Condition: ${disease}

FINDING: ${finding}

${action.description || ''}

DETAILS:
This finding was identified by Beacon's Scout agent through systematic analysis of clinical trials, medical literature, and drug databases for ${disease}.

RECOMMENDED NEXT STEPS:
1. Review this finding with the patient's treating physician
2. Request relevant baseline biomarker panel
3. Discuss potential risk/benefit with family
4. If applicable, contact trial coordinator or prescribing physician

REGULATORY NOTE:
Any treatment decisions should be made in consultation with the patient's medical team. Off-label use, where applicable, is legal and common but requires physician supervision.

Generated by Beacon AI · Scout + Navigator agents` : `SPECIALIST BRIEFING: Drug Repurposing Candidate
══════════════════════════════════════════════

Patient: CLN3 Batten Disease (Juvenile Neuronal Ceroid Lipofuscinosis)

CANDIDATE: Tamoxifen (FDA-approved, existing pediatric safety data)

MECHANISM OF ACTION:
Tamoxifen activates TRPML1 (mucolipin-1), a lysosomal cation channel. In CLN3 disease, loss of CLN3 protein disrupts lysosomal calcium homeostasis. TRPML1 activation by tamoxifen bypasses this defect, restoring lysosomal calcium signaling and reducing ceroid lipofuscin accumulation.

KEY EVIDENCE:
• Bhattacharyya et al. (2024) - Demonstrated tamoxifen-mediated TRPML1 activation clears stored material in CLN3-deficient neuronal cultures
• Bhattacharyya et al. (2023) - Murine CLN3 model showed 40% reduction in storage material after 8-week treatment course
• Established pediatric safety profile from oncology use (10+ years of data)

PROPOSED APPROACH:
Off-label use under treating physician supervision. Starting dose: 10mg daily, with monitoring of lysosomal biomarkers (SCMAS, subunit c levels) at baseline and 3-month intervals.

REGULATORY NOTE:
Off-label use is legal and common. No IND required. Insurance coverage possible with physician letter of medical necessity.

RECOMMENDED NEXT STEPS:
1. Review evidence with patient's neurologist
2. Baseline biomarker panel
3. Discuss risk/benefit with family
4. If proceeding, start low-dose trial with 3-month reassessment

Generated by Beacon AI · Scout + Navigator agents`;

      const filename = isLive ? `${disease.replace(/\s+/g, '-')}-Specialist-Briefing.txt` : 'CLN3-Tamoxifen-Specialist-Briefing.txt';

      const handleCopy = () => {
        navigator.clipboard.writeText(briefingText);
        onSuccess('Copied to clipboard!');
      };

      const handleDownload = () => {
        const blob = new Blob([briefingText], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
        onSuccess('Briefing downloaded!');
      };

      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="modal" onClick={e => e.stopPropagation()}>
            <div className="flex justify-between items-center mb-6">
              <div>
                <span className="bg-indigo-100 text-indigo-700 text-[10px] font-black px-2 py-0.5 rounded uppercase">Specialist Briefing</span>
                <h2 className="text-xl font-bold mt-2">{isLive ? finding : 'Drug Repurposing: Tamoxifen for CLN3'}</h2>
                <p className="text-xs text-slate-400 mt-1">For your child's treating physician</p>
              </div>
              <button onClick={onClose} className="text-slate-400 hover:text-slate-800 text-2xl leading-none">&times;</button>
            </div>

            <div className="bg-slate-50 border border-slate-200 rounded-xl p-5 mb-6 max-h-[45vh] overflow-y-auto">
              <pre className="text-xs text-slate-700 whitespace-pre-wrap font-mono leading-relaxed">{briefingText}</pre>
            </div>

            <div className="flex gap-3 flex-wrap">
              <button onClick={handleCopy} className="px-5 py-3 bg-indigo-600 text-white rounded-xl font-bold text-sm hover:bg-indigo-700 transition-colors shadow-md flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>
                Copy to Clipboard
              </button>
              <button onClick={handleDownload} className="px-5 py-3 bg-emerald-500 text-white rounded-xl font-bold text-sm hover:bg-emerald-600 transition-colors shadow-md flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
                Download
              </button>
              <button onClick={onClose} className="px-5 py-3 bg-slate-200 text-slate-700 rounded-xl font-bold text-sm hover:bg-slate-300 transition-colors">Cancel</button>
            </div>
          </div>
        </div>
      );
    }

    function OutreachModal({ action, onClose, onSuccess }) {
      useEffect(() => { const h = e => e.key === 'Escape' && onClose(); window.addEventListener('keydown', h); return () => window.removeEventListener('keydown', h); }, []);
      const [edited, setEdited] = useState({ ...action });

      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="modal" onClick={e => e.stopPropagation()}>
            <div className="flex justify-between items-center mb-6">
              <div>
                <span className="bg-amber-100 text-amber-700 text-[10px] font-black px-2 py-0.5 rounded uppercase">Outreach Approval</span>
                <h2 className="text-xl font-bold mt-2">Contact EveryCure</h2>
                <p className="text-xs text-slate-400 mt-1">Mobilizer agent · Drug repurposing consultation</p>
              </div>
              <button onClick={onClose} className="text-slate-400 hover:text-slate-800 text-2xl leading-none">&times;</button>
            </div>

            <div className="mb-4">
              <label className="block font-semibold text-sm text-slate-700 mb-1">To:</label>
              <input type="text" value={edited.to || ''} onChange={e => setEdited({ ...edited, to: e.target.value })}
                className="w-full px-3 py-2 border-2 border-slate-200 rounded-lg focus:outline-none focus:border-indigo-500" />
            </div>

            <div className="mb-4">
              <label className="block font-semibold text-sm text-slate-700 mb-1">Subject:</label>
              <input type="text" value={edited.subject || ''} onChange={e => setEdited({ ...edited, subject: e.target.value })}
                className="w-full px-3 py-2 border-2 border-slate-200 rounded-lg focus:outline-none focus:border-indigo-500" />
            </div>

            <div className="mb-4">
              <label className="block font-semibold text-sm text-slate-700 mb-1">Message:</label>
              <textarea value={edited.body || ''} onChange={e => setEdited({ ...edited, body: e.target.value })}
                className="w-full px-3 py-3 border-2 border-slate-200 rounded-lg focus:outline-none focus:border-indigo-500 min-h-[180px] font-sans" />
            </div>

            {edited.note && (
              <div className="bg-amber-50 border-l-4 border-amber-500 p-4 rounded-lg mb-4">
                <div className="font-semibold text-sm text-amber-800 mb-1">Mobilizer's Note:</div>
                <div className="text-sm text-amber-700">{edited.note}</div>
              </div>
            )}

            <div className="flex gap-3">
              <button onClick={() => { const gmailUrl = `https://mail.google.com/mail/?view=cm&to=${encodeURIComponent(edited.to)}&su=${encodeURIComponent(edited.subject)}&body=${encodeURIComponent(edited.body)}`; window.open(gmailUrl, '_blank'); onSuccess('Outreach approved!'); }} className="px-6 py-3 bg-emerald-500 text-white rounded-xl font-bold hover:bg-emerald-600 transition-colors shadow-md">Open in Gmail</button>
              <button onClick={onClose} className="px-6 py-3 bg-slate-200 text-slate-700 rounded-xl font-bold text-sm hover:bg-slate-300 transition-colors">Cancel</button>
            </div>
          </div>
        </div>
      );
    }

    // ==========================================
    // APPROVAL MODAL (reused)
    // ==========================================

    function ApprovalModal({ approval, onClose }) {
      const [edited, setEdited] = useState({ ...approval });
      const [saved, setSaved] = useState(false);
      useEffect(() => { const h = e => e.key === 'Escape' && onClose(); window.addEventListener('keydown', h); return () => window.removeEventListener('keydown', h); }, []);

      const handleApprove = () => {
        const gmailUrl = `https://mail.google.com/mail/?view=cm&to=${encodeURIComponent(edited.to)}&su=${encodeURIComponent(edited.subject)}&body=${encodeURIComponent(edited.body)}`;
        window.open(gmailUrl, '_blank');
        onClose();
      };

      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="modal" onClick={e => e.stopPropagation()}>
            <div className="flex justify-between items-center mb-6">
              <h2 className="text-2xl font-bold">Review & Approve</h2>
              <button onClick={onClose} className="text-slate-400 hover:text-slate-800 text-2xl leading-none">&times;</button>
            </div>

            <div className="mb-4">
              <label className="block font-semibold text-sm text-slate-700 mb-1">To:</label>
              <input type="text" value={edited.to || ''} onChange={e => setEdited({ ...edited, to: e.target.value })}
                className="w-full px-3 py-2 border-2 border-slate-200 rounded-lg focus:outline-none focus:border-indigo-500" />
            </div>

            <div className="mb-4">
              <label className="block font-semibold text-sm text-slate-700 mb-1">Subject:</label>
              <input type="text" value={edited.subject || ''} onChange={e => setEdited({ ...edited, subject: e.target.value })}
                className="w-full px-3 py-2 border-2 border-slate-200 rounded-lg focus:outline-none focus:border-indigo-500" />
            </div>

            <div className="mb-4">
              <label className="block font-semibold text-sm text-slate-700 mb-1">Message:</label>
              <textarea value={edited.body || ''} onChange={e => setEdited({ ...edited, body: e.target.value })}
                className="w-full px-3 py-3 border-2 border-slate-200 rounded-lg focus:outline-none focus:border-indigo-500 min-h-[200px] font-sans" />
            </div>

            {approval.note && (
              <div className="bg-amber-50 border-l-4 border-amber-500 p-4 rounded-lg mb-4">
                <div className="font-semibold text-sm text-amber-800 mb-1">Connector's Note:</div>
                <div className="text-sm text-amber-700">{approval.note}</div>
              </div>
            )}

            <div className="flex gap-3 mt-6">
              <button onClick={handleApprove} className="px-6 py-3 bg-emerald-500 text-white rounded-xl font-bold hover:bg-emerald-600 transition-colors shadow-md">Open in Gmail</button>
              <button onClick={() => { setEdited({...edited}); setSaved(true); setTimeout(() => setSaved(false), 1500); }} className="px-6 py-3 bg-indigo-600 text-white rounded-xl font-bold text-sm hover:bg-indigo-700 transition-colors">{saved ? '✓ Saved' : 'Save Edits'}</button>
              <button onClick={onClose} className="px-6 py-3 bg-slate-200 text-slate-700 rounded-xl font-bold text-sm hover:bg-slate-300 transition-colors">Cancel</button>
            </div>
          </div>
        </div>
      );
    }

    // Render
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
