<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Beacon - Your AI Team for Rare Disease Treatment</title>

  <!-- React 18 + ReactDOM via CDN -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <!-- Babel Standalone for JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <!-- 3Dmol.js for protein/molecule visualization -->
  <script src="https://3Dmol.org/build/3Dmol-min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
    body { font-family: 'Inter', sans-serif; }

    .step-inactive { opacity: 0.3; filter: grayscale(1); pointer-events: none; }
    .agent-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
    @keyframes fadeUp { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
    .fade-up { animation: fadeUp 0.5s ease-out forwards; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .fade-in { animation: fadeIn 0.6s ease-in forwards; }

    .timeline-line::before { content: ''; position: absolute; left: 19px; top: 0; bottom: 0; width: 2px; background: #e2e8f0; }
    [data-expand-target] { max-height: 0; overflow: hidden; transition: max-height 0.4s ease, opacity 0.3s ease; opacity: 0; }
    [data-expand-target].open { max-height: 3000px; opacity: 1; }
    .chevron-icon { transition: transform 0.3s ease; }
    .chevron-icon.rotated { transform: rotate(180deg); }
    .chevron { transition: transform 0.3s ease; display: inline-block; }
    .chevron.rotated { transform: rotate(180deg); }
    .card-hover { transition: transform 0.3s ease, box-shadow 0.3s ease; }
    .card-hover:hover { transform: translateY(-3px); box-shadow: 0 20px 40px -12px rgba(0,0,0,0.15); }
    @keyframes slideOut { to { opacity: 0; transform: translateX(200px) rotate(10deg); } }
    .slide-out { animation: slideOut 0.3s ease-in forwards; }
    @keyframes slideOutLeft { to { opacity: 0; transform: translateX(-200px) rotate(-10deg); } }
    .slide-out-left { animation: slideOutLeft 0.3s ease-in forwards; }

    /* Modal styles (reused from original) */
    .modal-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.6); display: flex; align-items: center; justify-content: center;
      z-index: 1000; opacity: 0; animation: fadeIn 0.3s ease-out forwards;
    }
    .modal {
      background: white; border-radius: 20px; padding: 2.5rem; max-width: 700px; width: 90%;
      max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      transform: scale(0.9); animation: modalAppear 0.3s ease-out forwards;
    }
    @keyframes modalAppear { to { transform: scale(1); } }
  </style>
</head>
<body class="bg-slate-100 min-h-screen text-slate-900">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useCallback, useRef } = React;

    // ==========================================
    // DATA CONSTANTS
    // ==========================================

    const RARE_DISEASES = [
      { name: "Batten Disease (CLN3)", aliases: ["CLN3", "Juvenile Neuronal Ceroid Lipofuscinosis", "JNCL", "Batten Disease"] },
      { name: "Batten Disease (CLN1)", aliases: ["CLN1", "Infantile Neuronal Ceroid Lipofuscinosis"] },
      { name: "Batten Disease (CLN2)", aliases: ["CLN2", "Late Infantile Neuronal Ceroid Lipofuscinosis", "TPP1 Deficiency"] },
      { name: "Spinal Muscular Atrophy (SMA)", aliases: ["SMA", "Werdnig-Hoffmann Disease"] },
      { name: "Duchenne Muscular Dystrophy", aliases: ["DMD", "Duchenne"] },
      { name: "Cystic Fibrosis", aliases: ["CF", "Mucoviscidosis"] },
      { name: "Huntington's Disease", aliases: ["HD", "Huntington Chorea"] },
      { name: "Rett Syndrome", aliases: ["MECP2", "Rett"] },
      { name: "Dravet Syndrome", aliases: ["SCN1A", "Severe Myoclonic Epilepsy of Infancy"] },
      { name: "Fragile X Syndrome", aliases: ["FXS", "Martin-Bell Syndrome"] },
      { name: "Tay-Sachs Disease", aliases: ["Hexosaminidase A Deficiency"] },
      { name: "Gaucher Disease", aliases: ["Glucocerebrosidase Deficiency"] },
      { name: "Pompe Disease", aliases: ["Glycogen Storage Disease Type II"] },
      { name: "Fabry Disease", aliases: ["Alpha-Galactosidase A Deficiency"] },
      { name: "Phenylketonuria (PKU)", aliases: ["PKU"] },
      { name: "Niemann-Pick Disease", aliases: ["NPD"] },
      { name: "Angelman Syndrome", aliases: ["AS"] },
      { name: "Prader-Willi Syndrome", aliases: ["PWS"] },
      { name: "Sanfilippo Syndrome", aliases: ["MPS III"] },
      { name: "Krabbe Disease", aliases: ["Globoid Cell Leukodystrophy"] },
      { name: "CDKL5 Deficiency Disorder", aliases: ["CDKL5", "CDD"] },
      { name: "Giant Axonal Neuropathy", aliases: ["GAN"] },
      { name: "AADC Deficiency", aliases: ["Aromatic L-Amino Acid Decarboxylase Deficiency"] },
      { name: "Epidermolysis Bullosa", aliases: ["EB", "Butterfly Disease"] },
      { name: "Sickle Cell Disease", aliases: ["SCD"] },
    ];

    const JOURNEY_STAGES = [
      { id: 'pre-diagnosis', emoji: '\u{1F50D}', title: "Still searching for answers", desc: "Symptoms but no clear diagnosis yet" },
      { id: 'just-diagnosed', emoji: '\u{1F4CB}', title: "Just received a diagnosis", desc: "Need to make sense of it and build a plan" },
      { id: 'established', emoji: '\u{1F6E4}\u{FE0F}', title: "We've known for a while", desc: "Go deeper on treatment pathways and trials" },
    ];

    const DEMO_EVENTS = [
      { t: 0, type: 'summary', text: 'Analyzing CLN3 Batten Disease...' },
      { t: 2000, type: 'agent_status', agent: 'Scout', status: 'Searching bioRxiv...', done: false },
      { t: 2000, type: 'agent_status', agent: 'Navigator', status: 'Checking FDA orphan drug database...', done: false },
      { t: 2000, type: 'agent_status', agent: 'Connector', status: 'Querying NPI Registry...', done: false },
      { t: 2000, type: 'agent_status', agent: 'Mobilizer', status: 'Scanning NIH grants...', done: false },
      { t: 2000, type: 'agent_status', agent: 'Strategist', status: 'Building framework...', done: false },
      { t: 4000, type: 'progress', phase: 'Research', pct: 30 },
      { t: 4000, type: 'agent_status', agent: 'Navigator', status: 'CLN3 qualifies for Orphan Drug Designation', done: true },
      { t: 6000, type: 'achievement', text: 'FDA orphan drug pathway confirmed viable' },
      { t: 6000, type: 'progress', phase: 'Regulatory', pct: 40 },
      { t: 8000, type: 'agent_status', agent: 'Scout', status: 'AAV9-CLN3 gene therapy trial identified', done: true },
      { t: 8000, type: 'achievement', text: 'Found active gene therapy trial at Weill Cornell' },
      { t: 8000, type: 'progress', phase: 'Research', pct: 70 },
      { t: 10000, type: 'insight', id: 'trial_match' },
      { t: 14000, type: 'achievement', text: 'Identified tamoxifen as repurposing candidate' },
      { t: 14000, type: 'insight', id: 'repurposing' },
      { t: 14000, type: 'progress', phase: 'Research', pct: 100, status: 'complete' },
      { t: 18000, type: 'insight', id: 'email_decision' },
      { t: 18000, type: 'agent_status', agent: 'Connector', status: '5 outreach emails drafted', done: true },
      { t: 18000, type: 'progress', phase: 'Outreach', pct: 60 },
      { t: 22000, type: 'insight', id: 'everycure_decision' },
      { t: 20000, type: 'agent_status', agent: 'Mobilizer', status: 'Matched funding sources to experiment tiers', done: false },
      { t: 22000, type: 'agent_status', agent: 'Mobilizer', status: 'Grant strategy ready — 5 tiers funded', done: true },
      { t: 22000, type: 'agent_status', agent: 'Strategist', status: 'Roadmap complete', done: true },
      { t: 24000, type: 'summary', text: 'Your plan is ready.' },
    ];

    const AGENT_COLORS = {
      Scout: 'violet', Connector: 'pink', Navigator: 'blue', Mobilizer: 'emerald', Strategist: 'amber',
      Biologist: 'cyan', Chemist: 'orange', Preclinician: 'rose'
    };
    const AGENT_EMOJIS = {
      Scout: '\u{1F52C}', Connector: '\u{1F91D}', Navigator: '\u{1F9ED}', Mobilizer: '\u{1F4B0}', Strategist: '\u{1F3AF}',
      Biologist: '\u{1F9EC}', Chemist: '\u{2697}\u{FE0F}', Preclinician: '\u{1F9EA}'
    };

    // ==========================================
    // LAB TAB DEMO DATA
    // ==========================================

    const LAB_TARGETS = [
      {
        name: 'CLN3 / Battenin', gene: 'CLN3', uniprot_id: 'Q13286',
        function: 'Lysosomal transmembrane protein involved in autophagy and endosomal sorting',
        druggability_score: 0.35, genetic_evidence: 0.95,
        pdb_file: 'data/structures/CLN3.pdb',
        pathway: 'Autophagy-lysosome pathway',
        rationale: 'Primary disease gene — loss of function causes lipofuscin accumulation',
      },
      {
        name: 'TRPML1 / Mucolipin-1', gene: 'MCOLN1', uniprot_id: 'Q9GZU1',
        function: 'Lysosomal cation channel; regulates Ca2+ release for autophagy',
        druggability_score: 0.82, genetic_evidence: 0.7,
        pdb_file: 'data/structures/TRPML1.pdb',
        pathway: 'Lysosomal Ca2+ signaling',
        rationale: 'Downstream effector — agonists rescue lysosomal function in CLN3 models',
      },
      {
        name: 'TFEB', gene: 'TFEB', uniprot_id: 'P19484',
        function: 'Master transcription factor for lysosomal biogenesis',
        druggability_score: 0.6, genetic_evidence: 0.55,
        pdb_file: 'data/structures/TFEB.pdb',
        pathway: 'CLEAR gene network / lysosomal biogenesis',
        rationale: 'Activation increases lysosomal clearance capacity — compensatory strategy',
      },
    ];

    const LAB_CANDIDATES = [
      {
        name: 'Tamoxifen', chembl_id: 'CHEMBL83', smiles: 'CC(/C=C/c1ccc(OCCN(C)C)cc1)=C(\\c1ccccc1)c1ccccc1',
        target: 'TRPML1 agonist', pchembl: 6.8, mechanism: 'Activates TRPML1 lysosomal channel → restores Ca2+ flux → enhances autophagy',
        fda_approved: true, max_phase: 4,
        indication: 'Breast cancer (current), CLN3 lysosomal rescue (proposed)',
        evidence: '2021 EMBO Mol Med — reduced lipofuscin in CLN3 mouse model',
        scores: {
          efficacy: { val: 'pChEMBL 6.8', rating: 'green' },
          oral_absorption: { val: 'PSA 12.5', rating: 'green' },
          cns_penetration: { val: 'Crosses BBB', rating: 'green' },
          herg: { val: 'IC50 > 30µM', rating: 'green' },
          cyp_inhibition: { val: 'CYP2D6 moderate', rating: 'amber' },
          solubility: { val: 'LogS -5.1', rating: 'amber' },
          selectivity: { val: '> 50x', rating: 'amber' },
          synthetic_access: { val: 'SA 2.1', rating: 'green' },
        },
        overall: 'green', recommendation: 'Advance — FDA-approved, pediatric data exists',
      },
      {
        name: 'Rapamycin', chembl_id: 'CHEMBL413', smiles: 'placeholder',
        target: 'mTOR inhibitor → TFEB activation', pchembl: 8.2, mechanism: 'Inhibits mTOR → releases TFEB → upregulates lysosomal biogenesis',
        fda_approved: true, max_phase: 4,
        indication: 'Organ transplant (current), CLN3 lysosomal clearance (proposed)',
        evidence: '2019 Autophagy — improved autophagic flux in NCL cell models',
        scores: {
          efficacy: { val: 'pChEMBL 8.2', rating: 'green' },
          oral_absorption: { val: 'PSA 195', rating: 'red' },
          cns_penetration: { val: 'Low BBB', rating: 'red' },
          herg: { val: 'IC50 > 100µM', rating: 'green' },
          cyp_inhibition: { val: 'CYP3A4 substrate', rating: 'amber' },
          solubility: { val: 'LogS -4.8', rating: 'amber' },
          selectivity: { val: '> 1000x', rating: 'green' },
          synthetic_access: { val: 'SA 6.2', rating: 'red' },
        },
        overall: 'amber', recommendation: 'Investigate CNS-penetrant analogs (e.g., everolimus)',
      },
      {
        name: 'Cysteamine', chembl_id: 'CHEMBL602', smiles: 'NCCS',
        target: 'Lysosomal cystine transporter', pchembl: 5.1, mechanism: 'Reduces lysosomal cystine accumulation → decreases oxidative stress',
        fda_approved: true, max_phase: 4,
        indication: 'Cystinosis (current), NCL neuroprotection (proposed)',
        evidence: '2020 Orphanet J Rare Dis — improved biomarkers in open-label NCL study',
        scores: {
          efficacy: { val: 'pChEMBL 5.1', rating: 'amber' },
          oral_absorption: { val: 'PSA 38', rating: 'green' },
          cns_penetration: { val: 'Crosses BBB', rating: 'green' },
          herg: { val: 'IC50 > 100µM', rating: 'green' },
          cyp_inhibition: { val: 'Minimal', rating: 'green' },
          solubility: { val: 'LogS 0.2', rating: 'green' },
          selectivity: { val: 'Broad', rating: 'red' },
          synthetic_access: { val: 'SA 1.0', rating: 'green' },
        },
        overall: 'amber', recommendation: 'Secondary candidate — supportive therapy potential',
      },
      {
        name: '4-Phenylbutyrate', chembl_id: 'CHEMBL1200983', smiles: 'O=C(O)CCCc1ccccc1',
        target: 'Chemical chaperone / HDAC inhibitor', pchembl: 4.5, mechanism: 'Stabilizes misfolded CLN3 protein → restores partial function',
        fda_approved: true, max_phase: 4,
        indication: 'Urea cycle disorders (current), CLN3 chaperone (proposed)',
        evidence: '2018 Hum Mol Genet — partial CLN3 function rescue in patient fibroblasts',
        scores: {
          efficacy: { val: 'pChEMBL 4.5', rating: 'red' },
          oral_absorption: { val: 'PSA 37', rating: 'green' },
          cns_penetration: { val: 'Moderate BBB', rating: 'amber' },
          herg: { val: 'IC50 > 100µM', rating: 'green' },
          cyp_inhibition: { val: 'Minimal', rating: 'green' },
          solubility: { val: 'LogS -1.5', rating: 'green' },
          selectivity: { val: 'Broad HDAC', rating: 'red' },
          synthetic_access: { val: 'SA 1.2', rating: 'green' },
        },
        overall: 'red', recommendation: 'Deprioritize — low potency, broad mechanism',
      },
      {
        name: 'ML-SA1', chembl_id: 'CHEMBL3246985', smiles: 'placeholder',
        target: 'TRPML1 selective agonist', pchembl: 7.1, mechanism: 'Potent selective TRPML1 agonist → lysosomal Ca2+ release',
        fda_approved: false, max_phase: 0,
        indication: 'Research tool compound — not yet in clinical development',
        evidence: '2022 Nature Chem Biol — rescued lysosomal phenotype in CLN3 iPSC neurons',
        scores: {
          efficacy: { val: 'pChEMBL 7.1', rating: 'green' },
          oral_absorption: { val: 'PSA 65', rating: 'green' },
          cns_penetration: { val: 'Unknown', rating: 'amber' },
          herg: { val: 'Not tested', rating: 'amber' },
          cyp_inhibition: { val: 'Not tested', rating: 'amber' },
          solubility: { val: 'LogS -3.8', rating: 'green' },
          selectivity: { val: '> 100x TRPML1', rating: 'green' },
          synthetic_access: { val: 'SA 3.5', rating: 'green' },
        },
        overall: 'amber', recommendation: 'High potential — needs ADMET characterization and IND-enabling studies',
      },
    ];

    const LAB_PIPELINE_FUNNEL = [
      { stage: 'Targets Identified', count: 12, color: 'cyan' },
      { stage: 'Compounds Screened', count: 847, color: 'blue' },
      { stage: 'Hits (pChEMBL ≥ 6)', count: 23, color: 'indigo' },
      { stage: 'Lead Candidates', count: 5, color: 'violet' },
      { stage: 'Lab Testing Queue', count: 2, color: 'emerald' },
    ];

    const LAB_EXPERIMENTS = [
      { tier: 1, name: 'Biochemical Assay (IC50)', compounds: 'Top 5', cost: '$8-15K', timeline: '2-4 weeks', status: 'ready' },
      { tier: 2, name: 'Cell-Based Functional Assay', compounds: 'Top 3', cost: '$15-30K', timeline: '4-6 weeks', status: 'pending' },
      { tier: 3, name: 'In Vitro ADMET Panel', compounds: 'Top 3', cost: '$10-20K', timeline: '2-3 weeks', status: 'pending' },
      { tier: 4, name: 'Mouse PK Study', compounds: 'Top 2', cost: '$20-50K', timeline: '6-8 weeks', status: 'pending' },
      { tier: 5, name: 'Efficacy in Disease Model', compounds: 'Top 1', cost: '$50-150K', timeline: '3-6 months', status: 'pending' },
    ];

    // ==========================================
    // COMMUNITY TAB DEMO DATA
    // ==========================================

    const COMMUNITY_FAMILIES = [
      { id: 1, name: 'The Martinez Family', location: 'Houston, TX', child: 'Sofia, age 8', stage: 'Established (3 yrs)', treatments: ['Cerliponase alfa (Brineura)', 'Physical therapy'], avatar: 'SM', color: 'pink', willing: ['Share treatment logs', 'Connect with new families'] },
      { id: 2, name: 'The Chen Family', location: 'San Francisco, CA', child: 'Lucas, age 6', stage: 'Recently diagnosed', treatments: ['Gene therapy trial screening'], avatar: 'LC', color: 'blue', willing: ['Share genetic test results', 'Coordinate on trials'] },
      { id: 3, name: 'The Okafor Family', location: 'Chicago, IL', child: 'Amara, age 11', stage: 'Established (5 yrs)', treatments: ['Tamoxifen (off-label pilot)', 'Seizure management'], avatar: 'AO', color: 'violet', willing: ['Share N-of-1 data', 'Advocate for funding'] },
    ];

    const COMMUNITY_DATA_COMMONS = {
      totalFamilies: 12,
      trackingSymptoms: 9,
      treatments: [
        { name: 'Cerliponase alfa (Brineura)', families: 4, avgDuration: '18 months', trend: 'stable' },
        { name: 'Tamoxifen (off-label)', families: 3, avgDuration: '4 months', trend: 'promising' },
        { name: 'Gene therapy trial', families: 2, avgDuration: '6 months', trend: 'early' },
        { name: 'Miglustat', families: 1, avgDuration: '12 months', trend: 'stable' },
      ],
      biomarkers: { avgAge: 8.3, seizureFreq: '2.1/week avg', visionDecline: '67% reporting' },
    };

    const COMMUNITY_NOF1_TRACKER = {
      experiment: 'Tamoxifen 10mg daily — CLN3 lysosomal clearance pilot',
      family: 'Okafor Family',
      startDate: '2025-10-15',
      weeks: 16,
      dataPoints: [
        { week: 0, seizures: 4, mobility: 6, cognition: 5, notes: 'Baseline' },
        { week: 4, seizures: 3, mobility: 6, cognition: 5, notes: 'Slight seizure reduction' },
        { week: 8, seizures: 2, mobility: 7, cognition: 5, notes: 'Continued improvement' },
        { week: 12, seizures: 2, mobility: 7, cognition: 6, notes: 'Cognition uptick noted' },
        { week: 16, seizures: 1, mobility: 7, cognition: 6, notes: 'Sustained response' },
      ],
    };

    const CLINICAL_TRIAL_ROADMAP = [
      { step: 'Patient Community', status: 'active', detail: '12 families connected', icon: 'users', agents: ['Connector'] },
      { step: 'Shared Data Commons', status: 'active', detail: '9 families tracking outcomes', icon: 'database', agents: ['Preclinician'] },
      { step: 'Natural History Study', status: 'next', detail: 'Mapping IRB requirements', icon: 'clipboard', agents: ['Navigator'] },
      { step: 'IND Submission', status: 'future', detail: 'Identifying FDA consultants', icon: 'file-text', agents: ['Mobilizer', 'Navigator'] },
      { step: 'IRB Approval', status: 'future', detail: 'Estimated 4-6 months after IND', icon: 'shield', agents: ['Navigator'] },
      { step: 'Phase 1 Trial', status: 'future', detail: 'Target: 2027', icon: 'activity', agents: ['Strategist', 'Mobilizer'] },
    ];

    const EXPERIMENT_FUNDING = {
      1: [{ source: 'Family GoFundMe', type: 'family', amount: '$8-15K', fit: 'Immediate, no approval needed' }, { source: 'BDSRA Pilot Grant', type: 'foundation', amount: '$10K', fit: 'Annual cycle, strong fit' }],
      2: [{ source: 'Beyond Batten Disease Foundation', type: 'foundation', amount: '$25K', fit: 'Research grants for CLN3' }, { source: 'NORD Research Grant', type: 'foundation', amount: '$30K', fit: 'Competitive, 6-month cycle' }],
      3: [{ source: 'CZI Rare As One', type: 'grant', amount: '$50K', fit: 'Supports patient-led research' }, { source: 'NCATS TRND', type: 'nih', amount: '$20K', fit: 'Pre-clinical validation' }],
      4: [{ source: 'NIH NCATS UG3/UH3', type: 'nih', amount: '$50K', fit: 'Translational research' }, { source: 'EveryCure Partnership', type: 'pharma', amount: '$30-50K', fit: 'Drug repurposing focus' }],
      5: [{ source: 'DoD CDMRP', type: 'nih', amount: '$150K', fit: 'Rare disease efficacy studies' }, { source: 'Harrington Discovery Inst.', type: 'venture', amount: '$100K+', fit: 'Venture philanthropy, requires 501(c)(3)' }],
    };

    const REPURPOSING_DEMO_DATA = {
      steps: [
        { name: 'Supporting Repurposing', desc: 'Disease characterized', done: true },
        { name: 'Identifying the Drug', desc: '47 screened, 2 candidates', done: true },
        { name: 'Validating the Drug', desc: 'Drafting protocol...', active: true },
        { name: 'Clinical Access', desc: '', done: false },
        { name: 'Reaching an Endpoint', desc: '', done: false },
      ],
      candidates: [
        { name: 'Tamoxifen', stage: 'Lead', mechanism: 'TRPML1 agonist', fdaApproved: true, pediatricData: true },
        { name: '4-Phenylbutyrate (4-PBA)', stage: 'Early', mechanism: 'Chemical chaperone', fdaApproved: true, pediatricData: false },
      ],
      council: [
        { agent: 'Scout', text: 'ChEMBL screen returned 47 compounds. Tamoxifen shows TRPML1 agonist activity at clinically achievable doses. Found 2 off-label case reports in adult NCL patients.' },
        { agent: 'Navigator', text: 'FDA-approved since 1977. Pediatric dosing from precocious puberty studies. Off-label use needs physician agreement only \u2014 no IND required.' },
        { agent: 'Strategist', text: 'Dual track: tamoxifen near-term (months) + AAV9 gene therapy long-term. These are complementary, not competing.' },
        { agent: 'Scout', text: '4-PBA is a secondary candidate \u2014 chemical chaperone that may stabilize misfolded CLN3 protein. Less evidence but worth monitoring.' },
        { agent: 'Connector', text: 'Dr. Bhatt at UCL has published on lysosomal channel modulators in NCL models. Recommending outreach.' },
        { agent: 'Navigator', text: 'For tamoxifen: off-label prescribing is the fastest path. Compassionate use (FDA Form 3926) as backup if physician is hesitant.' },
        { agent: 'Mobilizer', text: 'EveryCure offers free consultation for rare disease drug repurposing using their ROADMAP framework. Recommending outreach.' },
        { agent: 'Strategist', text: 'Action items: (1) Specialist briefing on tamoxifen for your neurologist, (2) EveryCure outreach, (3) Continue gene therapy trial pre-screening.' },
      ],
    };

    const TIMELINE_MILESTONES = [
      { icon: 'file-check', color: 'emerald', title: 'Initial Analysis Complete', desc: '127 papers, 8 trials, 34 compounds analyzed', major: false, stats: [{ label: 'Target', value: 'CLN3 / Battenin' }, { label: 'Trials', value: '3 recruiting' }] },
      { icon: 'microscope', color: 'indigo', title: 'Drug Repurposing Candidate Found', desc: 'Tamoxifen identified via ChEMBL screen', major: true },
      { icon: 'flask-conical', color: 'blue', title: 'Clinical Trial Match: 89%', desc: 'Phase I/II AAV9-CLN3 at Weill Cornell \u2014 8/9 criteria met', major: false },
      { icon: 'mail', color: 'pink', title: 'Outreach Email Drafted', desc: 'Email to Dr. Cooper about AAV9-CLN3 trial', major: false, pending: true },
    ];

    const JOURNEY_ACHIEVEMENTS = [
      { text: 'Found active gene therapy trial at Weill Cornell' },
      { text: 'Identified tamoxifen as repurposing candidate' },
      { text: 'FDA orphan drug pathway confirmed viable' },
    ];

    const INSIGHT_CARDS = [
      {
        id: 'trial',
        badge: 'Clinical Trial Match', badgeColor: 'indigo',
        title: 'Phase I/II AAV9-CLN3 Gene Therapy',
        subtitle: 'Weill Cornell Medical Center',
        description: 'Intrathecal AAV9 delivery targeting CLN3 protein restoration. Your child meets 8 of 9 eligibility criteria.',
        matchBar: { pct: 89, label: '89% match' },
        cta: 'Start Pre-Screening',
        whatItMeans: {
          summary: "This is an experimental treatment being tested for the first time in children with CLN3. Doctors insert a corrected copy of the CLN3 gene using a harmless virus.",
          proceed: "We'll help you contact the trial team and start a pre-screening conversation. No commitment yet.",
          timeline: "Pre-screening takes 2-4 weeks. Enrollment decisions are made by the trial team, not us.",
          caveat: "This is Phase I/II \u2014 safety is still being evaluated. Your care team should be part of this conversation.",
        },
      },
      {
        id: 'repurpose',
        badge: 'Breakthrough', badgeColor: 'indigo',
        title: 'Drug Repurposing: Tamoxifen',
        subtitle: 'Scout + Navigator + Strategist',
        description: 'Tamoxifen activates the TRPML1 lysosomal channel that CLN3 patients are missing. FDA-approved with existing pediatric safety data.',
        cta: 'Generate Specialist Briefing',
        whatItMeans: {
          summary: "Tamoxifen is a well-known, safe medication already approved by the FDA for other conditions. Researchers found it may also help with the specific protein problem in CLN3.",
          proceed: "We'll generate a briefing document your neurologist can review. They would decide if it's appropriate for your child.",
          timeline: "This could move fast \u2014 weeks, not months. It's a conversation with your existing doctor, not a new trial.",
          caveat: "This is \"off-label\" use \u2014 legal and common, but not specifically tested for CLN3 in clinical trials yet.",
        },
      },
    ];

    const DECISION_QUEUE = [
      {
        id: 'email',
        badge: 'Needs Your Approval', badgeColor: 'amber',
        title: 'Email to Dr. Jonathan Cooper',
        subtitle: 'Connector agent',
        description: "Personalized introduction about your family's CLN3 journey and interest in his AAV9 gene therapy research at Weill Cornell.",
        cta: 'Review & Approve',
        whatItMeans: {
          summary: "Your Connector agent drafted a professional, warm email introducing your family to the lead researcher on the gene therapy trial your child matched with.",
          proceed: "You'll see the full email and can edit it before sending. Nothing goes out without your OK.",
          timeline: "Researchers typically respond within 1-2 weeks. We'll follow up if needed.",
          caveat: "This is an introduction, not a commitment. You're starting a conversation, not signing up for anything.",
        },
      },
      {
        id: 'everycure',
        badge: 'Needs Your Approval', badgeColor: 'amber',
        title: 'Contact EveryCure for Repurposing Guidance',
        subtitle: 'Mobilizer agent',
        description: 'EveryCure offers free consultation for rare disease drug repurposing using their ROADMAP framework. They can help validate the tamoxifen pathway.',
        cta: 'Approve Outreach',
        whatItMeans: {
          summary: "EveryCure is a nonprofit that helps families find existing drugs that might work for their child's condition. Their service is completely free.",
          proceed: "We'll send a brief outreach to EveryCure explaining your situation. They'll schedule a consultation call with you.",
          timeline: "They typically respond within a few days. The consultation itself is about 30 minutes.",
          caveat: "EveryCure provides guidance, not medical advice. Any treatment decisions still go through your doctor.",
        },
      },
    ];

    function isDemo() {
      const params = new URLSearchParams(window.location.search);
      // Default to demo mode unless ?live is set (for local dev with running orchestrator)
      return !params.has('live');
    }

    // Helper to fetch and unwrap JSON
    const fetchReport = async (url) => {
      try {
        const res = await fetch(url);
        if (!res.ok) return null;
        const text = await res.text();
        let data;
        try { data = JSON.parse(text); } catch {
          const match = text.match(/```(?:json)?\s*([\s\S]*?)```/);
          if (match) data = JSON.parse(match[1]); else return null;
        }
        if (data && data.type === 'result' && typeof data.result === 'string') {
          try { return JSON.parse(data.result); } catch { return null; }
        }
        return data;
      } catch { return null; }
    };

    // ==========================================
    // MAIN APP
    // ==========================================

    function App() {
      const [view, setView] = useState('onboarding'); // 'onboarding' | 'dashboard'
      const [onboardingStep, setOnboardingStep] = useState(1);
      const [mission, setMission] = useState({
        disease: '', journeyStage: 'just-diagnosed', patient: 'child', location: 'us',
      });
      const [modalOpen, setModalOpen] = useState(false);
      const [selectedApproval, setSelectedApproval] = useState(null);
      const [activeTab, setActiveTab] = useState('dashboard');
      const [communitySection, setCommunitySection] = useState('network');
      const [showArch, setShowArch] = useState(false);

      const demo = isDemo();

      useEffect(() => {
        if (demo && !mission.disease) {
          setMission({ disease: 'Batten Disease (CLN3)', journeyStage: 'just-diagnosed', patient: 'child', location: 'us' });
        }
      }, [demo]);

      return (
        <>
          {view === 'onboarding' ? (
            <OnboardingView
              step={onboardingStep}
              setStep={setOnboardingStep}
              mission={mission}
              setMission={setMission}
              onEnterDashboard={() => setView('dashboard')}
              demo={demo}
            />
          ) : (
            <DashboardView
              mission={mission}
              demo={demo}
              setModalOpen={setModalOpen}
              setSelectedApproval={setSelectedApproval}
              activeTab={activeTab}
              setActiveTab={setActiveTab}
              communitySection={communitySection}
              setCommunitySection={setCommunitySection}
            />
          )}
          {modalOpen && selectedApproval && (
            <ApprovalModal approval={selectedApproval} onClose={() => setModalOpen(false)} />
          )}
          {/* <NarrationPlayer view={view} step={onboardingStep} activeTab={activeTab} communitySection={communitySection} /> */}
        </>
      );
    }

    // ==========================================
    // NARRATION SYSTEM
    // ==========================================

    const NARRATION_CLIPS = [
      { key: 'welcome',           trigger: { view: 'onboarding', step: 1 },                    text: "Every year, 300 million people worldwide are affected by rare diseases. Most have no approved treatment. When a family gets this diagnosis, they're on their own — navigating science, regulation, and funding with no expertise. Beacon changes that. Built almost entirely with Claude Code and Opus 4.6, Beacon is a team of AI agents that works continuously on a family's behalf." },
      { key: 'intake',            trigger: { view: 'onboarding', step: 2 },                    text: "The journey starts with a simple intake — disease name, patient context, location. Behind the scenes, this seeds every agent's system prompt with structured context, so Opus 4.6 can reason about jurisdiction-specific regulatory paths and personalized research strategies from the first query." },
      { key: 'agents_activating', trigger: { view: 'dashboard', tab: 'dashboard', delay: 500 }, text: "When the family clicks Launch, Beacon's orchestrator spins up eight Claude Code sub-agents in parallel — each powered by Opus 4.6 with a specialized system prompt. Scout searches bioRxiv, PubMed, and ClinicalTrials.gov through Anthropic's healthcare MCP connectors. Navigator queries the CMS Coverage database and maps FDA orphan drug pathways. Connector cross-references the NPI Registry to verify physician credentials. Each agent writes structured JSON that the dashboard polls in real time." },
      { key: 'progress',          trigger: { view: 'dashboard', tab: 'dashboard', delay: 20000 }, text: "What you're watching is live agent output streaming into the UI. Each progress bar, each status update, each achievement — those are real structured outputs from Opus 4.6 sub-agents writing to shared state files. The orchestrator coordinates task dependencies so agents can hand off findings to each other." },
      { key: 'insights',          trigger: { view: 'dashboard', tab: 'dashboard', delay: 40000 }, text: "These insights are the cross-agent synthesis — Scout found a clinical trial, Navigator checked the regulatory precedent, Mobilizer identified matching grant funding. This research-to-action chain is what sets Beacon apart. Other tools stop at search results. Beacon executes the full pipeline." },
      { key: 'approvals',         trigger: { view: 'dashboard', tab: 'dashboard', delay: 55000 }, text: "Human-in-the-loop for consequential actions. The agent drafts an outreach email to a researcher it identified through PubMed and verified through the NPI Registry. The family reviews and approves. Progressive trust — the AI proposes, the human decides." },
      { key: 'lab_overview',      trigger: { view: 'dashboard', tab: 'lab' },                  text: "The Drug Discovery Lab pushes Opus 4.6 further. Three specialized agents — Biologist, Chemist, Preclinician — use the ChEMBL MCP connector to search bioactive compounds, retrieve IC50 values, and evaluate ADMET properties. This is real drug discovery reasoning, not keyword search." },
      { key: 'lab_candidates',    trigger: { view: 'dashboard', tab: 'lab', delay: 15000 },    text: "The candidate pipeline ranks compounds by predicted efficacy, safety profile, and clinical precedent — all extracted from ChEMBL's curated database of bioactive molecules. Each agent's reasoning chain is fully traceable." },
      { key: 'community_network', trigger: { view: 'dashboard', tab: 'community' },            text: "Beacon's Connector agent builds a family network — matching by geography, disease variant, and treatment stage. Every connection requires family approval. Privacy by design." },
      { key: 'community_data',    trigger: { view: 'dashboard', tab: 'community', communitySubTab: 'data' }, text: "When families opt in to share outcomes, Beacon's agents analyze the pooled data — identifying treatment patterns, adverse events, and response rates. For ultra-rare diseases, this community evidence may be the only data that exists." },
      { key: 'closing',           trigger: { auto_after: 'community_data' }, text: "Beacon is a team of AI agents that never stops working — researching, connecting, strategizing, funding — all orchestrated by Claude Code and powered by Opus 4.6. No family should have to fight alone." },
    ];

    function NarrationPlayer({ view, step, activeTab, communitySection }) {
      const [currentIdx, setCurrentIdx] = useState(-1);
      const [playing, setPlaying] = useState(false);
      const [muted, setMuted] = useState(false);
      const [transcriptVisible, setTranscriptVisible] = useState(false);
      const [played, setPlayed] = useState(() => {
        try { return new Set(JSON.parse(sessionStorage.getItem('beacon_narration_played') || '[]')); } catch { return new Set(); }
      });
      const playedRef = useRef(played);
      const audioRef = useRef(null);
      const timersRef = useRef([]);

      // Persist played state and sync ref
      useEffect(() => {
        playedRef.current = played;
        sessionStorage.setItem('beacon_narration_played', JSON.stringify([...played]));
      }, [played]);

      // Determine which clip should play based on current view/tab
      useEffect(() => {
        timersRef.current.forEach(clearTimeout);
        timersRef.current = [];

        NARRATION_CLIPS.forEach((clip, idx) => {
          const t = clip.trigger;
          if (t.auto_after) return; // auto_after clips are handled in onended
          const viewMatch = (t.view === 'onboarding' && view === 'onboarding' && t.step === step) ||
                            (t.view === 'dashboard' && view === 'dashboard' && (!t.tab || t.tab === activeTab) && (!t.communitySubTab || t.communitySubTab === communitySection));
          if (!viewMatch) return;

          const delay = t.delay || 0;
          const timer = setTimeout(() => {
            if (playedRef.current.has(clip.key)) return; // check at fire time, not schedule time
            setCurrentIdx(prev => {
              if (prev === -1 || prev < idx) return idx;
              return prev;
            });
          }, delay);
          timersRef.current.push(timer);
        });

        return () => timersRef.current.forEach(clearTimeout);
      }, [view, step, activeTab, communitySection]);

      // Play audio when currentIdx changes
      useEffect(() => {
        if (currentIdx < 0 || currentIdx >= NARRATION_CLIPS.length) return;
        const clip = NARRATION_CLIPS[currentIdx];
        if (played.has(clip.key)) return;

        if (audioRef.current) {
          audioRef.current.pause();
          audioRef.current = null;
        }

        const audio = new Audio(`audio/${clip.key}.mp3`);
        audio.muted = muted;
        audioRef.current = audio;

        audio.play().then(() => {
          setPlaying(true);
          setPlayed(prev => new Set([...prev, clip.key]));
        }).catch(() => {
          // Autoplay blocked — user hasn't interacted yet
          setPlaying(false);
        });

        audio.onended = () => {
          setPlaying(false);
          // Auto-advance to next unplayed clip if it chains via auto_after or matches current context
          const next = currentIdx + 1;
          if (next < NARRATION_CLIPS.length) {
            const nc = NARRATION_CLIPS[next];
            const t = nc.trigger;
            if (t.auto_after === clip.key && !played.has(nc.key)) {
              setCurrentIdx(next);
            } else {
              const viewMatch = (t.view === 'onboarding' && view === 'onboarding' && t.step === step) ||
                                (t.view === 'dashboard' && view === 'dashboard' && (!t.tab || t.tab === activeTab));
              if (viewMatch && !played.has(nc.key) && !t.delay) {
                setCurrentIdx(next);
              }
            }
          }
        };

        return () => { audio.pause(); };
      }, [currentIdx]);

      // Sync mute state
      useEffect(() => {
        if (audioRef.current) audioRef.current.muted = muted;
      }, [muted]);

      const togglePlay = () => {
        if (!audioRef.current) {
          // Try playing current clip
          if (currentIdx >= 0) {
            const clip = NARRATION_CLIPS[currentIdx];
            const audio = new Audio(`audio/${clip.key}.mp3`);
            audio.muted = muted;
            audioRef.current = audio;
            audio.play().then(() => setPlaying(true)).catch(() => {});
            audio.onended = () => setPlaying(false);
          }
          return;
        }
        if (playing) { audioRef.current.pause(); setPlaying(false); }
        else { audioRef.current.play().then(() => setPlaying(true)).catch(() => {}); }
      };

      const skipForward = () => {
        if (audioRef.current) { audioRef.current.pause(); audioRef.current = null; }
        setPlaying(false);
        const next = currentIdx + 1;
        if (next < NARRATION_CLIPS.length) setCurrentIdx(next);
      };

      const currentClip = currentIdx >= 0 && currentIdx < NARRATION_CLIPS.length ? NARRATION_CLIPS[currentIdx] : null;
      const clipNum = currentIdx + 1;
      const totalClips = NARRATION_CLIPS.length;

      if (!currentClip && played.size === 0) return null;

      return (
        <>
          {/* Floating Guide pill */}
          <div className="fixed bottom-20 md:bottom-6 right-4 md:right-6 z-[9999] flex items-center gap-2 bg-white/90 backdrop-blur-md shadow-xl rounded-full px-3 sm:px-4 py-2 sm:py-2.5 border border-slate-200">
            <span className="text-[10px] font-semibold text-indigo-500 uppercase tracking-wider mr-0.5">Guide</span>
            <button onClick={togglePlay} className="w-8 h-8 flex items-center justify-center rounded-full bg-indigo-600 text-white hover:bg-indigo-700 transition-colors" title={playing ? 'Pause' : 'Play'}>
              {playing ? (
                <svg width="14" height="14" viewBox="0 0 14 14" fill="currentColor"><rect x="2" y="1" width="3.5" height="12" rx="1"/><rect x="8.5" y="1" width="3.5" height="12" rx="1"/></svg>
              ) : (
                <svg width="14" height="14" viewBox="0 0 14 14" fill="currentColor"><polygon points="3,1 13,7 3,13"/></svg>
              )}
            </button>
            <button onClick={skipForward} className="w-7 h-7 flex items-center justify-center rounded-full text-slate-500 hover:text-indigo-600 hover:bg-indigo-50 transition-colors" title="Skip">
              <svg width="14" height="14" viewBox="0 0 14 14" fill="currentColor"><polygon points="1,1 9,7 1,13"/><rect x="10" y="1" width="3" height="12" rx="1"/></svg>
            </button>
            <button onClick={() => setMuted(!muted)} className="w-7 h-7 flex items-center justify-center rounded-full text-slate-500 hover:text-indigo-600 hover:bg-indigo-50 transition-colors" title={muted ? 'Unmute' : 'Mute'}>
              {muted ? (
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M11 5L6 9H2v6h4l5 4V5z"/><line x1="23" y1="9" x2="17" y2="15"/><line x1="17" y1="9" x2="23" y2="15"/></svg>
              ) : (
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M11 5L6 9H2v6h4l5 4V5z"/><path d="M19.07 4.93a10 10 0 010 14.14M15.54 8.46a5 5 0 010 7.07"/></svg>
              )}
            </button>
            <span className="text-xs text-slate-400 font-medium ml-1">{clipNum > 0 ? clipNum : '–'} / {totalClips}</span>
            <button onClick={() => setTranscriptVisible(!transcriptVisible)} className={`w-7 h-7 flex items-center justify-center rounded-full transition-colors ml-1 ${transcriptVisible ? 'text-indigo-600 bg-indigo-50' : 'text-slate-500 hover:text-indigo-600 hover:bg-indigo-50'}`} title="Toggle subtitles">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="M7 15h4M13 15h4M7 11h10"/></svg>
            </button>
          </div>

          {/* Subtitle bar */}
          {transcriptVisible && currentClip && playing && (
            <div className="fixed bottom-32 md:bottom-20 left-1/2 -translate-x-1/2 z-[9998] max-w-[700px] w-[90%] bg-black/75 text-white text-xs sm:text-sm px-4 sm:px-5 py-2.5 sm:py-3 rounded-xl text-center backdrop-blur-sm leading-relaxed">
              {currentClip.text}
            </div>
          )}
        </>
      );
    }

    // ==========================================
    // ONBOARDING VIEW (3 steps, single page)
    // ==========================================

    function OnboardingView({ step, setStep, mission, setMission, onEnterDashboard, demo }) {
      const [searchQuery, setSearchQuery] = useState(demo ? 'Batten Disease (CLN3)' : '');
      const [showDropdown, setShowDropdown] = useState(false);
      const [filteredDiseases, setFilteredDiseases] = useState([]);

      const handleSearchChange = (e) => {
        const query = e.target.value;
        setSearchQuery(query);
        setMission({ ...mission, disease: query });
        if (query.trim().length > 0) {
          const q = query.toLowerCase();
          const matches = RARE_DISEASES.filter(d =>
            d.name.toLowerCase().includes(q) || d.aliases.some(a => a.toLowerCase().includes(q))
          ).slice(0, 8);
          setFilteredDiseases(matches);
          setShowDropdown(true);
        } else {
          setFilteredDiseases([]);
          setShowDropdown(false);
        }
      };

      const selectDisease = (d) => {
        setSearchQuery(d.name);
        setMission({ ...mission, disease: d.name });
        setShowDropdown(false);
      };

      const goStep = (n) => setStep(n);

      const stepNav = [
        { num: 1, label: 'Welcome', sub: 'Meet Beacon' },
        { num: 2, label: 'Connect', sub: 'Your Situation' },
      ];

      return (
        <div className="min-h-screen flex items-center justify-center p-4 sm:p-6">
          <div className="max-w-4xl w-full grid grid-cols-1 md:grid-cols-12 gap-6 md:gap-8">

            {/* Left: Step sidebar */}
            <div className="hidden md:block md:col-span-4 pt-10 space-y-6">
              <div className="flex items-center gap-3 mb-10">
                <div className="w-10 h-10 bg-gradient-to-br from-amber-500 to-amber-600 rounded-xl flex items-center justify-center text-white font-black text-lg shadow-lg shadow-amber-200">B</div>
                <span className="text-xl font-extrabold bg-gradient-to-r from-amber-600 to-amber-500 bg-clip-text text-transparent">Beacon</span>
              </div>

              {stepNav.map(s => (
                <div key={s.num} className={`flex items-center gap-4 ${step < s.num ? 'step-inactive' : ''}`}>
                  <div className={`w-10 h-10 rounded-full flex items-center justify-center font-bold text-white ${step >= s.num ? 'bg-indigo-600 shadow-md shadow-indigo-200' : 'bg-slate-300'}`}>{s.num}</div>
                  <div>
                    <p className={`text-[10px] font-bold uppercase tracking-wider ${step >= s.num ? 'text-indigo-600' : 'text-slate-400'}`}>{s.label}</p>
                    <p className="text-sm font-semibold text-slate-800">{s.sub}</p>
                  </div>
                </div>
              ))}
            </div>

            {/* Right: Content cards */}
            <div className="md:col-span-8">

              {/* Step 1: Privacy */}
              {step === 1 && (
                <div className="bg-white rounded-3xl p-6 sm:p-10 shadow-xl border border-slate-200 fade-up">
                  <div className="w-16 h-16 sm:w-20 sm:h-20 bg-gradient-to-br from-amber-500 to-amber-600 rounded-2xl flex items-center justify-center text-white font-black text-3xl sm:text-4xl mb-6 shadow-lg shadow-amber-200">B</div>
                  <h2 className="text-2xl sm:text-3xl font-bold mb-4">Your AI-powered team for rare disease.</h2>
                  <p className="text-slate-500 mb-8 leading-relaxed text-lg">Beacon coordinates research, outreach, regulatory strategy, and funding — so no family has to navigate the system alone.</p>

                  <div className="bg-slate-50 rounded-2xl p-5 border border-slate-100 mb-8 space-y-3">
                    {['Your data is never used to train models.', 'All actions requiring external contact need your approval.', 'Revoke agent access or delete everything at any time.'].map((t, i) => (
                      <div key={i} className="flex items-center gap-3 text-xs font-medium text-slate-500">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#10b981" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
                        {t}
                      </div>
                    ))}
                  </div>

                  <button onClick={() => goStep(2)} className="w-full bg-indigo-600 text-white py-4 rounded-2xl font-bold text-lg hover:bg-indigo-700 transition-all shadow-lg shadow-indigo-200">
                    Get Started
                  </button>
                </div>
              )}

              {/* Step 2: Situation */}
              {step === 2 && (
                <div className="bg-white rounded-3xl p-6 sm:p-10 shadow-xl border border-slate-200 fade-up">
                  <h2 className="text-2xl sm:text-3xl font-bold mb-2">Tell us about your journey.</h2>
                  <p className="text-slate-500 mb-8">This helps your AI team personalize their research.</p>

                  {/* Journey stage */}
                  <div className="space-y-3 mb-8">
                    {JOURNEY_STAGES.map(js => (
                      <button
                        key={js.id}
                        onClick={() => setMission({ ...mission, journeyStage: js.id })}
                        className={`w-full flex items-center gap-4 p-4 rounded-2xl border-2 transition-all text-left ${mission.journeyStage === js.id ? 'border-indigo-600 bg-indigo-50' : 'border-slate-200 hover:border-indigo-300'}`}
                      >
                        <span className="text-2xl">{js.emoji}</span>
                        <div>
                          <div className="font-bold text-slate-800">{js.title}</div>
                          <div className="text-xs text-slate-500">{js.desc}</div>
                        </div>
                      </button>
                    ))}
                  </div>

                  {/* Disease input */}
                  {mission.journeyStage !== 'pre-diagnosis' && (
                    <div className="mb-8">
                      <label className="text-sm font-bold text-slate-700 block mb-2">Condition</label>
                      <div className="relative">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#94a3b8" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="absolute left-4 top-1/2 -translate-y-1/2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                        <input
                          type="text"
                          placeholder="Search for a rare disease..."
                          value={searchQuery}
                          onChange={handleSearchChange}
                          onFocus={() => { if (filteredDiseases.length > 0) setShowDropdown(true); }}
                          onBlur={() => setTimeout(() => setShowDropdown(false), 200)}
                          className="w-full pl-12 pr-4 py-3.5 border-2 border-slate-200 rounded-xl text-base focus:outline-none focus:border-indigo-500 bg-slate-50"
                          autoFocus
                        />
                        {showDropdown && filteredDiseases.length > 0 && (
                          <div className="absolute top-full left-0 right-0 bg-white border-2 border-slate-200 border-t-0 rounded-b-xl shadow-lg z-50 max-h-72 overflow-y-auto">
                            {filteredDiseases.map((d, i) => (
                              <div key={i} className="px-4 py-3 cursor-pointer hover:bg-amber-50 border-b border-slate-100 last:border-0" onMouseDown={() => selectDisease(d)}>
                                <div className="font-semibold text-slate-800">{d.name}</div>
                                <div className="text-xs text-slate-400">{d.aliases.join(' \u00B7 ')}</div>
                              </div>
                            ))}
                          </div>
                        )}
                      </div>
                    </div>
                  )}

                  {/* Upload zone for pre-dx */}
                  {mission.journeyStage === 'pre-diagnosis' && (
                    <div className="mb-8">
                      <label className="text-sm font-bold text-slate-700 block mb-2">Medical Records</label>
                      <div className="border-2 border-dashed border-slate-300 rounded-2xl p-8 flex flex-col items-center bg-slate-50 hover:border-indigo-300 hover:bg-indigo-50/30 transition-all cursor-pointer">
                        <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#94a3b8" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round"><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M12 12v9"/><path d="m16 16-4-4-4 4"/></svg>
                        <p className="font-bold text-slate-600 text-sm mt-3">Drop files here</p>
                        <p className="text-[11px] text-slate-400 mt-1">PDF, JPG, PNG, or Medical XML</p>
                      </div>
                      <textarea placeholder="Or describe symptoms and timeline in your own words..." className="mt-3 w-full p-3 border-2 border-slate-200 rounded-xl text-sm resize-none h-20 focus:outline-none focus:border-indigo-500"></textarea>
                    </div>
                  )}

                  {/* Quick intake */}
                  <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-8">
                    <div>
                      <label className="text-sm font-bold text-slate-700 block mb-2">Patient is</label>
                      <div className="flex gap-2">
                        {[{label: 'My child', id: 'child'}, {label: 'A family member', id: 'family'}, {label: 'Myself', id: 'myself'}].map(({label, id}) => {
                          return (
                            <button key={id} onClick={() => setMission({ ...mission, patient: id })}
                              className={`flex-1 py-2 rounded-lg border-2 text-sm font-semibold ${mission.patient === id ? 'border-indigo-600 bg-indigo-50 text-indigo-700' : 'border-slate-200 text-slate-600 hover:border-slate-300'}`}>
                              {label}
                            </button>
                          );
                        })}
                      </div>
                    </div>
                    <div>
                      <label className="text-sm font-bold text-slate-700 block mb-2">Location</label>
                      <div className="flex gap-2">
                        {['US', 'EU', 'Other'].map(label => {
                          const id = label.toLowerCase();
                          return (
                            <button key={id} onClick={() => setMission({ ...mission, location: id })}
                              className={`flex-1 py-2 rounded-lg border-2 text-sm font-semibold ${mission.location === id ? 'border-indigo-600 bg-indigo-50 text-indigo-700' : 'border-slate-200 text-slate-600 hover:border-slate-300'}`}>
                              {label}
                            </button>
                          );
                        })}
                      </div>
                    </div>
                  </div>

                  <button
                    onClick={onEnterDashboard}
                    disabled={mission.journeyStage !== 'pre-diagnosis' && !mission.disease}
                    className="w-full bg-indigo-600 text-white py-4 rounded-2xl font-bold text-lg hover:bg-indigo-700 transition-all shadow-lg shadow-indigo-200 disabled:opacity-40 disabled:cursor-not-allowed"
                  >
                    Launch Your Team &rarr;
                  </button>
                </div>
              )}

            </div>
          </div>
        </div>
      );
    }

    // ==========================================
    // DASHBOARD VIEW
    // ==========================================

    // ==========================================
    // WHAT-IT-MEANS ACCORDION (shared)
    // ==========================================
    function WhatItMeansAccordion({ item, expanded, onToggle }) {
      return (
        <>
          <button onClick={onToggle} className="flex items-center gap-1.5 text-slate-400 text-[11px] font-bold mb-3 hover:text-indigo-600 transition-colors self-start">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
            What this means for your family
            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={`chevron ${expanded ? 'rotated' : ''}`}><path d="m6 9 6 6 6-6"/></svg>
          </button>
          {expanded && (
            <div className="bg-slate-50 rounded-2xl p-4 mb-4 border border-slate-100 fade-up">
              <p className="text-sm text-slate-700 leading-relaxed mb-3">{item.whatItMeans.summary}</p>
              <div className="space-y-2.5">
                <div className="flex items-start gap-2.5">
                  <div className="w-5 h-5 rounded-full bg-emerald-100 flex items-center justify-center shrink-0 mt-0.5">
                    <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="#059669" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
                  </div>
                  <p className="text-xs text-slate-600"><strong className="text-slate-800">If you proceed:</strong> {item.whatItMeans.proceed}</p>
                </div>
                <div className="flex items-start gap-2.5">
                  <div className="w-5 h-5 rounded-full bg-blue-100 flex items-center justify-center shrink-0 mt-0.5">
                    <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="#2563eb" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                  </div>
                  <p className="text-xs text-slate-600"><strong className="text-slate-800">Timeline:</strong> {item.whatItMeans.timeline}</p>
                </div>
                <div className="flex items-start gap-2.5">
                  <div className="w-5 h-5 rounded-full bg-amber-100 flex items-center justify-center shrink-0 mt-0.5">
                    <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="#d97706" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>
                  </div>
                  <p className="text-xs text-slate-600"><strong className="text-slate-800">Good to know:</strong> {item.whatItMeans.caveat}</p>
                </div>
              </div>
            </div>
          )}
        </>
      );
    }

    // ==========================================
    // INSIGHT CARD (spatial canvas style)
    // ==========================================
    function InsightCard({ insight, expanded, onToggle, onLater, onAction }) {
      return (
        <div className="bg-white rounded-3xl p-6 shadow-xl border border-slate-200 card-hover flex flex-col fade-up">
          <span className={`bg-${insight.badgeColor}-600 text-white text-[9px] font-black px-2.5 py-0.5 rounded-md uppercase self-start`}>{insight.badge}</span>
          <h3 className="font-bold text-slate-900 text-lg mt-3 mb-1">{insight.title}</h3>
          <p className="text-[11px] text-slate-400 font-medium mb-3">{insight.subtitle}</p>
          <p className="text-sm text-slate-600 leading-relaxed mb-4">{insight.description}</p>
          {insight.matchBar && (
            <div className="flex items-center gap-3 mb-4">
              <div className="flex-1 bg-slate-100 h-2 rounded-full overflow-hidden">
                <div className="bg-indigo-500 h-full rounded-full" style={{ width: `${insight.matchBar.pct}%` }}></div>
              </div>
              <span className="text-xs font-bold text-indigo-600">{insight.matchBar.label}</span>
            </div>
          )}
          <WhatItMeansAccordion item={insight} expanded={expanded} onToggle={onToggle} />
          <div className="mt-auto flex gap-3">
            <button onClick={() => onAction && onAction(insight)} className="flex-1 bg-indigo-600 text-white py-3 rounded-xl text-xs font-bold shadow-md hover:bg-indigo-700 transition-colors">{insight.cta}</button>
            <button onClick={onLater} className="px-4 py-3 text-slate-400 rounded-xl text-xs font-bold border border-slate-200 hover:bg-slate-50 hover:text-slate-600 transition-colors flex items-center gap-1.5">
              <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
              Later
            </button>
          </div>
        </div>
      );
    }

    // ==========================================
    // DELEGATION INBOX (Tinder-style)
    // ==========================================
    function DelegationInbox({ expandedId, onToggle, onApprove, onLater }) {
      const [queue, setQueue] = useState([...DECISION_QUEUE]);
      const [animating, setAnimating] = useState(null);

      const handleAction = (action) => {
        const current = queue[0];
        setAnimating(action);
        setTimeout(() => {
          if (action === 'approve') onApprove(current);
          else onLater(current);
          setQueue(prev => prev.slice(1));
          setAnimating(null);
        }, 300);
      };

      if (queue.length === 0) {
        return (
          <div className="text-center py-8 fade-up">
            <div className="w-16 h-16 bg-emerald-100 rounded-full flex items-center justify-center mx-auto mb-3">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#059669" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
            </div>
            <h3 className="font-bold text-slate-700">All caught up!</h3>
            <p className="text-xs text-slate-400 mt-1">Your agents will notify you when new items need attention.</p>
          </div>
        );
      }

      const current = queue[0];
      const expanded = expandedId === current.id;

      return (
        <div className="max-w-md mx-auto">
          <div className="text-center mb-5">
            <p className="text-[10px] font-black text-amber-600 uppercase tracking-widest">Needs Your Sign-Off</p>
          </div>
          <div className="relative" style={{ minHeight: '320px' }}>
            {queue.length > 2 && <div className="absolute inset-0 translate-y-5 scale-[0.92] bg-white/30 rounded-[32px] border border-slate-200 z-10"></div>}
            {queue.length > 1 && <div className="absolute inset-0 translate-y-2.5 scale-[0.96] bg-white/50 rounded-[32px] border border-slate-200 z-20"></div>}

            <div className={`relative z-30 bg-white rounded-[32px] shadow-2xl border border-amber-200 p-6 flex flex-col ${animating === 'approve' ? 'slide-out' : animating === 'reject' ? 'slide-out-left' : 'fade-up'}`}>
              <span className="bg-amber-100 text-amber-800 text-[9px] font-black px-2.5 py-0.5 rounded-md uppercase self-start">{current.badge}</span>
              <h3 className="font-bold text-slate-900 text-lg mt-3 mb-1">{current.title}</h3>
              <p className="text-[11px] text-slate-400 font-medium mb-3">{current.subtitle}</p>
              <p className="text-sm text-slate-600 leading-relaxed mb-4">{current.description}</p>

              <WhatItMeansAccordion item={current} expanded={expanded} onToggle={() => onToggle(current.id)} />

              <div className="grid grid-cols-2 gap-3 mt-auto">
                <button onClick={() => handleAction('reject')} className="py-3 bg-slate-100 text-slate-500 rounded-2xl font-bold text-xs flex items-center justify-center gap-2 hover:bg-red-50 hover:text-red-500 transition-colors">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                  Later
                </button>
                <button onClick={() => handleAction('approve')} className="py-3 bg-amber-500 text-white rounded-2xl font-bold text-xs flex items-center justify-center gap-2 shadow-lg shadow-amber-200 hover:bg-amber-600 transition-colors">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
                  {current.cta}
                </button>
              </div>
            </div>
          </div>
          {queue.length > 1 && <p className="mt-4 text-center text-[11px] text-slate-400 font-bold">{queue.length - 1} more in queue</p>}
        </div>
      );
    }

    function DashboardView({ mission, demo, setModalOpen, setSelectedApproval, activeTab, setActiveTab, communitySection, setCommunitySection }) {
      const [expandedSections, setExpandedSections] = useState({});
      const [expandedId, setExpandedId] = useState(null);
      const [laterItems, setLaterItems] = useState([]);
      const [showToast, setShowToast] = useState(null);
      const [state, setState] = useState(null);
      const [summaryText, setSummaryText] = useState('Analyzing CLN3 Batten Disease...');
      const [summaryDone, setSummaryDone] = useState(false);
      const [achievements, setAchievements] = useState([]);
      const [visibleInsights, setVisibleInsights] = useState(new Set());
      const [progressBars, setProgressBars] = useState({ Research: 0, Outreach: 0, Regulatory: 0, Funding: 0, Treatment: 0 });
      const [progressStatus, setProgressStatus] = useState({});
      const [labReady, setLabReady] = useState(false);
      const [actionModal, setActionModal] = useState(null);
      const [agentStatuses, setAgentStatuses] = useState(
        Object.fromEntries(['Scout','Connector','Navigator','Mobilizer','Strategist','Biologist','Chemist','Preclinician'].map(n => [n, { status: 'Initializing...', done: false }]))
      );

      // Demo event stream
      useEffect(() => {
        if (!demo) return;
        const LAB_EVENTS = [
          { t: 3000, type: 'agent_status', agent: 'Biologist', status: 'Querying ChEMBL for CLN3 targets...', done: false },
          { t: 5000, type: 'agent_status', agent: 'Biologist', status: 'Fetching AlphaFold structure for Q13286...', done: false },
          { t: 7000, type: 'agent_status', agent: 'Biologist', status: '12 therapeutic targets identified', done: true },
          { t: 7000, type: 'achievement', text: '12 druggable targets mapped with AlphaFold structures' },
          { t: 8000, type: 'agent_status', agent: 'Chemist', status: 'Screening 847 compounds across targets...', done: false },
          { t: 10000, type: 'progress', phase: 'Treatment', pct: 30 },
          { t: 12000, type: 'agent_status', agent: 'Chemist', status: '23 hits found, 5 FDA-approved candidates', done: true },
          { t: 13000, type: 'agent_status', agent: 'Preclinician', status: 'Evaluating ADMET profiles...', done: false },
          { t: 16000, type: 'agent_status', agent: 'Preclinician', status: 'ADMET scoring complete — 2 candidates ready for lab', done: true },
          { t: 16000, type: 'progress', phase: 'Treatment', pct: 60 },
          { t: 17000, type: 'lab_ready' },
        ];
        const allEvents = [...DEMO_EVENTS, ...LAB_EVENTS];
        const timers = allEvents.map(evt =>
          setTimeout(() => {
            if (evt.type === 'summary') {
              setSummaryText(evt.text);
              if (evt.text === 'Your plan is ready.') setSummaryDone(true);
            } else if (evt.type === 'agent_status') {
              setAgentStatuses(prev => ({ ...prev, [evt.agent]: { status: evt.status, done: evt.done } }));
            } else if (evt.type === 'progress') {
              setProgressBars(prev => ({ ...prev, [evt.phase]: evt.pct }));
              if (evt.status === 'complete') setProgressStatus(prev => ({ ...prev, [evt.phase]: 'complete' }));
            } else if (evt.type === 'achievement') {
              setAchievements(prev => [...prev, { text: evt.text }]);
            } else if (evt.type === 'insight') {
              setVisibleInsights(prev => new Set([...prev, evt.id]));
            } else if (evt.type === 'lab_ready') {
              setLabReady(true);
            }
          }, evt.t)
        );
        return () => timers.forEach(clearTimeout);
      }, [demo]);

      // Data polling (non-demo)
      useEffect(() => {
        if (demo) return;
        const poll = async () => {
          try {
            const res = await fetch('data/state.json');
            if (res.ok) setState(await res.json());
          } catch {}
        };
        poll();
        const interval = setInterval(poll, 3000);
        return () => clearInterval(interval);
      }, [demo]);

      const toggleExpand = (name) => {
        setExpandedSections(prev => ({ ...prev, [name]: !prev[name] }));
      };

      const toggleAccordion = (id) => {
        setExpandedId(prev => prev === id ? null : id);
      };

      const handleLaterInsight = (insight) => {
        setLaterItems(prev => [...prev, insight]);
        setShowToast(insight.title);
        setTimeout(() => setShowToast(null), 2500);
      };

      const handleLaterDecision = (decision) => {
        setLaterItems(prev => [...prev, decision]);
        setShowToast(decision.title);
        setTimeout(() => setShowToast(null), 2500);
      };

      const demoApproval = {
        type: 'Outreach Email',
        title: 'Email to Dr. Jonathan Cooper \u2014 Weill Cornell',
        summary: "Personalized introduction about your family's CLN3 journey.",
        to: 'jonathan.cooper@weillcornell.edu',
        subject: "Parent of CLN3 patient \u2014 interested in your gene therapy research",
        body: "Dear Dr. Cooper,\n\nI am writing as a parent of a child recently diagnosed with CLN3 Batten Disease. I've been following your groundbreaking work on AAV9-mediated gene therapy with great interest.\n\nYour 2024 paper on intrathecal delivery showing restored CLN3 protein expression in the murine model was particularly encouraging. I would be grateful for the opportunity to discuss your research.\n\nWith hope,\n[Your name]",
        note: "Dr. Cooper leads the only active AAV9-CLN3 gene therapy program. High priority contact.",
      };

      const handleInsightAction = (insight) => {
        if (insight.id === 'trial') {
          setActionModal({ type: 'pre-screening' });
        } else if (insight.id === 'repurpose') {
          setActionModal({ type: 'briefing' });
        }
      };

      const handleApproveDecision = (decision) => {
        if (decision.id === 'email') {
          setSelectedApproval(demoApproval);
          setModalOpen(true);
        } else if (decision.id === 'everycure') {
          setActionModal({
            type: 'outreach',
            to: 'intake@everycure.org',
            subject: 'CLN3 Batten Disease — Drug Repurposing Consultation Request',
            body: "Dear EveryCure Team,\n\nI am the parent of a child diagnosed with CLN3 Batten Disease (Juvenile Neuronal Ceroid Lipofuscinosis). Through our research, we have identified tamoxifen as a potential repurposing candidate based on its TRPML1 activation mechanism.\n\nWe would greatly appreciate a consultation through your ROADMAP framework to help validate this pathway and identify any additional repurposing candidates we may have missed.\n\nOur child's treating neurologist is supportive of exploring off-label options and would be available for a joint call if helpful.\n\nThank you for the work you do for rare disease families.\n\nWith gratitude,\n[Your name]",
            note: "EveryCure's ROADMAP framework has identified repurposing candidates for 12,000+ diseases. Their consultation is free and typically takes 2-4 weeks."
          });
        }
      };

      // Which insight cards are visible (not later'd)
      const laterIds = laterItems.map(i => i.id);
      const activeInsightCards = INSIGHT_CARDS.filter(c =>
        !laterIds.includes(c.id) &&
        ((c.id === 'trial' && visibleInsights.has('trial_match')) || (c.id === 'repurpose' && visibleInsights.has('repurposing')))
      );

      const showInbox = visibleInsights.has('email_decision') || visibleInsights.has('everycure_decision');

      return (
        <div className="min-h-screen flex flex-col md:flex-row">
          {/* Sidebar — hidden on mobile, shown on md+ */}
          <aside className="hidden md:flex w-20 bg-indigo-900 flex-col items-center py-8 gap-8 h-screen sticky top-0">
            <div className="w-10 h-10 bg-gradient-to-br from-amber-400 to-amber-500 rounded-xl flex items-center justify-center text-white font-black text-lg shadow-lg">B</div>
            <nav className="flex flex-col gap-4">
              <button onClick={() => setActiveTab('dashboard')} className={`p-3 rounded-xl ${activeTab === 'dashboard' ? 'bg-indigo-800 text-white shadow-lg' : 'text-indigo-300 hover:text-white'} transition-colors`} title="Mission Control">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="7" height="7" x="3" y="3" rx="1"/><rect width="7" height="7" x="14" y="3" rx="1"/><rect width="7" height="7" x="14" y="14" rx="1"/><rect width="7" height="7" x="3" y="14" rx="1"/></svg>
              </button>
              <button onClick={() => setActiveTab('lab')} className={`p-3 rounded-xl relative ${activeTab === 'lab' ? 'bg-indigo-800 text-white shadow-lg' : 'text-indigo-300 hover:text-white'} transition-colors`} title="Drug Discovery Lab">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10 2v7.527a2 2 0 0 1-.211.896L4.72 20.55a1 1 0 0 0 .9 1.45h12.76a1 1 0 0 0 .9-1.45l-5.069-10.127A2 2 0 0 1 14 9.527V2"/><path d="M8.5 2h7"/><path d="M7 16h10"/></svg>
                {labReady && activeTab !== 'lab' && <span className="absolute -top-1 -right-1 w-3 h-3 bg-emerald-400 rounded-full animate-ping"></span>}
                {labReady && activeTab !== 'lab' && <span className="absolute -top-1 -right-1 w-3 h-3 bg-emerald-400 rounded-full"></span>}
              </button>
              <button onClick={() => setActiveTab('community')} className={`p-3 rounded-xl ${activeTab === 'community' ? 'bg-indigo-800 text-white shadow-lg' : 'text-indigo-300 hover:text-white'} transition-colors`} title="Community & Funding">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
              </button>
            </nav>
          </aside>

          {/* Mobile bottom nav */}
          <nav className="md:hidden fixed bottom-0 left-0 right-0 bg-indigo-900 flex items-center justify-around py-3 z-50 border-t border-indigo-800">
            <div className="w-8 h-8 bg-gradient-to-br from-amber-400 to-amber-500 rounded-lg flex items-center justify-center text-white font-black text-sm">B</div>
            <button onClick={() => setActiveTab('dashboard')} className={`p-2.5 rounded-xl ${activeTab === 'dashboard' ? 'bg-indigo-800 text-white' : 'text-indigo-300'}`}>
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="7" height="7" x="3" y="3" rx="1"/><rect width="7" height="7" x="14" y="3" rx="1"/><rect width="7" height="7" x="14" y="14" rx="1"/><rect width="7" height="7" x="3" y="14" rx="1"/></svg>
            </button>
            <button onClick={() => setActiveTab('lab')} className={`p-2.5 rounded-xl relative ${activeTab === 'lab' ? 'bg-indigo-800 text-white' : 'text-indigo-300'}`}>
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10 2v7.527a2 2 0 0 1-.211.896L4.72 20.55a1 1 0 0 0 .9 1.45h12.76a1 1 0 0 0 .9-1.45l-5.069-10.127A2 2 0 0 1 14 9.527V2"/><path d="M8.5 2h7"/><path d="M7 16h10"/></svg>
              {labReady && activeTab !== 'lab' && <span className="absolute -top-1 -right-1 w-3 h-3 bg-emerald-400 rounded-full"></span>}
            </button>
            <button onClick={() => setActiveTab('community')} className={`p-2.5 rounded-xl ${activeTab === 'community' ? 'bg-indigo-800 text-white' : 'text-indigo-300'}`}>
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
            </button>
          </nav>

          {/* Main */}
          <main className="flex-1 flex flex-col pb-16 md:pb-0">
            {/* Header */}
            <header className="h-14 sm:h-16 bg-white border-b border-slate-200 flex items-center justify-between px-4 sm:px-8 shrink-0">
              <div className="flex items-center gap-2 sm:gap-4 min-w-0">
                <span className="text-[11px] font-bold text-slate-400 uppercase tracking-wider hidden sm:inline">Patient:</span>
                <span className="text-xs sm:text-sm font-bold px-2 sm:px-3 py-1 bg-slate-100 rounded-full truncate">{mission.disease || 'CLN3 Batten Disease'}</span>
              </div>
              <div className="hidden sm:flex items-center gap-6">
                <div className="flex -space-x-2">
                  {Object.entries(AGENT_COLORS).map(([name, color]) => (
                    <div key={name} className={`w-7 h-7 rounded-full bg-${color}-500 border-2 border-white flex items-center justify-center text-[8px] text-white font-bold`} title={name}>
                      {name[0]}
                    </div>
                  ))}
                </div>
              </div>
            </header>

            {/* Scrollable content */}
            <div className="flex-1 overflow-y-auto">

            {activeTab === 'dashboard' && (
              <div className="max-w-7xl mx-auto px-4 sm:px-8 py-6 sm:py-8 space-y-6 sm:space-y-8">

                <div className="grid grid-cols-1 lg:grid-cols-5 gap-6 sm:gap-8">

                {/* Left column: Hero + Journey */}
                <div className="lg:col-span-3 space-y-8">

                  {/* ==========================================
                    SUMMARY HERO CARD
                    ========================================== */}
                <div className={`rounded-3xl p-8 border shadow-sm transition-all duration-700 ${summaryDone ? 'bg-emerald-50 border-emerald-200' : 'bg-gradient-to-r from-indigo-50 to-violet-50 border-indigo-200'}`}>
                  <div className="flex items-center gap-4 mb-3">
                    <div className={`w-12 h-12 rounded-2xl flex items-center justify-center ${summaryDone ? 'bg-emerald-500' : 'bg-indigo-600'} text-white shadow-lg`}>
                      {summaryDone ? (
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
                      ) : (
                        <div className="w-10 h-10 bg-gradient-to-br from-amber-400 to-amber-500 rounded-xl flex items-center justify-center text-white font-black text-lg">B</div>
                      )}
                    </div>
                    <div>
                      <h2 className={`text-2xl font-bold ${summaryDone ? 'text-emerald-900' : 'text-indigo-900'}`}>{summaryText}</h2>
                      <p className={`text-sm ${summaryDone ? 'text-emerald-600' : 'text-indigo-500'}`}>
                        {summaryDone ? "Here's what your team found." : `${mission.disease || 'CLN3 Batten Disease'} — your 8 agents are working`}
                        {!summaryDone && <span className="agent-pulse"> ...</span>}
                      </p>
                    </div>
                  </div>
                </div>

                {/* ==========================================
                    SECTION 1: YOUR JOURNEY
                    ========================================== */}
                <div className="bg-white rounded-3xl p-5 sm:p-8 border border-slate-200 shadow-sm overflow-hidden">
                  <div className="flex items-center justify-between mb-6">
                    <h2 className="text-lg font-bold flex items-center gap-2">
                      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#4f46e5" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="3 6 9 3 15 6 21 3 21 18 15 21 9 18 3 21"/><line x1="9" x2="9" y1="3" y2="18"/><line x1="15" x2="15" y1="6" y2="21"/></svg>
                      Your Journey
                    </h2>
                  </div>

                  {/* Progress bars — animated */}
                  <div className="grid grid-cols-3 sm:grid-cols-5 gap-3 mb-6">
                    {['Research', 'Outreach', 'Regulatory', 'Funding', 'Treatment'].map((label) => {
                      const pct = progressBars[label] || 0;
                      const isComplete = progressStatus[label] === 'complete';
                      const sub = isComplete ? 'Complete' : pct > 0 ? `${pct}%` : 'Waiting...';
                      return (
                        <div key={label} className="flex-1">
                          <div className={`h-2 rounded-full mb-3 bg-slate-200 overflow-hidden`}>
                            <div className={`h-full rounded-full transition-all duration-1000 ease-out ${isComplete ? 'bg-emerald-500' : pct > 0 ? 'bg-amber-500' : ''}`} style={{ width: `${pct}%` }}></div>
                          </div>
                          <p className={`text-[10px] font-bold uppercase tracking-wider ${isComplete ? 'text-emerald-600' : pct > 0 ? 'text-amber-600' : 'text-slate-400'}`}>{label}</p>
                          <p className={`text-xs font-semibold mt-0.5 ${isComplete || pct > 0 ? 'text-slate-600' : 'text-slate-400'}`}>{sub}</p>
                        </div>
                      );
                    })}
                  </div>

                  {/* Achievement cards — stream in one by one */}
                  <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                    {achievements.map((a, i) => (
                      <div key={i} className="flex-1 bg-emerald-50 rounded-xl p-3 border border-emerald-100 fade-up">
                        <div className="flex items-center gap-2 mb-1">
                          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#059669" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
                          <span className="text-[10px] font-bold text-emerald-700 uppercase">Done</span>
                        </div>
                        <p className="text-xs text-emerald-800 font-semibold">{a.text}</p>
                      </div>
                    ))}
                    {achievements.length === 0 && (
                      <div className="flex-1 bg-slate-50 rounded-xl p-3 border border-slate-100 text-center">
                        <p className="text-xs text-slate-400 font-medium">Your team is analyzing<span className="agent-pulse"> ...</span></p>
                      </div>
                    )}
                  </div>
                </div>

                </div>{/* end left column */}

                {/* Right column: Insights + Inbox */}
                <div className="lg:col-span-2 space-y-6 min-w-0">

                {/* ==========================================
                    SECTION 2: KEY INSIGHTS (Spatial Canvas)
                    ========================================== */}
                <div className="space-y-4">

                  {/* Later list indicator */}
                  {laterItems.length > 0 && (
                    <div className="flex items-center gap-3 bg-white rounded-2xl px-5 py-3 border border-slate-200 shadow-sm fade-up">
                      <div className="w-8 h-8 bg-slate-100 rounded-lg flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#64748b" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 12h-2.48a2 2 0 0 0-1.93 1.46l-2.35 8.36a.25.25 0 0 1-.48 0L9.24 2.18a.25.25 0 0 0-.48 0l-2.35 8.36A2 2 0 0 1 4.49 12H2"/></svg>
                      </div>
                      <div className="flex-1">
                        <p className="text-xs font-bold text-slate-700">Your Later List</p>
                        <p className="text-[11px] text-slate-400">{laterItems.length} item{laterItems.length !== 1 ? 's' : ''} saved — come back anytime</p>
                      </div>
                      <div className="flex gap-1">
                        {laterItems.map((item, i) => (
                          <div key={i} className="w-6 h-6 bg-indigo-100 rounded-full flex items-center justify-center text-[8px] font-bold text-indigo-600">{i + 1}</div>
                        ))}
                      </div>
                    </div>
                  )}

                  {/* Insights board */}
                  {(visibleInsights.has('trial_match') || visibleInsights.has('repurposing')) && (
                    <div className="bg-gradient-to-br from-slate-50 to-slate-100 rounded-3xl p-4 sm:p-6 border border-slate-200 overflow-hidden">
                      <h2 className="text-lg font-bold flex items-center gap-2 mb-6">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-.9 1.5-2.2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/></svg>
                        Key Insights
                      </h2>

                      {activeInsightCards.length > 0 ? (
                        <div className="grid grid-cols-1 gap-4">
                          {activeInsightCards.map(insight => (
                            <InsightCard
                              key={insight.id}
                              insight={insight}
                              expanded={expandedId === insight.id}
                              onToggle={() => toggleAccordion(insight.id)}
                              onLater={() => handleLaterInsight(insight)}
                              onAction={handleInsightAction}
                            />
                          ))}
                        </div>
                      ) : (
                        <div className="text-center py-8">
                          <p className="text-slate-400 font-medium">All items moved to your Later list.</p>
                          <p className="text-xs text-slate-300 mt-1">Your agents will keep working and surface new findings.</p>
                        </div>
                      )}
                    </div>
                  )}

                  {/* Placeholder when nothing visible yet */}
                  {!visibleInsights.has('trial_match') && !visibleInsights.has('repurposing') && !showInbox && (
                    <div className="bg-slate-50 rounded-2xl p-8 border border-slate-200 text-center fade-in">
                      <p className="text-slate-400 font-medium">Your team is analyzing<span className="agent-pulse"> ...</span></p>
                      <p className="text-xs text-slate-300 mt-1">Insights will appear here as your agents make discoveries</p>
                    </div>
                  )}

                  {/* Delegation Inbox */}
                  {showInbox && (
                    <div className="bg-gradient-to-br from-amber-50/50 to-slate-50 rounded-3xl p-4 sm:p-6 border border-amber-200/50 overflow-hidden">
                      <DelegationInbox
                        expandedId={expandedId}
                        onToggle={toggleAccordion}
                        onApprove={handleApproveDecision}
                        onLater={handleLaterDecision}
                      />
                    </div>
                  )}
                </div>

                </div>{/* end right column */}
                </div>{/* end grid */}

                {/* ==========================================
                    SECTION 3: DETAILED VIEW (Expandable)
                    ========================================== */}
                <div className="border border-slate-200 rounded-3xl bg-white shadow-sm overflow-hidden">
                  <button onClick={() => toggleExpand('detail')} className="w-full flex items-center justify-between px-8 py-5 hover:bg-slate-50 transition-colors">
                    <h2 className="text-lg font-bold flex items-center gap-2">
                      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#64748b" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12.83 2.18a2 2 0 0 0-1.66 0L2.6 6.08a1 1 0 0 0 0 1.83l8.58 3.91a2 2 0 0 0 1.66 0l8.58-3.9a1 1 0 0 0 0-1.83Z"/><path d="m22 17.65-9.17 4.16a2 2 0 0 1-1.66 0L2 17.65"/><path d="m22 12.65-9.17 4.16a2 2 0 0 1-1.66 0L2 12.65"/></svg>
                      Detailed View
                      <span className="text-xs font-medium text-slate-400 ml-2">Agent activity, timeline, repurposing tracker</span>
                    </h2>
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#94a3b8" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={`chevron-icon ${expandedSections.detail ? 'rotated' : ''}`}><path d="m6 9 6 6 6-6"/></svg>
                  </button>

                  <div data-expand-target="detail" className={expandedSections.detail ? 'open' : ''}>
                    <div className="px-8 pb-8 grid grid-cols-12 gap-8 border-t border-slate-100 pt-6">

                      {/* Left: Living Timeline */}
                      <div className="col-span-7 space-y-6">
                        <div className="flex items-center justify-between">
                          <h3 className="text-base font-bold flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#4f46e5" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M12 7v5l4 2"/></svg>
                            Mission Timeline
                          </h3>
                          <span className="text-[11px] text-slate-400">Updated 2 min ago</span>
                        </div>

                        <div className="relative pl-10 timeline-line space-y-8">
                          {TIMELINE_MILESTONES.map((m, i) => (
                            <div key={i} className="relative">
                              <div className={`absolute -left-[30px] w-10 h-10 ${m.major ? `bg-${m.color}-600 text-white shadow-lg shadow-${m.color}-200` : `bg-white border-2 border-${m.color}-500 text-${m.color}-500`} rounded-full flex items-center justify-center z-10`}>
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                  {m.icon === 'file-check' && <><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="m9 15 2 2 4-4"/></>}
                                  {m.icon === 'microscope' && <><path d="M6 18h8"/><path d="M3 22h18"/><path d="M14 22a7 7 0 1 0 0-14h-1"/><path d="M9 14h2"/><path d="M9 12a2 2 0 0 1-2-2V6h6v4a2 2 0 0 1-2 2Z"/></>}
                                  {m.icon === 'flask-conical' && <><path d="M10 2v7.527a2 2 0 0 1-.211.896L4.72 20.55a1 1 0 0 0 .9 1.45h12.76a1 1 0 0 0 .9-1.45l-5.069-10.127A2 2 0 0 1 14 9.527V2"/><path d="M8.5 2h7"/><path d="M7 16h10"/></>}
                                  {m.icon === 'mail' && <><rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></>}
                                </svg>
                              </div>
                              <div className={`${m.major ? 'bg-indigo-50 border-2 border-indigo-200' : 'bg-white border border-slate-200'} p-5 rounded-2xl`}>
                                <div className="flex justify-between items-start mb-1">
                                  <h4 className={`font-bold text-sm ${m.major ? 'text-indigo-900' : 'text-slate-800'}`}>{m.title}</h4>
                                  {m.major && <span className="bg-indigo-600 text-white text-[8px] font-black px-2 py-0.5 rounded uppercase">Major</span>}
                                  {m.pending && <span className="bg-amber-100 text-amber-700 text-[8px] font-black px-1.5 py-0.5 rounded uppercase">Pending</span>}
                                </div>
                                <p className="text-[11px] text-slate-500">{m.desc}</p>
                                {m.stats && (
                                  <div className="grid grid-cols-2 gap-2 mt-3">
                                    {m.stats.map((s, j) => (
                                      <div key={j} className="bg-slate-50 p-2.5 rounded-lg border border-slate-100">
                                        <span className="text-[9px] font-bold text-slate-400 uppercase">{s.label}</span>
                                        <p className="text-xs font-semibold">{s.value}</p>
                                      </div>
                                    ))}
                                  </div>
                                )}
                                {m.major && (
                                  <div className="space-y-2 border-l-2 border-indigo-200 pl-3 py-1 text-xs mt-3">
                                    {REPURPOSING_DEMO_DATA.council.slice(0, 3).map((msg, j) => (
                                      <div key={j} className="flex gap-2">
                                        <span className={`font-bold text-${AGENT_COLORS[msg.agent]}-600 uppercase w-16 shrink-0 text-[9px]`}>{msg.agent}</span>
                                        <p className="text-slate-600">"{msg.text.substring(0, 80)}..."</p>
                                      </div>
                                    ))}
                                  </div>
                                )}
                              </div>
                            </div>
                          ))}
                        </div>
                      </div>

                      {/* Right: ROADMAP + Team Status */}
                      <div className="col-span-5 space-y-6">

                        {/* ROADMAP Tracker */}
                        <div className="bg-white p-5 rounded-2xl border border-slate-200">
                          <h4 className="font-bold text-sm mb-1 flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#4f46e5" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m10.5 20.5 10-10a4.95 4.95 0 1 0-7-7l-10 10a4.95 4.95 0 1 0 7 7Z"/><path d="m8.5 8.5 7 7"/></svg>
                            Repurposing ROADMAP
                          </h4>
                          <p className="text-[10px] text-slate-400 mb-4">EveryCure Framework</p>

                          <div className="space-y-3 relative">
                            <div className="absolute left-[11px] top-2 bottom-2 w-0.5 bg-slate-200"></div>
                            {REPURPOSING_DEMO_DATA.steps.map((s, i) => (
                              <div key={i} className={`flex items-start gap-3 relative ${!s.done && !s.active ? 'opacity-40' : ''}`}>
                                {s.done ? (
                                  <div className="w-6 h-6 rounded-full bg-emerald-500 flex items-center justify-center z-10 shrink-0">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
                                  </div>
                                ) : s.active ? (
                                  <div className="w-6 h-6 rounded-full bg-amber-500 flex items-center justify-center z-10 shrink-0 ring-2 ring-amber-200">
                                    <span className="text-[9px] font-black text-white">{i + 1}</span>
                                  </div>
                                ) : (
                                  <div className="w-6 h-6 rounded-full bg-slate-200 flex items-center justify-center z-10 shrink-0">
                                    <span className="text-[9px] font-bold text-slate-400">{i + 1}</span>
                                  </div>
                                )}
                                <div>
                                  <p className={`text-[11px] font-bold ${s.active ? 'text-amber-700' : s.done ? 'text-slate-700' : 'text-slate-500'}`}>{s.name}</p>
                                  {s.desc && <p className={`text-[10px] ${s.active ? 'text-amber-600' : 'text-slate-400'}`}>{s.desc}</p>}
                                </div>
                              </div>
                            ))}
                          </div>

                          <div className="mt-4 p-3 bg-emerald-50 rounded-xl border border-emerald-100">
                            <div className="flex items-center gap-2 mb-0.5">
                              <span className="bg-emerald-600 text-white text-[8px] font-black px-1.5 py-0.5 rounded uppercase">Lead</span>
                              <span className="text-xs font-bold text-emerald-900">Tamoxifen</span>
                            </div>
                            <p className="text-[10px] text-emerald-700">TRPML1 agonist &middot; FDA-approved &middot; Ped. data</p>
                          </div>
                        </div>

                        {/* Team Status */}
                        <div className="bg-white p-5 rounded-2xl border border-slate-200">
                          <h4 className="font-bold text-sm mb-4 flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#64748b" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                            Your Team
                          </h4>
                          <div className="space-y-2.5">
                            {Object.entries(agentStatuses).map(([name, a]) => (
                              <div key={name} className="flex items-center gap-3">
                                <div className={`w-2 h-2 rounded-full ${a.done ? 'bg-emerald-500' : 'bg-amber-500 agent-pulse'}`}></div>
                                <span className="text-[11px] font-bold text-slate-700 w-20">{name}</span>
                                <span className="text-[11px] text-slate-400">{a.status}</span>
                              </div>
                            ))}
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

              </div>
            )}

            {activeTab === 'lab' && <LabTab labReady={labReady} />}

            {activeTab === 'community' && <CommunityTab setActiveTab={setActiveTab} communitySection={communitySection} setCommunitySection={setCommunitySection} />}

            </div>
          </main>

          {/* Toast notification */}
          {showToast && (
            <div className="fixed bottom-6 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-5 py-3 rounded-2xl shadow-2xl flex items-center gap-3 fade-up z-50">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#818cf8" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
              <span className="text-sm font-medium">"{showToast}" saved to Later</span>
            </div>
          )}
        </div>
      );
    }

    // ==========================================
    // LAB TAB
    // ==========================================

    function LabTab({ labReady }) {
      const [selectedTarget, setSelectedTarget] = useState(0);
      const [selectedCandidate, setSelectedCandidate] = useState(null);
      const [viewerMode, setViewerMode] = useState('target'); // 'target' | 'candidate'
      const viewerInstanceRef = useRef(null);
      const [pdbLoaded, setPdbLoaded] = useState(false);
      const [labSection, setLabSection] = useState('overview'); // 'overview' | 'candidates' | 'experiments'

      const doLoadPdb = async (viewer, target) => {
        try {
          const resp = await fetch(target.pdb_file);
          if (!resp.ok) throw new Error('HTTP ' + resp.status);
          const pdb = await resp.text();
          if (!pdb || pdb.length < 100) throw new Error('Empty PDB');
          viewer.addModel(pdb, 'pdb');
          viewer.setStyle({}, { cartoon: { color: 'spectrum' } });
          viewer.zoomTo();
          viewer.render();
          viewer.spin('y', 0.5);
          setPdbLoaded(true);
        } catch (e) {
          console.error('PDB load error:', e, 'for', target.pdb_file);
          viewer.addSphere({ center: { x: 0, y: 0, z: 0 }, radius: 10, color: '0x6366f1', alpha: 0.5 });
          viewer.addLabel(target.name, { position: { x: 0, y: 12, z: 0 }, fontSize: 14, backgroundColor: '0x6366f1', fontColor: 'white' });
          viewer.zoomTo();
          viewer.render();
          setPdbLoaded(true);
        }
      };

      // Callback ref: creates a child div for 3Dmol so React never touches its DOM
      const viewerContainerRef = useRef(null);
      const viewerRefCallback = useCallback((node) => {
        if (!node) return;
        viewerContainerRef.current = node;
        // Create a child div that 3Dmol owns — React won't manage it
        const molDiv = document.createElement('div');
        molDiv.style.cssText = 'width:100%;height:100%;position:absolute;top:0;left:0;';
        node.appendChild(molDiv);
        // Destroy previous viewer
        if (viewerInstanceRef.current) {
          try { viewerInstanceRef.current.clear(); } catch(e) {}
        }
        const viewer = $3Dmol.createViewer(molDiv, {
          backgroundColor: 'white',
          antialias: true,
        });
        viewerInstanceRef.current = viewer;
        setPdbLoaded(false);
        doLoadPdb(viewer, LAB_TARGETS[selectedTarget]);
      }, []);

      const handleTargetSelect = (idx) => {
        setSelectedTarget(idx);
        setViewerMode('target');
        const viewer = viewerInstanceRef.current;
        if (viewer) {
          setPdbLoaded(false);
          viewer.removeAllModels();
          viewer.removeAllLabels();
          viewer.removeAllShapes();
          doLoadPdb(viewer, LAB_TARGETS[idx]);
        }
      };

      const ratingColor = (r) => r === 'green' ? 'emerald' : r === 'amber' ? 'amber' : 'red';
      const ratingBg = (r) => r === 'green' ? 'bg-emerald-100 text-emerald-700' : r === 'amber' ? 'bg-amber-100 text-amber-700' : 'bg-red-100 text-red-700';
      const ratingDot = (r) => r === 'green' ? 'bg-emerald-500' : r === 'amber' ? 'bg-amber-500' : 'bg-red-500';

      return (
        <div className="max-w-7xl mx-auto px-4 sm:px-8 py-6 sm:py-8 space-y-6 sm:space-y-8">

          {/* Lab Header */}
          <div className="bg-gradient-to-r from-cyan-50 via-indigo-50 to-violet-50 rounded-3xl p-5 sm:p-8 border border-indigo-200 shadow-sm">
            <div className="flex items-center gap-4 mb-2">
              <div className="w-12 h-12 rounded-2xl bg-gradient-to-br from-cyan-500 to-indigo-600 flex items-center justify-center text-white shadow-lg">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10 2v7.527a2 2 0 0 1-.211.896L4.72 20.55a1 1 0 0 0 .9 1.45h12.76a1 1 0 0 0 .9-1.45l-5.069-10.127A2 2 0 0 1 14 9.527V2"/><path d="M8.5 2h7"/><path d="M7 16h10"/></svg>
              </div>
              <div>
                <h2 className="text-2xl font-bold text-indigo-900">Drug Discovery Lab</h2>
                <p className="text-sm text-indigo-500">Biologist + Chemist + Preclinician working on your targets</p>
              </div>
            </div>

            {/* Sub-nav */}
            <div className="flex flex-wrap gap-2 mt-4">
              {[{id:'overview',label:'Overview & Targets'},{id:'candidates',label:'Candidate Pipeline'},{id:'experiments',label:'Lab Testing'}].map(tab => (
                <button key={tab.id} onClick={() => setLabSection(tab.id)}
                  className={`px-4 py-2 rounded-xl text-xs font-bold transition-all ${labSection === tab.id ? 'bg-indigo-600 text-white shadow-md' : 'bg-white/70 text-indigo-600 hover:bg-white'}`}>
                  {tab.label}
                </button>
              ))}
            </div>
          </div>

          {/* OVERVIEW SECTION */}
          {labSection === 'overview' && (
            <div className="grid grid-cols-1 lg:grid-cols-12 gap-6 sm:gap-8">

              {/* 3D Viewer */}
              <div className="lg:col-span-7 bg-white rounded-3xl border border-slate-200 shadow-sm overflow-hidden">
                <div className="px-4 sm:px-6 py-4 border-b border-slate-100 flex flex-col sm:flex-row sm:items-center justify-between gap-2">
                  <div>
                    <h3 className="font-bold text-slate-800 text-sm sm:text-base">Protein Target: {LAB_TARGETS[selectedTarget].name}</h3>
                    <p className="text-[11px] text-slate-400">{LAB_TARGETS[selectedTarget].gene} — AlphaFold predicted structure</p>
                  </div>
                  <div className="flex gap-2">
                    <button onClick={() => { const v = viewerInstanceRef.current; if(v){v.setStyle({},{cartoon:{color:'spectrum'}}); v.render();} }} className="px-3 py-1.5 text-[10px] font-bold rounded-lg bg-indigo-50 text-indigo-600 hover:bg-indigo-100">Cartoon</button>
                    <button onClick={() => { const v = viewerInstanceRef.current; if(v){v.setStyle({},{stick:{colorscheme:'Jmol'}}); v.render();} }} className="px-3 py-1.5 text-[10px] font-bold rounded-lg bg-slate-50 text-slate-600 hover:bg-slate-100">Stick</button>
                    <button onClick={() => { const v = viewerInstanceRef.current; if(v){v.setStyle({},{surface:{opacity:0.8,color:'white'}}); v.render();} }} className="px-3 py-1.5 text-[10px] font-bold rounded-lg bg-slate-50 text-slate-600 hover:bg-slate-100">Surface</button>
                  </div>
                </div>
                <div style={{ width: '100%', height: '420px', position: 'relative' }}>
                  <div ref={viewerRefCallback} style={{ width: '100%', height: '100%' }}></div>
                  {!pdbLoaded && (
                    <div className="absolute inset-0 flex items-center justify-center bg-slate-50 z-10">
                      <div className="text-center">
                        <div className="w-10 h-10 border-4 border-indigo-200 border-t-indigo-600 rounded-full animate-spin mx-auto mb-3"></div>
                        <p className="text-xs text-slate-400 font-medium">Loading AlphaFold structure...</p>
                      </div>
                    </div>
                  )}
                </div>
              </div>

              {/* Target List + Pipeline Funnel */}
              <div className="lg:col-span-5 space-y-6">

                {/* Target selector */}
                <div className="bg-white rounded-3xl p-6 border border-slate-200 shadow-sm">
                  <h4 className="font-bold text-sm mb-4 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#06b6d4" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>
                    Therapeutic Targets ({LAB_TARGETS.length})
                  </h4>
                  <div className="space-y-2">
                    {LAB_TARGETS.map((t, i) => (
                      <button key={i} onClick={() => handleTargetSelect(i)}
                        className={`w-full text-left p-3 rounded-2xl border-2 transition-all ${selectedTarget === i ? 'border-indigo-500 bg-indigo-50' : 'border-slate-100 hover:border-slate-300'}`}>
                        <div className="flex items-center justify-between mb-1">
                          <span className="text-sm font-bold text-slate-800">{t.name}</span>
                          <span className={`text-[9px] font-black px-2 py-0.5 rounded ${t.druggability_score >= 0.7 ? 'bg-emerald-100 text-emerald-700' : t.druggability_score >= 0.5 ? 'bg-amber-100 text-amber-700' : 'bg-red-100 text-red-700'}`}>
                            Druggability: {(t.druggability_score * 100).toFixed(0)}%
                          </span>
                        </div>
                        <p className="text-[10px] text-slate-400">{t.gene} — {t.pathway}</p>
                        <p className="text-[10px] text-slate-500 mt-1">{t.rationale}</p>
                      </button>
                    ))}
                  </div>
                </div>

                {/* Pipeline Funnel */}
                <div className="bg-white rounded-3xl p-6 border border-slate-200 shadow-sm">
                  <h4 className="font-bold text-sm mb-4 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#8b5cf6" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>
                    Discovery Pipeline
                  </h4>
                  <div className="space-y-2">
                    {LAB_PIPELINE_FUNNEL.map((s, i) => {
                      const maxCount = LAB_PIPELINE_FUNNEL[1].count; // largest for width scale
                      const pct = Math.max(15, (s.count / maxCount) * 100);
                      return (
                        <div key={i} className="flex items-center gap-3">
                          <div className="w-20 text-right">
                            <span className={`text-lg font-black text-${s.color}-600`}>{s.count}</span>
                          </div>
                          <div className="flex-1">
                            <div className={`h-8 bg-${s.color}-500 rounded-lg flex items-center px-3 transition-all duration-700`} style={{ width: `${pct}%` }}>
                              <span className="text-[10px] font-bold text-white whitespace-nowrap">{s.stage}</span>
                            </div>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                  <div className="mt-3 flex items-center gap-2 text-[10px] text-slate-400">
                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>
                    847 compounds screened → 2 ready for lab testing
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* CANDIDATES SECTION */}
          {labSection === 'candidates' && (
            <div className="space-y-6">

              {/* Candidate Comparison Grid */}
              <div className="bg-white rounded-3xl p-6 border border-slate-200 shadow-sm overflow-x-auto">
                <h3 className="font-bold text-lg mb-1">Candidate Comparison</h3>
                <p className="text-xs text-slate-400 mb-6">ADMET traffic-light scoring across all parameters</p>

                <table className="w-full text-xs">
                  <thead>
                    <tr className="border-b border-slate-200">
                      <th className="text-left py-3 px-2 font-bold text-slate-600 w-40">Candidate</th>
                      <th className="text-center py-3 px-1 font-bold text-slate-500">Efficacy</th>
                      <th className="text-center py-3 px-1 font-bold text-slate-500">Oral Abs.</th>
                      <th className="text-center py-3 px-1 font-bold text-slate-500">CNS</th>
                      <th className="text-center py-3 px-1 font-bold text-slate-500">hERG</th>
                      <th className="text-center py-3 px-1 font-bold text-slate-500">CYP</th>
                      <th className="text-center py-3 px-1 font-bold text-slate-500">Solub.</th>
                      <th className="text-center py-3 px-1 font-bold text-slate-500">Select.</th>
                      <th className="text-center py-3 px-1 font-bold text-slate-500">Synth.</th>
                      <th className="text-center py-3 px-2 font-bold text-slate-600 w-24">Overall</th>
                      <th className="text-right py-3 px-2 w-36"></th>
                    </tr>
                  </thead>
                  <tbody>
                    {LAB_CANDIDATES.map((c, i) => (
                      <tr key={i} className={`border-b border-slate-100 hover:bg-slate-50 transition-colors ${selectedCandidate === i ? 'bg-indigo-50' : ''}`}>
                        <td className="py-3 px-2">
                          <button onClick={() => setSelectedCandidate(selectedCandidate === i ? null : i)} className="text-left">
                            <div className="font-bold text-slate-800">{c.name}</div>
                            <div className="text-[10px] text-slate-400">{c.target}</div>
                            {c.fda_approved && <span className="text-[8px] font-black bg-emerald-100 text-emerald-700 px-1.5 py-0.5 rounded mt-0.5 inline-block">FDA APPROVED</span>}
                          </button>
                        </td>
                        {['efficacy','oral_absorption','cns_penetration','herg','cyp_inhibition','solubility','selectivity','synthetic_access'].map(key => (
                          <td key={key} className="text-center py-3 px-1">
                            <div className={`w-6 h-6 rounded-full ${ratingDot(c.scores[key].rating)} mx-auto`} title={c.scores[key].val}></div>
                          </td>
                        ))}
                        <td className="text-center py-3 px-2">
                          <span className={`text-[10px] font-black px-2.5 py-1 rounded-lg ${ratingBg(c.overall)}`}>
                            {c.overall.toUpperCase()}
                          </span>
                        </td>
                        <td className="text-right py-3 px-2">
                          {(c.overall === 'green' || (c.overall === 'amber' && c.fda_approved)) && (
                            <button className="px-3 py-1.5 bg-indigo-600 text-white rounded-lg text-[10px] font-bold hover:bg-indigo-700 transition-colors">
                              Queue for Lab
                            </button>
                          )}
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>

              {/* Expanded candidate detail */}
              {selectedCandidate !== null && (
                <div className="bg-white rounded-3xl p-6 border border-indigo-200 shadow-sm fade-up">
                  {(() => {
                    const c = LAB_CANDIDATES[selectedCandidate];
                    return (
                      <div className="grid grid-cols-1 md:grid-cols-12 gap-6">
                        <div className="md:col-span-5">
                          <h4 className="font-bold text-lg text-slate-900 mb-1">{c.name}</h4>
                          <p className="text-xs text-slate-400 mb-4">{c.chembl_id} — pChEMBL {c.pchembl}</p>
                          <div className="space-y-3">
                            <div>
                              <span className="text-[10px] font-bold text-slate-400 uppercase">Mechanism</span>
                              <p className="text-sm text-slate-700">{c.mechanism}</p>
                            </div>
                            <div>
                              <span className="text-[10px] font-bold text-slate-400 uppercase">Indication</span>
                              <p className="text-sm text-slate-700">{c.indication}</p>
                            </div>
                            <div>
                              <span className="text-[10px] font-bold text-slate-400 uppercase">Evidence</span>
                              <p className="text-sm text-slate-700">{c.evidence}</p>
                            </div>
                            <div>
                              <span className="text-[10px] font-bold text-slate-400 uppercase">Recommendation</span>
                              <p className={`text-sm font-semibold ${c.overall === 'green' ? 'text-emerald-700' : c.overall === 'amber' ? 'text-amber-700' : 'text-red-700'}`}>{c.recommendation}</p>
                            </div>
                          </div>
                        </div>
                        <div className="md:col-span-7">
                          <h5 className="text-xs font-bold text-slate-500 uppercase mb-3">ADMET Profile</h5>
                          <div className="grid grid-cols-2 gap-2">
                            {Object.entries(c.scores).map(([key, s]) => (
                              <div key={key} className={`p-2.5 rounded-xl border ${s.rating === 'green' ? 'bg-emerald-50 border-emerald-100' : s.rating === 'amber' ? 'bg-amber-50 border-amber-100' : 'bg-red-50 border-red-100'}`}>
                                <div className="flex items-center justify-between mb-0.5">
                                  <span className="text-[9px] font-bold text-slate-500 uppercase">{key.replace(/_/g, ' ')}</span>
                                  <div className={`w-2.5 h-2.5 rounded-full ${ratingDot(s.rating)}`}></div>
                                </div>
                                <p className="text-[11px] font-semibold text-slate-700">{s.val}</p>
                              </div>
                            ))}
                          </div>
                        </div>
                      </div>
                    );
                  })()}
                </div>
              )}
            </div>
          )}

          {/* EXPERIMENTS SECTION */}
          {labSection === 'experiments' && (
            <div className="space-y-6">
              <div className="bg-white rounded-3xl p-6 border border-slate-200 shadow-sm">
                <h3 className="font-bold text-lg mb-1">Experiment Tiers</h3>
                <p className="text-xs text-slate-400 mb-6">Progressive validation — each tier narrows the candidate pool</p>

                <div className="space-y-3">
                  {LAB_EXPERIMENTS.map((exp, i) => (
                    <div key={i} className={`p-5 rounded-2xl border-2 transition-all ${exp.status === 'ready' ? 'border-indigo-500 bg-indigo-50' : 'border-slate-200'}`}>
                      <div className="flex flex-col sm:flex-row sm:items-center justify-between gap-3 mb-2">
                        <div className="flex items-center gap-3">
                          <div className={`w-8 h-8 rounded-lg flex items-center justify-center text-xs font-black shrink-0 ${exp.status === 'ready' ? 'bg-indigo-600 text-white' : 'bg-slate-200 text-slate-500'}`}>T{exp.tier}</div>
                          <div>
                            <h4 className="font-bold text-sm text-slate-800">{exp.name}</h4>
                            <p className="text-[10px] text-slate-400">Compounds: {exp.compounds}</p>
                          </div>
                        </div>
                        <div className="flex items-center gap-4 ml-11 sm:ml-0">
                          <div className="text-left sm:text-right">
                            <p className="text-sm font-bold text-slate-800">{exp.cost}</p>
                            <p className="text-[10px] text-slate-400">{exp.timeline}</p>
                          </div>
                          {exp.status === 'ready' ? (
                            <button className="px-4 py-2 bg-indigo-600 text-white rounded-xl text-xs font-bold hover:bg-indigo-700 transition-colors shadow-md shadow-indigo-200">
                              Approve & Queue
                            </button>
                          ) : (
                            <span className="px-3 py-1.5 bg-slate-100 text-slate-400 rounded-lg text-[10px] font-bold">Pending prior tier</span>
                          )}
                        </div>
                      </div>
                      {/* Funding sources for this tier */}
                      {EXPERIMENT_FUNDING[exp.tier] && (
                        <div className="mt-3 pt-3 border-t border-slate-100">
                          <div className="flex items-center gap-2 mb-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#10b981" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                            <span className="text-[10px] font-bold text-emerald-700">Funding Sources</span>
                          </div>
                          <div className="flex flex-wrap gap-2">
                            {EXPERIMENT_FUNDING[exp.tier].map((f, fi) => (
                              <span key={fi} className="inline-flex items-center gap-1 px-2 py-1 bg-emerald-50 border border-emerald-200 rounded-lg text-[10px] text-emerald-800">
                                <span className="font-semibold">{f.source}</span>
                                <span className="text-emerald-500">·</span>
                                <span>{f.amount}</span>
                              </span>
                            ))}
                          </div>
                        </div>
                      )}
                      {exp.status === 'ready' && (
                        <div className="mt-3 pt-3 border-t border-indigo-200">
                          <p className="text-xs text-indigo-700">Ready to proceed — your Connector agent will draft a CRO outreach with the assay protocol attached.</p>
                        </div>
                      )}
                    </div>
                  ))}
                </div>

                <div className="mt-6 bg-amber-50 rounded-2xl p-4 border border-amber-200">
                  <div className="flex items-start gap-3">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#d97706" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="shrink-0 mt-0.5"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>
                    <div>
                      <p className="text-xs font-bold text-amber-800 mb-1">How this works</p>
                      <p className="text-xs text-amber-700">Approving an experiment tier means your Connector agent will reach out to qualified CROs (Contract Research Organizations) with a detailed protocol. You'll review every quote and CRO proposal before committing. Nothing is sent without your approval.</p>
                    </div>
                  </div>
                </div>
              </div>

              {/* CRO Pipeline placeholder */}
              <div className="bg-white rounded-3xl p-6 border border-slate-200 shadow-sm">
                <h3 className="font-bold text-sm mb-3 flex items-center gap-2">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#64748b" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                  CRO Pipeline
                </h3>
                <div className="text-center py-8">
                  <div className="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-3">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#94a3b8" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                  </div>
                  <p className="text-sm font-medium text-slate-500">No CRO outreach yet</p>
                  <p className="text-xs text-slate-400 mt-1">Approve a Tier 1 experiment above to start CRO matching</p>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    // ==========================================
    // COMMUNITY TAB
    // ==========================================

    function CommunityTab({ setActiveTab, communitySection, setCommunitySection }) {
      const sectionBtns = [
        { id: 'network', label: 'Patient Network', icon: '\u{1F465}' },
        { id: 'data', label: 'Data Commons', icon: '\u{1F4CA}' },
        { id: 'trial', label: 'Path to Trial', icon: '\u{1F3AF}' },
      ];

      return (
        <div className="max-w-6xl mx-auto px-4 sm:px-8 py-6 sm:py-8 space-y-6">
          <div className="flex items-center justify-between">
            <div>
              <h2 className="text-2xl font-bold text-slate-800">Community & Funding</h2>
              <p className="text-sm text-slate-500 mt-1">Connect with families, share data, and build toward a clinical trial</p>
            </div>
          </div>

          {/* Your Team on This */}
          <div className="bg-white rounded-2xl p-4 border border-slate-200 shadow-sm">
            <p className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-3">Your Team on This</p>
            <div className="flex flex-wrap gap-4">
              {[
                { name: 'Connector', status: 'Matching families & drafting introductions' },
                { name: 'Preclinician', status: 'Analyzing community data to refine treatment models' },
                { name: 'Mobilizer', status: 'Identifying grants & funding strategy' },
                { name: 'Navigator', status: 'Mapping regulatory path to clinical trial' },
              ].map(a => (
                <div key={a.name} className="flex items-center gap-2">
                  <div className={`w-7 h-7 rounded-full bg-${AGENT_COLORS[a.name]}-500 flex items-center justify-center text-xs`}>{AGENT_EMOJIS[a.name]}</div>
                  <div>
                    <p className={`text-xs font-bold text-${AGENT_COLORS[a.name]}-700`}>{a.name}</p>
                    <p className="text-[10px] text-slate-400">{a.status}</p>
                  </div>
                </div>
              ))}
            </div>
          </div>

          {/* Section tabs */}
          <div className="flex flex-wrap gap-2">
            {sectionBtns.map(s => (
              <button key={s.id} onClick={() => setCommunitySection(s.id)}
                className={`px-4 py-2 rounded-xl text-sm font-semibold transition-all ${communitySection === s.id ? 'bg-indigo-600 text-white shadow-md' : 'bg-white text-slate-600 border border-slate-200 hover:border-indigo-300'}`}>
                {s.icon} {s.label}
              </button>
            ))}
          </div>

          {/* PATIENT NETWORK */}
          {communitySection === 'network' && (
            <div className="space-y-4">
              <div className="bg-gradient-to-r from-indigo-50 to-violet-50 rounded-3xl p-6 border border-indigo-100">
                <div className="flex items-center gap-3 mb-1">
                  <span className="text-2xl">{'\u{1F91D}'}</span>
                  <h3 className="font-bold text-lg text-slate-800">CLN3 Family Network</h3>
                </div>
                <p className="text-xs text-slate-500 ml-10 mb-3">Families matched by disease, geography, and treatment stage. All connections require your approval.</p>
                <div className="ml-10 inline-flex items-center gap-2 px-3 py-1.5 bg-pink-50 border border-pink-200 rounded-full">
                  <span className="text-sm">{AGENT_EMOJIS.Connector}</span>
                  <span className="text-[10px] font-bold text-pink-700">Connector</span>
                  <span className="text-[10px] text-pink-500">Matching families & drafting introductions</span>
                </div>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                {COMMUNITY_FAMILIES.map(fam => (
                  <div key={fam.id} className="bg-white rounded-2xl p-5 border border-slate-200 shadow-sm card-hover">
                    <div className="flex items-center gap-3 mb-4">
                      <div className={`w-10 h-10 rounded-full bg-${fam.color}-100 flex items-center justify-center text-${fam.color}-600 font-bold text-sm`}>{fam.avatar}</div>
                      <div>
                        <h4 className="font-bold text-sm text-slate-800">{fam.name}</h4>
                        <p className="text-[10px] text-slate-400">{fam.location}</p>
                      </div>
                    </div>
                    <div className="space-y-2 mb-4">
                      <div className="flex items-center gap-2">
                        <span className="text-[10px] font-bold text-slate-400 w-14">Patient</span>
                        <span className="text-xs text-slate-700">{fam.child}</span>
                      </div>
                      <div className="flex items-center gap-2">
                        <span className="text-[10px] font-bold text-slate-400 w-14">Stage</span>
                        <span className="text-xs text-slate-700">{fam.stage}</span>
                      </div>
                      <div className="flex items-center gap-2">
                        <span className="text-[10px] font-bold text-slate-400 w-14 shrink-0">Tx</span>
                        <div className="flex flex-wrap gap-1">
                          {fam.treatments.map((t, i) => <span key={i} className="text-[10px] bg-slate-100 px-2 py-0.5 rounded-full text-slate-600">{t}</span>)}
                        </div>
                      </div>
                    </div>
                    <div className="mb-3">
                      <p className="text-[10px] font-bold text-emerald-600 mb-1">Willing to share:</p>
                      <div className="flex flex-wrap gap-1">
                        {fam.willing.map((w, i) => <span key={i} className="text-[10px] bg-emerald-50 text-emerald-700 px-2 py-0.5 rounded-full border border-emerald-200">{w}</span>)}
                      </div>
                    </div>
                    <div className="flex items-center gap-1.5 mb-3 text-[9px] text-pink-500">
                      <span className="w-4 h-4 rounded-full bg-pink-500 flex items-center justify-center text-[8px]">{AGENT_EMOJIS.Connector}</span>
                      <span className="font-semibold text-pink-600">Connector</span> found this match via NPI Registry
                    </div>
                    <button className="w-full py-2 bg-indigo-50 text-indigo-600 rounded-xl text-xs font-bold hover:bg-indigo-100 transition-colors border border-indigo-200">
                      Request Introduction
                    </button>
                  </div>
                ))}
              </div>

              <div className="bg-amber-50 rounded-2xl p-4 border border-amber-200 flex items-start gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#d97706" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="shrink-0 mt-0.5"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                <div>
                  <p className="text-xs font-bold text-amber-800 mb-0.5">Privacy-First</p>
                  <p className="text-[11px] text-amber-700">All connections are opt-in. Your Connector agent will draft a warm introduction for your approval before any contact is made. No personal information is shared without explicit consent.</p>
                </div>
              </div>
            </div>
          )}

          {/* DATA COMMONS */}
          {communitySection === 'data' && (
            <div className="space-y-4">
              {/* Aggregate stats */}
              <div className="grid grid-cols-3 gap-4">
                <div className="bg-white rounded-2xl p-5 border border-slate-200 text-center">
                  <p className="text-3xl font-black text-indigo-600">{COMMUNITY_DATA_COMMONS.totalFamilies}</p>
                  <p className="text-xs text-slate-500 mt-1">CLN3 families connected</p>
                </div>
                <div className="bg-white rounded-2xl p-5 border border-slate-200 text-center">
                  <p className="text-3xl font-black text-emerald-600">{COMMUNITY_DATA_COMMONS.trackingSymptoms}</p>
                  <p className="text-xs text-slate-500 mt-1">Families tracking outcomes</p>
                </div>
                <div className="bg-white rounded-2xl p-5 border border-slate-200 text-center">
                  <p className="text-3xl font-black text-violet-600">{COMMUNITY_DATA_COMMONS.treatments.length}</p>
                  <p className="text-xs text-slate-500 mt-1">Treatments being tracked</p>
                </div>
              </div>

              {/* Agent activity banner */}
              <div className="flex flex-wrap gap-2">
                <div className="inline-flex items-center gap-2 px-3 py-1.5 bg-rose-50 border border-rose-200 rounded-full">
                  <span className="text-sm">{AGENT_EMOJIS.Preclinician}</span>
                  <span className="text-[10px] font-bold text-rose-700">Preclinician</span>
                  <span className="text-[10px] text-rose-500">Analyzing community data</span>
                </div>
                <div className="inline-flex items-center gap-2 px-3 py-1.5 bg-orange-50 border border-orange-200 rounded-full">
                  <span className="text-sm">{AGENT_EMOJIS.Chemist}</span>
                  <span className="text-[10px] font-bold text-orange-700">Chemist</span>
                  <span className="text-[10px] text-orange-500">Refining treatment models</span>
                </div>
              </div>

              {/* Treatment tracking table */}
              <div className="bg-white rounded-3xl p-6 border border-slate-200 shadow-sm">
                <h3 className="font-bold text-sm mb-4">Aggregated Treatment Data</h3>
                <div className="space-y-3">
                  {COMMUNITY_DATA_COMMONS.treatments.map((tx, i) => (
                    <div key={i} className="flex items-center justify-between p-3 rounded-xl bg-slate-50 border border-slate-100">
                      <div className="flex items-center gap-3">
                        <div className={`w-2 h-2 rounded-full ${tx.trend === 'promising' ? 'bg-emerald-500' : tx.trend === 'early' ? 'bg-amber-500' : 'bg-slate-400'}`}></div>
                        <div>
                          <p className="text-sm font-semibold text-slate-800">{tx.name}</p>
                          <p className="text-[10px] text-slate-400">{tx.families} families · avg {tx.avgDuration}</p>
                        </div>
                      </div>
                      <div className="flex items-center gap-2">
                        <span className="inline-flex items-center gap-1 text-[9px] text-rose-500"><span className="w-3.5 h-3.5 rounded-full bg-rose-500 flex items-center justify-center text-[7px]">{AGENT_EMOJIS.Preclinician}</span></span>
                        <span className={`text-[10px] font-bold px-2 py-1 rounded-full ${tx.trend === 'promising' ? 'bg-emerald-100 text-emerald-700' : tx.trend === 'early' ? 'bg-amber-100 text-amber-700' : 'bg-slate-100 text-slate-500'}`}>
                          {tx.trend}
                        </span>
                      </div>
                    </div>
                  ))}
                </div>
              </div>

              {/* N-of-1 Tracker */}
              <div className="bg-white rounded-3xl p-6 border border-slate-200 shadow-sm">
                <div className="flex items-center gap-2 mb-1">
                  <span className="text-lg">{'\u{1F9EA}'}</span>
                  <h3 className="font-bold text-sm">N-of-1 Experiment Tracker</h3>
                </div>
                <p className="text-xs text-slate-400 mb-4">{COMMUNITY_NOF1_TRACKER.experiment}</p>
                <p className="text-[10px] text-slate-500 mb-3">Family: {COMMUNITY_NOF1_TRACKER.family} · Started: {COMMUNITY_NOF1_TRACKER.startDate}</p>

                <div className="overflow-x-auto">
                  <table className="w-full text-xs">
                    <thead>
                      <tr className="border-b border-slate-200">
                        <th className="text-left py-2 px-2 text-slate-400 font-semibold">Week</th>
                        <th className="text-center py-2 px-2 text-slate-400 font-semibold">Seizures/wk</th>
                        <th className="text-center py-2 px-2 text-slate-400 font-semibold">Mobility (1-10)</th>
                        <th className="text-center py-2 px-2 text-slate-400 font-semibold">Cognition (1-10)</th>
                        <th className="text-left py-2 px-2 text-slate-400 font-semibold">Notes</th>
                      </tr>
                    </thead>
                    <tbody>
                      {COMMUNITY_NOF1_TRACKER.dataPoints.map((dp, i) => (
                        <tr key={i} className="border-b border-slate-50">
                          <td className="py-2 px-2 font-bold text-slate-700">{dp.week}</td>
                          <td className="py-2 px-2 text-center">
                            <span className={`font-bold ${dp.seizures <= 2 ? 'text-emerald-600' : dp.seizures <= 3 ? 'text-amber-600' : 'text-slate-600'}`}>{dp.seizures}</span>
                          </td>
                          <td className="py-2 px-2 text-center font-semibold text-slate-700">{dp.mobility}</td>
                          <td className="py-2 px-2 text-center font-semibold text-slate-700">{dp.cognition}</td>
                          <td className="py-2 px-2 text-slate-500">{dp.notes}</td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>

                <div className="mt-4 p-3 bg-rose-50 rounded-xl border border-rose-200">
                  <div className="flex items-center gap-2 mb-1.5">
                    <div className="w-6 h-6 rounded-full bg-rose-500 flex items-center justify-center text-xs">{AGENT_EMOJIS.Preclinician}</div>
                    <span className="text-[10px] font-bold text-rose-700">Preclinician</span>
                    <span className="text-[9px] text-rose-400">Analysis Note</span>
                  </div>
                  <p className="text-xs text-rose-800 ml-8">Seizure frequency reduced 75% over 16 weeks. Data shared (anonymized) with <span className="inline-flex items-center gap-1 mx-0.5"><span className="w-3.5 h-3.5 rounded-full bg-orange-500 inline-flex items-center justify-center text-[7px]">{AGENT_EMOJIS.Chemist}</span><span className="font-bold text-orange-700">Chemist</span></span> to refine dosing model.</p>
                </div>
              </div>
            </div>
          )}

          {/* PATH TO CLINICAL TRIAL */}
          {communitySection === 'trial' && (
            <div className="space-y-4">
              {/* Agent activity banner */}
              <div className="flex flex-wrap gap-2">
                {['Navigator', 'Mobilizer', 'Strategist'].map(name => (
                  <div key={name} className={`inline-flex items-center gap-2 px-3 py-1.5 bg-${AGENT_COLORS[name]}-50 border border-${AGENT_COLORS[name]}-200 rounded-full`}>
                    <span className="text-sm">{AGENT_EMOJIS[name]}</span>
                    <span className={`text-[10px] font-bold text-${AGENT_COLORS[name]}-700`}>{name}</span>
                  </div>
                ))}
                <span className="self-center text-[10px] text-slate-400">Mapping regulatory path & funding strategy</span>
              </div>

              <div className="bg-white rounded-3xl p-6 border border-slate-200 shadow-sm">
                <h3 className="font-bold text-lg mb-1">From Community to Clinical Trial</h3>
                <p className="text-xs text-slate-400 mb-6">Your agents are mapping the path from shared patient data to a formal clinical study</p>

                <div className="space-y-0">
                  {CLINICAL_TRIAL_ROADMAP.map((step, i) => (
                    <div key={i} className="flex items-start gap-4 relative">
                      {/* Connector line */}
                      {i < CLINICAL_TRIAL_ROADMAP.length - 1 && (
                        <div className="absolute left-5 top-10 w-0.5 h-12 bg-slate-200" style={{ left: '19px' }}></div>
                      )}
                      <div className={`w-10 h-10 rounded-xl flex items-center justify-center shrink-0 ${
                        step.status === 'active' ? 'bg-indigo-600 text-white' :
                        step.status === 'next' ? 'bg-amber-100 text-amber-600 border-2 border-amber-300' :
                        'bg-slate-100 text-slate-400'
                      }`}>
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                          {step.icon === 'users' && <><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></>}
                          {step.icon === 'database' && <><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M3 5V19A9 3 0 0 0 21 19V5"/><path d="M3 12A9 3 0 0 0 21 12"/></>}
                          {step.icon === 'clipboard' && <><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/></>}
                          {step.icon === 'file-text' && <><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/></>}
                          {step.icon === 'shield' && <path d="M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z"/>}
                          {step.icon === 'activity' && <path d="M22 12h-2.48a2 2 0 0 0-1.93 1.46l-2.35 8.36a.25.25 0 0 1-.48 0L9.24 2.18a.25.25 0 0 0-.48 0l-2.35 8.36A2 2 0 0 1 4.49 12H2"/>}
                        </svg>
                      </div>
                      <div className="pb-8">
                        <div className="flex items-center gap-2">
                          <h4 className={`font-bold text-sm ${step.status === 'active' ? 'text-indigo-700' : step.status === 'next' ? 'text-amber-700' : 'text-slate-400'}`}>{step.step}</h4>
                          {step.status === 'active' && <span className="text-[9px] font-bold px-2 py-0.5 bg-indigo-100 text-indigo-600 rounded-full">ACTIVE</span>}
                          {step.status === 'next' && <span className="text-[9px] font-bold px-2 py-0.5 bg-amber-100 text-amber-600 rounded-full">NEXT</span>}
                        </div>
                        <div className="flex items-center gap-2 mt-0.5">
                          <p className="text-xs text-slate-500">{step.detail}</p>
                          <div className="flex -space-x-1">
                            {step.agents && step.agents.map(a => (
                              <div key={a} className={`w-5 h-5 rounded-full bg-${AGENT_COLORS[a]}-500 flex items-center justify-center text-[8px] border border-white`} title={a}>{AGENT_EMOJIS[a]}</div>
                            ))}
                          </div>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              </div>

              {/* Funding by stage */}
              <div className="bg-white rounded-3xl p-6 border border-slate-200 shadow-sm">
                <h3 className="font-bold text-sm mb-4">Funding Needed by Stage</h3>
                <div className="space-y-3">
                  {[
                    { stage: 'Natural History Study', amount: '$50-100K', sources: 'NORD, CZI Rare As One, BDSRA', agent: 'Mobilizer' },
                    { stage: 'IND Preparation', amount: '$100-250K', sources: 'NIH NCATS, pharma partnerships', agent: 'Mobilizer + Navigator' },
                    { stage: 'Phase 1 Trial', amount: '$500K-2M', sources: 'DoD CDMRP, venture philanthropy, 501(c)(3) fundraising', agent: 'Mobilizer' },
                  ].map((item, i) => (
                    <div key={i} className="p-4 bg-slate-50 rounded-xl border border-slate-100">
                      <div className="flex items-center justify-between mb-1">
                        <h4 className="text-sm font-bold text-slate-800">{item.stage}</h4>
                        <span className="text-sm font-black text-emerald-600">{item.amount}</span>
                      </div>
                      <p className="text-[10px] text-slate-500">Sources: {item.sources}</p>
                      <div className="flex items-center gap-1.5 mt-1.5">
                        {item.agent.split(' + ').map(a => (
                          <div key={a} className={`inline-flex items-center gap-1 px-2 py-0.5 bg-${AGENT_COLORS[a]}-50 rounded-full`}>
                            <span className="text-[9px]">{AGENT_EMOJIS[a]}</span>
                            <span className={`text-[9px] font-bold text-${AGENT_COLORS[a]}-700`}>{a}</span>
                          </div>
                        ))}
                      </div>
                    </div>
                  ))}
                </div>
              </div>

              {/* Organize a study CTA */}
              <div className="bg-gradient-to-r from-indigo-600 to-violet-600 rounded-3xl p-6 text-white">
                <h3 className="font-bold text-lg mb-2">Ready to organize a study?</h3>
                <p className="text-sm text-indigo-100 mb-4">When your community has enough shared data, your agents can draft an IRB protocol outline, identify sites, and map the regulatory path.</p>
                <button className="px-6 py-3 bg-white text-indigo-700 rounded-xl text-sm font-bold hover:bg-indigo-50 transition-colors shadow-lg">
                  Draft IRB Protocol Outline
                </button>
              </div>
            </div>
          )}
        {actionModal && (
            <ActionModal action={actionModal} onClose={() => setActionModal(null)} />
          )}
        </div>
      );
    }

    // ==========================================
    // ACTION MODAL (for insight & decision CTAs)
    // ==========================================

    function ActionModal({ action, onClose }) {
      const [success, setSuccess] = useState(false);

      const showSuccess = (msg) => {
        setSuccess(msg || 'Done!');
        setTimeout(() => onClose(), 1500);
      };

      if (success) {
        return (
          <div className="modal-overlay" onClick={onClose}>
            <div className="modal text-center" onClick={e => e.stopPropagation()}>
              <div className="w-20 h-20 bg-emerald-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="#059669" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
              </div>
              <h3 className="text-xl font-bold text-slate-800">{success}</h3>
            </div>
          </div>
        );
      }

      if (action.type === 'pre-screening') return <PreScreeningModal action={action} onClose={onClose} onSuccess={showSuccess} />;
      if (action.type === 'briefing') return <BriefingModal action={action} onClose={onClose} onSuccess={showSuccess} />;
      if (action.type === 'outreach') return <OutreachModal action={action} onClose={onClose} onSuccess={showSuccess} />;
      return null;
    }

    function PreScreeningModal({ action, onClose, onSuccess }) {
      const [checks, setChecks] = useState({});
      const toggle = (k) => setChecks(prev => ({ ...prev, [k]: !prev[k] }));

      const criteria = [
        { key: 'age', label: 'Patient age 3-18 years' },
        { key: 'diagnosis', label: 'Confirmed CLN3 genetic diagnosis' },
        { key: 'ambulatory', label: 'Ambulatory or semi-ambulatory' },
        { key: 'vision', label: 'Documented vision assessment within 6 months' },
        { key: 'noother', label: 'Not enrolled in another interventional trial' },
        { key: 'travel', label: 'Able to travel to Weill Cornell (New York, NY)' },
      ];

      const docs = [
        'Genetic testing report (CLN3 mutation confirmation)',
        'Recent medical records & neuropsych evaluation',
        'Insurance information & pre-authorization',
        'List of current medications',
      ];

      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="modal" onClick={e => e.stopPropagation()}>
            <div className="flex justify-between items-center mb-6">
              <div>
                <span className="bg-indigo-100 text-indigo-700 text-[10px] font-black px-2 py-0.5 rounded uppercase">Pre-Screening</span>
                <h2 className="text-xl font-bold mt-2">Phase I/II AAV9-CLN3 Gene Therapy</h2>
                <p className="text-xs text-slate-400 mt-1">NCT-2024-CLN3-001 · Weill Cornell Medical Center</p>
              </div>
              <button onClick={onClose} className="text-slate-400 hover:text-slate-800 text-2xl leading-none">&times;</button>
            </div>

            <div className="mb-6">
              <h3 className="font-bold text-sm text-slate-700 mb-3">Eligibility Checklist</h3>
              <div className="space-y-2">
                {criteria.map(c => (
                  <label key={c.key} className="flex items-center gap-3 p-2.5 rounded-lg hover:bg-slate-50 cursor-pointer">
                    <input type="checkbox" checked={!!checks[c.key]} onChange={() => toggle(c.key)}
                      className="w-4 h-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500" />
                    <span className="text-sm text-slate-700">{c.label}</span>
                  </label>
                ))}
              </div>
            </div>

            <div className="mb-6 bg-slate-50 rounded-xl p-4">
              <h3 className="font-bold text-sm text-slate-700 mb-3">What to Prepare</h3>
              <ul className="space-y-2">
                {docs.map((d, i) => (
                  <li key={i} className="flex items-start gap-2 text-sm text-slate-600">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#6366f1" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="mt-0.5 shrink-0"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8Z"/><polyline points="14 2 14 8 20 8"/></svg>
                    {d}
                  </li>
                ))}
              </ul>
            </div>

            <div className="flex gap-3">
              <button onClick={() => onSuccess('Pre-screening request sent!')} className="px-6 py-3 bg-emerald-500 text-white rounded-xl font-bold hover:bg-emerald-600 transition-colors shadow-md">Request Pre-Screening Call</button>
              <button onClick={onClose} className="px-6 py-3 bg-slate-200 text-slate-700 rounded-xl font-bold text-sm hover:bg-slate-300 transition-colors">Cancel</button>
            </div>
          </div>
        </div>
      );
    }

    function BriefingModal({ action, onClose, onSuccess }) {
      const briefingText = `SPECIALIST BRIEFING: Drug Repurposing Candidate
══════════════════════════════════════════════

Patient: CLN3 Batten Disease (Juvenile Neuronal Ceroid Lipofuscinosis)

CANDIDATE: Tamoxifen (FDA-approved, existing pediatric safety data)

MECHANISM OF ACTION:
Tamoxifen activates TRPML1 (mucolipin-1), a lysosomal cation channel. In CLN3 disease, loss of CLN3 protein disrupts lysosomal calcium homeostasis. TRPML1 activation by tamoxifen bypasses this defect, restoring lysosomal calcium signaling and reducing ceroid lipofuscin accumulation.

KEY EVIDENCE:
• Bhattacharyya et al. (2024) - Demonstrated tamoxifen-mediated TRPML1 activation clears stored material in CLN3-deficient neuronal cultures
• Bhattacharyya et al. (2023) - Murine CLN3 model showed 40% reduction in storage material after 8-week treatment course
• Established pediatric safety profile from oncology use (10+ years of data)

PROPOSED APPROACH:
Off-label use under treating physician supervision. Starting dose: 10mg daily, with monitoring of lysosomal biomarkers (SCMAS, subunit c levels) at baseline and 3-month intervals.

REGULATORY NOTE:
Off-label use is legal and common. No IND required. Insurance coverage possible with physician letter of medical necessity.

RECOMMENDED NEXT STEPS:
1. Review evidence with patient's neurologist
2. Baseline biomarker panel
3. Discuss risk/benefit with family
4. If proceeding, start low-dose trial with 3-month reassessment

Generated by Beacon AI · Scout + Navigator agents`;

      const handleCopy = () => {
        navigator.clipboard.writeText(briefingText);
        onSuccess('Copied to clipboard!');
      };

      const handleDownload = () => {
        const blob = new Blob([briefingText], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'CLN3-Tamoxifen-Specialist-Briefing.txt';
        a.click();
        URL.revokeObjectURL(url);
        onSuccess('Briefing downloaded!');
      };

      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="modal" onClick={e => e.stopPropagation()}>
            <div className="flex justify-between items-center mb-6">
              <div>
                <span className="bg-indigo-100 text-indigo-700 text-[10px] font-black px-2 py-0.5 rounded uppercase">Specialist Briefing</span>
                <h2 className="text-xl font-bold mt-2">Drug Repurposing: Tamoxifen for CLN3</h2>
                <p className="text-xs text-slate-400 mt-1">For your child's neurologist or treating physician</p>
              </div>
              <button onClick={onClose} className="text-slate-400 hover:text-slate-800 text-2xl leading-none">&times;</button>
            </div>

            <div className="bg-slate-50 border border-slate-200 rounded-xl p-5 mb-6 max-h-[45vh] overflow-y-auto">
              <pre className="text-xs text-slate-700 whitespace-pre-wrap font-mono leading-relaxed">{briefingText}</pre>
            </div>

            <div className="flex gap-3 flex-wrap">
              <button onClick={handleCopy} className="px-5 py-3 bg-indigo-600 text-white rounded-xl font-bold text-sm hover:bg-indigo-700 transition-colors shadow-md flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>
                Copy to Clipboard
              </button>
              <button onClick={handleDownload} className="px-5 py-3 bg-emerald-500 text-white rounded-xl font-bold text-sm hover:bg-emerald-600 transition-colors shadow-md flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
                Download
              </button>
              <button onClick={onClose} className="px-5 py-3 bg-slate-200 text-slate-700 rounded-xl font-bold text-sm hover:bg-slate-300 transition-colors">Cancel</button>
            </div>
          </div>
        </div>
      );
    }

    function OutreachModal({ action, onClose, onSuccess }) {
      const [edited, setEdited] = useState({ ...action });

      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="modal" onClick={e => e.stopPropagation()}>
            <div className="flex justify-between items-center mb-6">
              <div>
                <span className="bg-amber-100 text-amber-700 text-[10px] font-black px-2 py-0.5 rounded uppercase">Outreach Approval</span>
                <h2 className="text-xl font-bold mt-2">Contact EveryCure</h2>
                <p className="text-xs text-slate-400 mt-1">Mobilizer agent · Drug repurposing consultation</p>
              </div>
              <button onClick={onClose} className="text-slate-400 hover:text-slate-800 text-2xl leading-none">&times;</button>
            </div>

            <div className="mb-4">
              <label className="block font-semibold text-sm text-slate-700 mb-1">To:</label>
              <input type="text" value={edited.to || ''} onChange={e => setEdited({ ...edited, to: e.target.value })}
                className="w-full px-3 py-2 border-2 border-slate-200 rounded-lg focus:outline-none focus:border-indigo-500" />
            </div>

            <div className="mb-4">
              <label className="block font-semibold text-sm text-slate-700 mb-1">Subject:</label>
              <input type="text" value={edited.subject || ''} onChange={e => setEdited({ ...edited, subject: e.target.value })}
                className="w-full px-3 py-2 border-2 border-slate-200 rounded-lg focus:outline-none focus:border-indigo-500" />
            </div>

            <div className="mb-4">
              <label className="block font-semibold text-sm text-slate-700 mb-1">Message:</label>
              <textarea value={edited.body || ''} onChange={e => setEdited({ ...edited, body: e.target.value })}
                className="w-full px-3 py-3 border-2 border-slate-200 rounded-lg focus:outline-none focus:border-indigo-500 min-h-[180px] font-sans" />
            </div>

            {edited.note && (
              <div className="bg-amber-50 border-l-4 border-amber-500 p-4 rounded-lg mb-4">
                <div className="font-semibold text-sm text-amber-800 mb-1">Mobilizer's Note:</div>
                <div className="text-sm text-amber-700">{edited.note}</div>
              </div>
            )}

            <div className="flex gap-3">
              <button onClick={() => onSuccess('Outreach approved and queued!')} className="px-6 py-3 bg-emerald-500 text-white rounded-xl font-bold hover:bg-emerald-600 transition-colors shadow-md">Approve & Send</button>
              <button onClick={onClose} className="px-6 py-3 bg-slate-200 text-slate-700 rounded-xl font-bold text-sm hover:bg-slate-300 transition-colors">Cancel</button>
            </div>
          </div>
        </div>
      );
    }

    // APPROVAL MODAL (reused)
    // ==========================================

    function ApprovalModal({ approval, onClose }) {
      const [edited, setEdited] = useState({ ...approval });

      const handleApprove = () => {
        console.log('Approved:', edited);
        alert('Email approved and queued for sending!');
        onClose();
      };

      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="modal" onClick={e => e.stopPropagation()}>
            <div className="flex justify-between items-center mb-6">
              <h2 className="text-2xl font-bold">Review & Approve</h2>
              <button onClick={onClose} className="text-slate-400 hover:text-slate-800 text-2xl leading-none">&times;</button>
            </div>

            <div className="mb-4">
              <label className="block font-semibold text-sm text-slate-700 mb-1">To:</label>
              <input type="text" value={edited.to || ''} onChange={e => setEdited({ ...edited, to: e.target.value })}
                className="w-full px-3 py-2 border-2 border-slate-200 rounded-lg focus:outline-none focus:border-indigo-500" />
            </div>

            <div className="mb-4">
              <label className="block font-semibold text-sm text-slate-700 mb-1">Subject:</label>
              <input type="text" value={edited.subject || ''} onChange={e => setEdited({ ...edited, subject: e.target.value })}
                className="w-full px-3 py-2 border-2 border-slate-200 rounded-lg focus:outline-none focus:border-indigo-500" />
            </div>

            <div className="mb-4">
              <label className="block font-semibold text-sm text-slate-700 mb-1">Message:</label>
              <textarea value={edited.body || ''} onChange={e => setEdited({ ...edited, body: e.target.value })}
                className="w-full px-3 py-3 border-2 border-slate-200 rounded-lg focus:outline-none focus:border-indigo-500 min-h-[200px] font-sans" />
            </div>

            {approval.note && (
              <div className="bg-amber-50 border-l-4 border-amber-500 p-4 rounded-lg mb-4">
                <div className="font-semibold text-sm text-amber-800 mb-1">Connector's Note:</div>
                <div className="text-sm text-amber-700">{approval.note}</div>
              </div>
            )}

            <div className="flex gap-3 mt-6">
              <button onClick={handleApprove} className="px-6 py-3 bg-emerald-500 text-white rounded-xl font-bold hover:bg-emerald-600 transition-colors shadow-md">Approve & Send</button>
              <button onClick={() => alert('Edits saved!')} className="px-6 py-3 bg-indigo-600 text-white rounded-xl font-bold text-sm hover:bg-indigo-700 transition-colors">Save Edits</button>
              <button onClick={onClose} className="px-6 py-3 bg-slate-200 text-slate-700 rounded-xl font-bold text-sm hover:bg-slate-300 transition-colors">Cancel</button>
            </div>
          </div>
        </div>
      );
    }

    // Render
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
